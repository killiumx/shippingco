<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARIBCARGO PATCH â€” paste this entire block just before </body>
     Adds: Customer clear-all notifications, admin delete everything,
     better Send Updates client picker, reorganised sidebar.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â”€â”€ Patch styles â”€â”€ */
.notif-item {
  display:flex;gap:0.75rem;align-items:flex-start;
  padding:0.875rem 1rem;border-bottom:1px solid var(--border);
  transition:background 0.15s;cursor:pointer;
}
.notif-item:hover { background:rgba(255,255,255,0.02); }
.notif-item:last-child { border-bottom:none; }
.notif-item.unread { background:rgba(245,158,11,0.03); }
.notif-dot { width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px; }
.notif-actions { display:flex;gap:0.3rem;flex-shrink:0;opacity:0;transition:opacity 0.15s; }
.notif-item:hover .notif-actions { opacity:1; }
.notif-del-btn {
  width:24px;height:24px;border:none;background:rgba(239,68,68,0.08);
  border-radius:6px;color:var(--red);font-size:0.75rem;display:flex;
  align-items:center;justify-content:center;cursor:pointer;transition:background 0.15s;
}
.notif-del-btn:hover { background:rgba(239,68,68,0.2); }
.notif-read-btn {
  width:24px;height:24px;border:none;background:rgba(245,158,11,0.08);
  border-radius:6px;color:var(--amber);font-size:0.75rem;display:flex;
  align-items:center;justify-content:center;cursor:pointer;transition:background 0.15s;
}
.notif-read-btn:hover { background:rgba(245,158,11,0.2); }

/* â”€â”€ Admin inbox item â”€â”€ */
.inbox-item {
  padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);
  display:flex;gap:0.875rem;align-items:flex-start;transition:background 0.15s;
}
.inbox-item:hover { background:rgba(255,255,255,0.015); }
.inbox-item.unread { background:rgba(245,158,11,0.03); }
.inbox-item-del {
  width:28px;height:28px;border:none;background:rgba(239,68,68,0.06);
  border:1px solid rgba(239,68,68,0.15);border-radius:7px;color:var(--red);
  font-size:0.8rem;display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;transition:all 0.15s;
}
.inbox-item-del:hover { background:rgba(239,68,68,0.18); }

/* â”€â”€ Reorganised admin sidebar â”€â”€ */
.sidebar-group-label {
  font-size:0.58rem;font-weight:800;text-transform:uppercase;letter-spacing:0.12em;
  color:var(--text-3);padding:0.3rem 0.75rem;margin:0.875rem 0 0.25rem;
  display:flex;align-items:center;gap:0.5rem;
}
.sidebar-group-label::after {
  content:'';flex:1;height:1px;background:var(--border);
}

/* â”€â”€ Send-updates customer-first picker â”€â”€ */
.upd-flow-step {
  background:rgba(255,255,255,0.02);border:1px solid var(--border);
  border-radius:12px;padding:1rem;margin-bottom:0.875rem;
  transition:border-color 0.2s;
}
.upd-flow-step.active { border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.02); }
.upd-step-num {
  display:inline-flex;align-items:center;justify-content:center;
  width:22px;height:22px;border-radius:50%;background:var(--amber);
  color:#000;font-size:0.65rem;font-weight:800;margin-right:0.5rem;flex-shrink:0;
}

/* â”€â”€ Admin "Manage Notifications" panel â”€â”€ */
.manage-notif-row {
  display:flex;align-items:center;gap:0.75rem;padding:0.6rem 0.875rem;
  border-bottom:1px solid var(--border);font-size:0.84rem;
}
.manage-notif-row:last-child { border-bottom:none; }

/* Better sidebar active indicator */
.sidebar-item.active::before {
  content:'';width:3px;height:100%;background:var(--amber);
  border-radius:2px;position:absolute;left:0;top:0;
}
.sidebar-item { position:relative; }
</style>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 1 â€” CUSTOMER NOTIFICATIONS (clear all, delete, mark read)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function patchDeleteNotification(notifId, rowEl) {
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('notifications').delete().eq('id', notifId);
    if(error) return toast('Delete failed: '+error.message, 'error');
  }
  // Remove from local array too
  notifications = notifications.filter(n => n.id !== notifId);
  rowEl?.closest('.notif-item')?.remove();
  updateNotifBadge();
  toast('Notification removed.', 'info');
}

async function patchMarkNotifRead(notifId, rowEl) {
  if(!DEMO_MODE && sb) {
    await sb.from('notifications').update({ read: true }).eq('id', notifId);
  }
  const n = notifications.find(x => x.id === notifId);
  if(n) n.read = true;
  rowEl?.closest('.notif-item')?.classList.remove('unread');
  rowEl?.closest('.notif-item')?.querySelector('.notif-dot')
       ?.setAttribute('style','background:var(--text-3);');
  rowEl?.closest('.notif-item')?.querySelector('.notif-read-btn')?.remove();
  updateNotifBadge();
}

async function patchMarkAllRead() {
  if(!DEMO_MODE && sb && currentUser) {
    await sb.from('notifications')
      .update({ read: true })
      .eq('customer_id', currentUser.id)
      .eq('read', false);
  }
  notifications.forEach(n => n.read = true);
  renderNotifications();
  updateNotifBadge();
  toast('All notifications marked as read.', 'success');
}

async function patchClearAllNotifications() {
  if(!confirm('Delete all notifications? This cannot be undone.')) return;
  if(!DEMO_MODE && sb && currentUser) {
    const { error } = await sb.from('notifications')
      .delete()
      .eq('customer_id', currentUser.id);
    if(error) return toast('Error: '+error.message, 'error');
  }
  notifications = [];
  renderNotifications();
  updateNotifBadge();
  toast('All notifications cleared.', 'success');
}

function updateNotifBadge() {
  const unread = notifications.filter(n=>!n.read).length;
  const badge = el('notifBadge');
  if(badge) { badge.textContent = unread; badge.style.display = unread>0 ? 'inline' : 'none'; }
}

// Override renderNotifications with improved version
window.renderNotifications = function() {
  const c = el('notificationsList'); if(!c) return;

  // Header with actions
  const unread = notifications.filter(n=>!n.read).length;
  const header = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.75rem;">
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span style="font-size:0.75rem;color:var(--text-3);">${notifications.length} notification${notifications.length!==1?'s':''}</span>
        ${unread>0 ? `<span class="badge badge-amber">${unread} unread</span>` : '<span class="badge badge-green"><i class="ti ti-check"></i> All read</span>'}
      </div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        ${unread>0 ? `<button class="btn btn-ghost btn-sm" onclick="patchMarkAllRead()"><i class="ti ti-checks"></i> Mark All Read</button>` : ''}
        ${notifications.length>0 ? `<button class="btn btn-danger btn-sm" onclick="patchClearAllNotifications()"><i class="ti ti-trash"></i> Clear All</button>` : ''}
      </div>
    </div>`;

  if(!notifications.length) {
    c.innerHTML = header + `
      <div class="empty-state">
        <div class="empty-icon"><i class="ti ti-bell-off"></i></div>
        <div class="empty-title">No notifications</div>
        <div class="empty-sub">You're all caught up! Updates about your shipments will appear here.</div>
      </div>`;
    return;
  }

  c.innerHTML = header + `
    <div class="card" style="overflow:hidden;">
      ${notifications.map(n => `
        <div class="notif-item ${!n.read?'unread':''}" onclick="patchMarkNotifRead('${n.id}',this)">
          <div class="notif-dot" style="background:${n.read?'var(--text-3)':'var(--amber)'}"></div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:0.875rem;font-weight:${n.read?'400':'600'};margin-bottom:0.15rem;">${n.title}</div>
            <div style="font-size:0.8rem;color:var(--text-2);line-height:1.5;">${n.message}</div>
            <div style="font-size:0.7rem;color:var(--text-3);margin-top:0.25rem;">${fmtDateTime(n.created_at)}</div>
          </div>
          <div class="notif-actions">
            ${!n.read ? `<button class="notif-read-btn" onclick="event.stopPropagation();patchMarkNotifRead('${n.id}',this)" title="Mark read"><i class="ti ti-eye-check"></i></button>` : ''}
            <button class="notif-del-btn" onclick="event.stopPropagation();patchDeleteNotification('${n.id}',this)" title="Delete"><i class="ti ti-trash"></i></button>
          </div>
        </div>`).join('')}
    </div>`;
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 2 â€” ADMIN INBOX (delete messages, clear all, manage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function patchDeleteInboxMsg(notifId, rowEl) {
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('notifications').delete().eq('id', notifId);
    if(error) return toast('Delete failed: '+error.message,'error');
  }
  rowEl?.closest('.inbox-item')?.remove();
  toast('Message deleted.','info');
  // Update unread badge
  const remaining = el('admin-inbox')?.querySelectorAll('.inbox-item.unread')?.length || 0;
  const badge = el('inboxUnreadBadge');
  if(badge) { badge.textContent = remaining+' new'; badge.style.display = remaining>0?'inline-flex':'none'; }
}

async function patchClearAdminInbox() {
  if(!confirm('Delete all customer messages? This cannot be undone.')) return;
  if(!DEMO_MODE && sb) {
    await sb.from('notifications').delete().like('title','[Customer Reply]%');
  }
  const inboxEl = el('admin-inbox');
  if(inboxEl) inboxEl.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">Inbox cleared.</div>';
  const badge = el('inboxUnreadBadge');
  if(badge) badge.style.display = 'none';
  toast('Inbox cleared.','success');
}

async function patchDeleteAllNotifForCustomer(custId, custName) {
  if(!confirm(`Delete ALL notifications for ${custName}?`)) return;
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('notifications').delete().eq('customer_id', custId);
    if(error) return toast('Error: '+error.message,'error');
  }
  toast(`Notifications cleared for ${custName}.`,'success');
}

// Override loadAdminInbox with improved version
window.loadAdminInbox = async function() {
  const c = el('admin-inbox'); if(!c) return;
  c.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-3);">Loadingâ€¦</div>';

  if(DEMO_MODE) {
    c.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-3);font-size:0.84rem;">Demo mode â€” no real customer replies.</div>';
    return;
  }
  if(!sb) return;

  try {
    const { data, error } = await sb.from('notifications')
      .select('*, profiles(full_name, cargolink_id, email, id)')
      .like('title','[Customer Reply]%')
      .order('created_at',{ascending:false})
      .limit(100);
    if(error) throw error;

    const unread = (data||[]).filter(n=>!n.read).length;
    const badge = el('inboxUnreadBadge');
    if(badge) { badge.textContent = unread+' new'; badge.style.display = unread>0?'inline-flex':'none'; }

    if(!data?.length) {
      c.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">No customer messages yet.</div>';
      return;
    }

    // Header
    const headerHtml = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.015);">
        <span style="font-size:0.78rem;color:var(--text-2);">${data.length} message${data.length!==1?'s':''} ${unread>0?'Â· <span style="color:var(--amber);">'+unread+' unread</span>':''}</span>
        <div style="display:flex;gap:0.5rem;">
          <button class="btn btn-ghost btn-sm" onclick="patchClearAdminInbox()"><i class="ti ti-trash"></i> Clear All</button>
        </div>
      </div>`;

    c.innerHTML = headerHtml + data.map(n=>`
      <div class="inbox-item ${!n.read?'unread':''}">
        <div class="update-log-dot" style="background:${n.read?'var(--text-3)':'var(--amber)'};flex-shrink:0;margin-top:4px;"></div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.2rem;">
            <span style="font-weight:700;font-size:0.875rem;">${n.profiles?.full_name||'Customer'}</span>
            <span style="font-size:0.7rem;color:var(--amber);font-family:monospace;">${n.profiles?.cargolink_id||''}</span>
            ${!n.read?'<span class="badge badge-amber" style="font-size:0.6rem;">New</span>':''}
          </div>
          <div style="font-size:0.85rem;font-weight:600;color:var(--text);">${n.title.replace('[Customer Reply] ','')}</div>
          <div style="font-size:0.8rem;color:var(--text-2);margin-top:0.15rem;line-height:1.5;">${n.message}</div>
          <div style="font-size:0.68rem;color:var(--text-3);margin-top:0.2rem;">${fmtDateTime(n.created_at)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.3rem;flex-shrink:0;">
          ${n.profiles?.email ? `<button class="btn btn-blue btn-sm" onclick="emailCustomerDirect('${n.profiles.email||''}','${(n.profiles.full_name||'').replace(/'/g,'&apos;')}')"><i class="ti ti-mail"></i> Reply</button>` : ''}
          ${!n.read ? `<button class="btn btn-ghost btn-sm" onclick="markInboxRead('${n.id}', this)"><i class="ti ti-check"></i> Read</button>` : ''}
          <button class="inbox-item-del" onclick="patchDeleteInboxMsg('${n.id}', this)" title="Delete"><i class="ti ti-trash"></i></button>
        </div>
      </div>`).join('');
  } catch(e) {
    c.innerHTML = `<div style="padding:1.5rem;color:var(--red);font-size:0.84rem;">Error: ${e.message}</div>`;
  }
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 3 â€” SEND UPDATES: customer-first picker flow
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUpdCustomerFlow() {
  // Rebuild the Send Update card with a customer-first approach
  const card = document.querySelector('#atab-updates .card');
  if(!card || card.dataset.patched) return;
  card.dataset.patched = '1';
  card.querySelector('.card-body').innerHTML = `

    <!-- Step 1: Pick Customer -->
    <div class="upd-flow-step active" id="upd-step1">
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--amber);margin-bottom:0.65rem;display:flex;align-items:center;gap:0.4rem;">
        <span class="upd-step-num">1</span> Select Customer
      </div>
      <div class="cpicker-wrap" id="upd-cpicker-wrap">
        <div class="cpicker-input" id="upd-cpicker-btn" onclick="toggleCpicker('upd')">
          <span class="cpicker-placeholder" id="upd-cpicker-placeholder">Search name or CargoLink IDâ€¦</span>
          <div class="cpicker-selected" id="upd-cpicker-selected" style="display:none;"></div>
          <i class="ti ti-chevron-down cpicker-arrow"></i>
        </div>
        <div class="cpicker-dropdown" id="upd-cpicker-dropdown" style="display:none;">
          <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i>
            <input type="text" id="upd-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('upd')">
          </div>
          <div class="cpicker-list" id="upd-cpicker-list"></div>
        </div>
      </div>
      <input type="hidden" id="upd-customer-id" value="">
    </div>

    <!-- Step 2: Pick Shipment (auto-populated from customer) -->
    <div class="upd-flow-step" id="upd-step2" style="opacity:0.45;pointer-events:none;">
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);margin-bottom:0.65rem;display:flex;align-items:center;gap:0.4rem;">
        <span class="upd-step-num" style="background:var(--text-3);">2</span> Select Shipment
      </div>
      <div id="upd-shipment-list" style="display:flex;flex-direction:column;gap:0.4rem;max-height:220px;overflow-y:auto;"></div>
      <input type="hidden" id="upd-selected-shipid" value="">
      <input type="hidden" id="upd-tracking" value="">
    </div>

    <!-- Step 3: New Status + note -->
    <div class="upd-flow-step" id="upd-step3" style="opacity:0.45;pointer-events:none;">
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);margin-bottom:0.65rem;display:flex;align-items:center;gap:0.4rem;">
        <span class="upd-step-num" style="background:var(--text-3);">3</span> Update Status
      </div>
      <div class="form-group" style="margin-bottom:0.75rem;">
        <label class="form-label">New Status</label>
        <select class="form-select" id="upd-status">
          <option value="">Select statusâ€¦</option>
          <option value="received">ğŸ“¦ Received at Warehouse</option>
          <option value="in_transit">âœˆ In Transit</option>
          <option value="customs">ğŸ›‚ Customs Clearance</option>
          <option value="ready">ğŸ“« Ready for Pickup</option>
          <option value="delivered">âœ… Delivered</option>
          <option value="cancelled">âŒ Cancelled</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom:0.875rem;">
        <label class="form-label">Note to Customer (optional)</label>
        <textarea class="form-input" id="upd-note" rows="2" placeholder="Additional detailsâ€¦" style="resize:vertical;"></textarea>
      </div>
      <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--text-2);">
          <input type="checkbox" id="upd-sendemail" checked style="accent-color:var(--amber);width:16px;height:16px;">
          Email customer
        </label>
      </div>
      <button class="btn btn-amber" style="width:100%;" onclick="sendShipmentUpdate()">
        <i class="ti ti-send"></i> Update &amp; Notify
      </button>
    </div>`;

  // Wire up the customer selection callback
  const origSelectCpicker = window.selectCpicker;
  window.selectCpicker = function(ns, id) {
    origSelectCpicker(ns, id);
    if(ns === 'upd') updOnCustomerPicked(id);
  };
}

function updOnCustomerPicked(custId) {
  const step2 = el('upd-step2');
  const step3 = el('upd-step3');
  if(!step2) return;

  // Activate step 2
  el('upd-step1')?.classList.remove('active');
  step2.style.opacity = '1'; step2.style.pointerEvents = 'auto'; step2.classList.add('active');
  step2.querySelector('.upd-step-num').style.background = 'var(--amber)';
  step2.querySelector('div').style.color = 'var(--amber)';
  step3.style.opacity = '0.45'; step3.style.pointerEvents = 'none';

  // Clear previous selection
  el('upd-selected-shipid').value = '';
  el('upd-tracking').value = '';

  // Load this customer's shipments
  const allShips = DEMO_MODE ? getDemoShipments(20) : (window._adminShipments||[]);
  const custShips = allShips.filter(s => s.customer_id === custId || s.profiles?.id === custId);

  const listEl = el('upd-shipment-list');
  if(!listEl) return;

  if(!custShips.length) {
    listEl.innerHTML = '<div style="font-size:0.82rem;color:var(--text-3);padding:0.5rem;">No shipments found for this customer.</div>';
    return;
  }

  const statusColors = {pending:'var(--text-3)',received:'var(--blue)',in_transit:'var(--cyan)',customs:'var(--amber)',ready:'var(--purple)',delivered:'var(--green)',cancelled:'var(--red)'};

  listEl.innerHTML = custShips.map(s => `
    <div onclick="updSelectShipment('${s.id}','${s.tracking_number}',this)"
         style="display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0.875rem;
                background:rgba(255,255,255,0.025);border:1.5px solid var(--border);
                border-radius:10px;cursor:pointer;transition:all 0.15s;"
         onmouseover="this.style.borderColor='rgba(245,158,11,0.3)';this.style.background='rgba(245,158,11,0.04)'"
         onmouseout="if(!this.classList.contains('selected')){this.style.borderColor='var(--border)';this.style.background='rgba(255,255,255,0.025)';}">
      <div style="width:8px;height:8px;border-radius:50%;background:${statusColors[s.status]||'var(--text-3)'};flex-shrink:0;"></div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--amber);font-size:0.85rem;">${s.tracking_number}</div>
        <div style="font-size:0.75rem;color:var(--text-2);margin-top:0.1rem;">${s.description||'Package'} Â· <span style="color:${statusColors[s.status]||'var(--text-3)'};">${statusLabel(s.status)}</span></div>
      </div>
      <div style="font-size:0.72rem;color:var(--text-3);">${s.weight||'â€”'} kg</div>
    </div>`).join('');
}

function updSelectShipment(shipId, tracking, rowEl) {
  // Deselect all
  rowEl.closest('#upd-shipment-list')?.querySelectorAll('[onclick]').forEach(r => {
    r.classList.remove('selected');
    r.style.borderColor = 'var(--border)';
    r.style.background = 'rgba(255,255,255,0.025)';
  });
  // Select this one
  rowEl.classList.add('selected');
  rowEl.style.borderColor = 'rgba(245,158,11,0.5)';
  rowEl.style.background = 'rgba(245,158,11,0.06)';

  el('upd-selected-shipid').value = shipId;
  el('upd-tracking').value = tracking;

  // Activate step 3
  const step3 = el('upd-step3');
  if(step3) {
    step3.style.opacity = '1'; step3.style.pointerEvents = 'auto'; step3.classList.add('active');
    step3.querySelector('.upd-step-num').style.background = 'var(--amber)';
    step3.querySelector('div').style.color = 'var(--amber)';
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 4 â€” ADMIN SIDEBAR REORGANISATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function patchAdminSidebar() {
  const sidebar = el('adminSidebar');
  if(!sidebar || sidebar.dataset.patched) return;
  sidebar.dataset.patched = '1';

  // Rebuild sidebar HTML (keep IDs for existing tab switching)
  sidebar.innerHTML = `
    <div style="padding:0.5rem;margin-bottom:0.75rem;">
      <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.18);border-radius:8px;padding:0.4rem 0.75rem;font-size:0.68rem;font-weight:700;color:var(--red);text-align:center;letter-spacing:0.1em;"><i class="ti ti-shield-lock"></i> ADMIN CONSOLE</div>
    </div>

    <div class="sidebar-group-label">Overview</div>
    <div class="sidebar-item active" onclick="adminTab('overview')" id="aitem-overview"><i class="ti ti-dashboard"></i> Dashboard</div>

    <div class="sidebar-group-label">Manage</div>
    <div class="sidebar-item" onclick="adminTab('customers')" id="aitem-customers"><i class="ti ti-users"></i> Customers</div>
    <div class="sidebar-item" onclick="adminTab('shipments')" id="aitem-shipments"><i class="ti ti-package"></i> Shipments</div>
    <div class="sidebar-item" onclick="adminTab('pending')" id="aitem-pending"><i class="ti ti-clock-hour-4"></i> Pending <span class="notif-badge" id="adminPendingBadge" style="display:none;">0</span></div>
    <div class="sidebar-item" onclick="adminTab('invoices')" id="aitem-invoices"><i class="ti ti-receipt"></i> Invoices</div>

    <div class="sidebar-group-label">Communicate</div>
    <div class="sidebar-item" onclick="adminTab('updates')" id="aitem-updates"><i class="ti ti-send"></i> Send Update</div>
    <div class="sidebar-item" onclick="adminTab('messages')" id="aitem-messages"><i class="ti ti-message-dots"></i> Message Customer</div>

    <div class="sidebar-group-label">Data & Settings</div>
    <div class="sidebar-item" onclick="adminTab('settings')" id="aitem-settings"><i class="ti ti-settings"></i> Settings</div>
    <div class="sidebar-item" onclick="adminTab('reports')" id="aitem-reports"><i class="ti ti-chart-line"></i> Reports &amp; Exports</div>
    <div class="sidebar-item" onclick="adminTab('staff')" id="aitem-staff" style="position:relative;"><i class="ti ti-shield-half"></i> Staff &amp; Roles <span id="ownerCrownBadge" style="display:none;margin-left:auto;font-size:0.62rem;background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;padding:1px 6px;border-radius:8px;font-weight:800;">ğŸ‘‘</span></div>
    <div class="sidebar-item" onclick="adminTab('data')" id="aitem-data" style="color:var(--red);"><i class="ti ti-database-x"></i> Data Management</div>

    <div class="sidebar-group-label">Quick Add</div>
    <div class="sidebar-item" onclick="openCreateShipment()"><i class="ti ti-plus"></i> New Shipment</div>
    <div class="sidebar-item" onclick="openCreateInvoice()"><i class="ti ti-file-plus"></i> New Invoice</div>

    <div class="sidebar-spacer"></div>
    <div class="sidebar-item" onclick="signOut()" style="color:var(--red);"><i class="ti ti-logout"></i> Sign Out</div>`;
}

// â”€â”€ Merge Reports+Exports tab into one when Reports tab is clicked â”€â”€
const _origAdminTab = window.adminTab;
window.adminTab = function(name) {
  // Redirect 'exports' to 'reports' (they're merged conceptually)
  // but keep 'reports' tab active for both
  _origAdminTab(name);

  // After tab switches, run init hooks
  if(name === 'updates') {
    setTimeout(initUpdCustomerFlow, 50);
    setTimeout(() => populateCpicker('upd'), 80);
  }
  if(name === 'messages') {
    setTimeout(() => {
      renderMsgLog();
      populateCpicker('msg');
      loadAdminInbox();
    }, 50);
  }
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 5 â€” ADMIN MANAGE NOTIFICATIONS PANEL (in messages tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function patchAddManageNotifPanel() {
  const msgTab = el('atab-messages');
  if(!msgTab || msgTab.dataset.notifPanel) return;
  msgTab.dataset.notifPanel = '1';

  const panel = document.createElement('div');
  panel.style.cssText = 'margin-top:1.5rem;max-width:1000px;';
  panel.innerHTML = `
    <div class="card" style="border-color:rgba(239,68,68,0.18);">
      <div class="card-head">
        <span class="card-title"><i class="ti ti-bell-x" style="color:var(--red);margin-right:0.35rem;"></i>Manage Customer Notifications</span>
        <span class="badge badge-red" style="font-size:0.65rem;">Admin</span>
      </div>
      <div class="card-body">
        <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">Delete all notifications for a specific customer, or wipe all notifications system-wide.</p>
        <div style="display:flex;gap:0.875rem;flex-wrap:wrap;align-items:flex-end;">
          <div style="flex:1;min-width:220px;">
            <label class="form-label">Select Customer</label>
            <div class="cpicker-wrap" id="deln-cpicker-wrap">
              <div class="cpicker-input" id="deln-cpicker-btn" onclick="toggleCpicker('deln')">
                <span class="cpicker-placeholder" id="deln-cpicker-placeholder">Search customerâ€¦</span>
                <div class="cpicker-selected" id="deln-cpicker-selected" style="display:none;"></div>
                <i class="ti ti-chevron-down cpicker-arrow"></i>
              </div>
              <div class="cpicker-dropdown" id="deln-cpicker-dropdown" style="display:none;">
                <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i>
                  <input type="text" id="deln-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('deln')">
                </div>
                <div class="cpicker-list" id="deln-cpicker-list"></div>
              </div>
            </div>
            <input type="hidden" id="deln-customer-id" value="">
          </div>
          <button class="btn btn-danger btn-sm" style="flex-shrink:0;" onclick="doDeleteNotifForCustomer()">
            <i class="ti ti-trash"></i> Clear This Customer's Notifications
          </button>
          <button class="btn btn-danger btn-sm" style="flex-shrink:0;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red);" onclick="doDeleteAllNotifications()">
            <i class="ti ti-alert-triangle"></i> Wipe ALL Notifications
          </button>
        </div>
      </div>
    </div>`;
  msgTab.appendChild(panel);
}

async function doDeleteNotifForCustomer() {
  const custId = el('deln-customer-id')?.value;
  if(!custId) return toast('Please select a customer first.','error');
  const custName = cpickerSelected?.deln?.full_name || 'this customer';
  if(!confirm(`Delete all notifications for ${custName}?`)) return;
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('notifications').delete().eq('customer_id', custId);
    if(error) return toast('Error: '+error.message,'error');
  }
  toast(`Notifications cleared for ${custName}.`,'success');
}

async function doDeleteAllNotifications() {
  if(!confirm('âš  Delete ALL notifications for ALL customers? This cannot be undone.')) return;
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('notifications').delete().neq('id','00000000-0000-0000-0000-000000000000');
    if(error) return toast('Error: '+error.message,'error');
  }
  toast('All notifications wiped from the system.','success');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PATCH 6 â€” CUSTOMER SIDEBAR cleanup (remove redundant items)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function patchCustomerSidebar() {
  const sb2 = el('custSidebar');
  if(!sb2 || sb2.dataset.patched) return;
  sb2.dataset.patched = '1';

  sb2.innerHTML = `
    <div class="sidebar-group-label">Dashboard</div>
    <div class="sidebar-item active" onclick="custTab('overview')" id="sitem-overview"><i class="ti ti-dashboard"></i> Overview</div>
    <div class="sidebar-item" onclick="custTab('shipments')" id="sitem-shipments"><i class="ti ti-package"></i> My Shipments</div>
    <div class="sidebar-item" onclick="custTab('track')" id="sitem-track"><i class="ti ti-search"></i> Track Package</div>
    <div class="sidebar-item" onclick="custTab('invoices')" id="sitem-invoices"><i class="ti ti-receipt"></i> Invoices</div>
    <div class="sidebar-item" onclick="custTab('notifications')" id="sitem-notifications">
      <i class="ti ti-bell"></i> Notifications
      <span class="notif-badge" id="notifBadge" style="display:none;">0</span>
    </div>

    <div class="sidebar-group-label">My Account</div>
    <div class="sidebar-item" onclick="custTab('idcard')" id="sitem-idcard"><i class="ti ti-id"></i> ID Card &amp; Address</div>
    <div class="sidebar-item" onclick="custTab('profile')" id="sitem-profile"><i class="ti ti-user-edit"></i> Edit Profile</div>

    <div class="sidebar-spacer"></div>
    <div class="sidebar-item" onclick="signOut()" style="color:var(--red);"><i class="ti ti-logout"></i> Sign Out</div>`;

  // Merge idcard + address into one tab (address tab content moved to idcard area)
  // We keep idcard tab but enhance it with address info below
}

// Enhance the ID card tab to also show address (removes need for separate 'address' sidebar item)
const _origCustTab = window.custTab;
window.custTab = function(name) {
  // Redirect 'address' to 'idcard' since sidebar is merged
  _origCustTab(name === 'address' ? 'idcard' : name);
  if(name === 'idcard' || name === 'address') {
    renderIDCard();
    renderAddressTab();
    // Also render delivery address below the ID card
    setTimeout(patchRenderAddressInIdCard, 100);
  }
};

function patchRenderAddressInIdCard() {
  const tab = el('ctab-idcard');
  if(!tab || tab.dataset.addrPatched) return;
  tab.dataset.addrPatched = '1';

  const p = currentProfile;
  const extraDiv = document.createElement('div');
  extraDiv.style.cssText = 'margin-top:2rem;max-width:780px;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;';
  extraDiv.innerHTML = `
    <!-- Miami Warehouse Address -->
    <div class="card" style="border-color:rgba(245,158,11,0.15);">
      <div class="card-head">
        <span class="card-title"><i class="ti ti-mailbox" style="color:var(--amber);margin-right:0.35rem;"></i>Miami Warehouse Address</span>
        <button class="btn btn-ghost btn-sm" onclick="copyWarehouseAddr()"><i class="ti ti-clipboard"></i> Copy</button>
      </div>
      <div class="card-body">
        <div id="addrTabWarehouse2" class="address-box" style="margin-bottom:0.875rem;"></div>
        <div class="alert alert-warning" style="margin-bottom:0;"><i class="ti ti-alert-triangle"></i> Always include your <strong>CaribCargo ID</strong> so we can match packages.</div>
      </div>
    </div>
    <!-- Delivery Address -->
    <div class="card">
      <div class="card-head">
        <span class="card-title"><i class="ti ti-home" style="color:var(--green);margin-right:0.35rem;"></i>My Delivery Address</span>
        <span class="badge badge-amber" style="font-size:0.6rem;"><i class="ti ti-lock"></i> Admin Set</span>
      </div>
      <div class="card-body">
        <div id="myDeliveryAddr2" class="address-box" style="margin-bottom:0.875rem;"></div>
        <div style="font-size:0.77rem;color:var(--text-3);line-height:1.6;"><i class="ti ti-info-circle" style="margin-right:0.3rem;"></i>To update your delivery address, contact us via the Notifications tab.</div>
      </div>
    </div>`;
  tab.appendChild(extraDiv);

  // Populate
  if(p) {
    const addr = warehouseAddress(p.cargolink_id||'CL-XXXXX', p.full_name||'Customer');
    const wEl = el('addrTabWarehouse2');
    if(wEl) wEl.innerHTML = addr.replace(/\n/g,'<br>');
    const dEl = el('myDeliveryAddr2');
    if(dEl) {
      const parts = [p.addr1, p.addr2, p.city, (p.region_addr||p.region), p.postal, p.country].filter(Boolean);
      dEl.innerHTML = parts.length ? parts.join('<br>') : '<span style="color:var(--text-3);">No address saved yet.</span>';
    }
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-INIT â€” run patches after page loads / after login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _patchObserver = new MutationObserver(() => {
  // Customer dashboard
  if(el('custSidebar') && !el('custSidebar').dataset.patched) patchCustomerSidebar();
  // Admin dashboard
  if(el('adminSidebar') && !el('adminSidebar').dataset.patched) patchAdminSidebar();
  // Messages tab panels
  if(el('atab-messages') && el('atab-messages').classList.contains('active') && !el('atab-messages').dataset.notifPanel) {
    patchAddManageNotifPanel();
    setTimeout(() => populateCpicker('deln'), 50);
  }
  // Updates tab
  if(el('atab-updates') && el('atab-updates').classList.contains('active')) {
    const card = el('atab-updates')?.querySelector('.card');
    if(card && !card.dataset.patched) {
      initUpdCustomerFlow();
      setTimeout(() => populateCpicker('upd'), 50);
    }
  }
});
_patchObserver.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });

// Run immediately in case pages are already loaded
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if(el('custSidebar') && el('custSidebar').offsetParent) patchCustomerSidebar();
    if(el('adminSidebar') && el('adminSidebar').offsetParent) patchAdminSidebar();
  }, 300);
});
</script>
