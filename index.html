<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CaribCargo â€” Global Freight & Logistics</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARIBCARGO DESIGN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:      #030c1a;
  --navy-2:    #071120;
  --navy-3:    #0b1628;
  --navy-4:    #0f1e38;
  --navy-5:    #162440;
  --amber:     #f59e0b;
  --amber-2:   #d97706;
  --amber-3:   #fbbf24;
  --amber-glow: rgba(245,158,11,0.3);
  --blue:      #3b82f6;
  --blue-dim:  rgba(59,130,246,0.15);
  --cyan:      #06b6d4;
  --green:     #10b981;
  --red:       #ef4444;
  --purple:    #8b5cf6;
  --text:      #eee8de;
  --text-2:    #9c9286;
  --text-3:    #5c5650;
  --border:    rgba(255,255,255,0.06);
  --border-2:  rgba(255,255,255,0.12);
  --border-3:  rgba(255,255,255,0.2);
  --card:      rgba(255,255,255,0.025);
  --card-2:    rgba(255,255,255,0.045);
  --radius:    16px;
  --radius-sm: 10px;
  --shadow:    0 24px 64px rgba(0,0,0,0.6);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--text);min-height:100vh;overflow-x:hidden}
h1,h2,h3{font-family:'Bebas Neue',sans-serif;letter-spacing:0.04em}
a{color:inherit;text-decoration:none}
button{cursor:pointer;font-family:'DM Sans',sans-serif}
input,select,textarea{font-family:'DM Sans',sans-serif}
.mono{font-family:'JetBrains Mono',monospace}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;min-height:100vh}
.page.active{display:block}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.5rem;border-radius:10px;font-size:0.9rem;font-weight:600;border:none;transition:all 0.2s;white-space:nowrap;letter-spacing:0.01em}
.btn-amber{background:linear-gradient(135deg,var(--amber),var(--amber-2));color:#000}
.btn-amber:hover{transform:translateY(-1px);box-shadow:0 8px 24px var(--amber-glow)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border-2)}
.btn-ghost:hover{background:rgba(255,255,255,0.05);border-color:var(--border-3)}
.btn-blue{background:var(--blue);color:#fff}
.btn-blue:hover{background:#2563eb;transform:translateY(-1px)}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#059669}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-purple{background:var(--purple);color:#fff}
.btn-sm{padding:0.4rem 0.9rem;font-size:0.8rem;border-radius:8px}
.btn:disabled{opacity:0.4;pointer-events:none}

/* â”€â”€ CARDS â”€â”€ */
.card{background:linear-gradient(145deg,var(--card-2),var(--card));border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.card-head{padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:1rem}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:0.06em;color:var(--text)}
.card-body{padding:1.4rem}

/* â”€â”€ FORMS â”€â”€ */
.form-group{margin-bottom:1rem}
.form-label{display:block;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-2);margin-bottom:0.4rem}
.form-input,.form-select{width:100%;padding:0.72rem 1rem;background:rgba(255,255,255,0.04);border:1.5px solid var(--border-2);border-radius:10px;color:var(--text);font-size:0.9rem;transition:all 0.2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--amber);background:rgba(255,255,255,0.06);box-shadow:0 0 0 3px rgba(245,158,11,0.1)}
.form-input::placeholder{color:var(--text-3)}
.form-select option{background:#0b1628}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
.form-error{font-size:0.75rem;color:var(--red);margin-top:0.3rem}
@media(max-width:600px){.form-grid-2,.form-grid-3{grid-template-columns:1fr}}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:0.3rem;padding:0.22rem 0.65rem;border-radius:20px;font-size:0.7rem;font-weight:700;border:1px solid;white-space:nowrap}
.badge-amber{background:rgba(245,158,11,0.1);color:var(--amber);border-color:rgba(245,158,11,0.25)}
.badge-green{background:rgba(16,185,129,0.1);color:var(--green);border-color:rgba(16,185,129,0.25)}
.badge-blue{background:rgba(59,130,246,0.1);color:var(--blue);border-color:rgba(59,130,246,0.25)}
.badge-red{background:rgba(239,68,68,0.1);color:var(--red);border-color:rgba(239,68,68,0.25)}
.badge-gray{background:rgba(255,255,255,0.05);color:var(--text-2);border-color:rgba(255,255,255,0.1)}
.badge-cyan{background:rgba(6,182,212,0.1);color:var(--cyan);border-color:rgba(6,182,212,0.25)}
.badge-purple{background:rgba(139,92,246,0.1);color:var(--purple);border-color:rgba(139,92,246,0.25)}

/* â”€â”€ TABLES â”€â”€ */
.tbl-wrap{overflow-x:auto}
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:0.65rem 1rem;text-align:left;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-3);border-bottom:1px solid var(--border);white-space:nowrap}
.tbl td{padding:0.85rem 1rem;font-size:0.85rem;border-bottom:1px solid rgba(255,255,255,0.025);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(255,255,255,0.018)}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:2rem;right:2rem;z-index:9999;display:flex;flex-direction:column;gap:0.5rem;pointer-events:none;max-width:320px}
.toast-item{padding:0.875rem 1.25rem;border-radius:12px;font-size:0.875rem;font-weight:600;animation:toast-in 0.3s ease;pointer-events:auto;border:1px solid;display:flex;align-items:center;gap:0.6rem}
.toast-success{background:rgba(16,185,129,0.12);border-color:rgba(16,185,129,0.3);color:var(--green)}
.toast-error{background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.3);color:var(--red)}
.toast-info{background:rgba(59,130,246,0.12);border-color:rgba(59,130,246,0.3);color:var(--blue)}
@keyframes toast-in{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:5000;display:flex;align-items:center;justify-content:center;padding:1rem;animation:fade-in 0.2s ease;overflow-y:auto}
.modal-box{background:var(--navy-3);border:1px solid var(--border-2);border-radius:20px;padding:2rem;width:100%;max-width:500px;box-shadow:0 40px 100px rgba(0,0,0,0.7);animation:slide-up 0.25s ease;position:relative;margin:auto}
.modal-box.lg{max-width:700px}
.modal-box.xl{max-width:900px}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.5rem;gap:1rem}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:0.05em}
.modal-close{width:32px;height:32px;border:none;background:rgba(255,255,255,0.06);border-radius:8px;color:var(--text-2);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
.modal-close:hover{background:rgba(255,255,255,0.1);color:var(--text)}
@keyframes fade-in{from{opacity:0}to{opacity:1}}
@keyframes slide-up{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ STAT CARDS â”€â”€ */
.stat-card{background:linear-gradient(145deg,var(--card-2),var(--card));border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem 1.4rem;position:relative;overflow:hidden;transition:all 0.2s}
.stat-card:hover{border-color:var(--border-2);transform:translateY(-2px)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent)}
.stat-icon{font-size:1.4rem;margin-bottom:0.65rem;display:block;opacity:0.8}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;line-height:1;margin-bottom:0.25rem}
.stat-lbl{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-3)}
.stat-sub{font-size:0.75rem;color:var(--text-3);margin-top:0.35rem}
.stat-glow{position:absolute;bottom:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:0.08;pointer-events:none}
.stats-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
.stats-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
@media(max-width:1000px){.stats-grid-4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.stats-grid-4,.stats-grid-3{grid-template-columns:1fr 1fr}}

/* â”€â”€ TOP NAV â”€â”€ */
.topnav{position:sticky;top:0;z-index:200;display:flex;align-items:center;padding:0 2rem;height:64px;background:rgba(3,12,26,0.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
.topnav-logo{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:0.1em;cursor:pointer;display:flex;align-items:center;gap:0.4rem}
.topnav-logo .cc{color:var(--amber)}
.topnav-logo .cargo{color:var(--text)}
.nav-links{display:flex;gap:0;margin-left:2rem}
.nav-link{padding:0.45rem 0.875rem;font-size:0.85rem;font-weight:500;color:var(--text-2);border-radius:8px;transition:all 0.15s;cursor:pointer}
.nav-link:hover{color:var(--text);background:rgba(255,255,255,0.04)}
.nav-link.active{color:var(--amber)}
.topnav-right{margin-left:auto;display:flex;align-items:center;gap:0.75rem}
@media(max-width:768px){.nav-links{display:none}}

/* â”€â”€ SIDEBAR â”€â”€ */
.dash-layout{display:flex;min-height:calc(100vh - 64px)}
.sidebar{width:225px;flex-shrink:0;background:rgba(7,17,32,0.9);border-right:1px solid var(--border);padding:1.25rem 0.875rem;position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;display:flex;flex-direction:column}
.sidebar-section{font-size:0.62rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-3);margin:1.25rem 0 0.4rem;padding:0 0.5rem}
.sidebar-item{display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;border-radius:10px;font-size:0.85rem;font-weight:500;color:var(--text-2);cursor:pointer;transition:all 0.15s;margin-bottom:0.1rem;border:1px solid transparent}
.sidebar-item:hover{color:var(--text);background:rgba(255,255,255,0.04)}
.sidebar-item.active{color:var(--amber);background:rgba(245,158,11,0.07);border-color:rgba(245,158,11,0.12)}
.sidebar-item i{font-size:1rem;width:18px;text-align:center;flex-shrink:0}
.sidebar-spacer{flex:1}
.dash-main{flex:1;min-width:0;padding:2rem;overflow-y:auto}
@media(max-width:768px){.sidebar{display:none}.dash-main{padding:1rem}}

/* â”€â”€ TAB CONTENT â”€â”€ */
.tab-content{display:none;animation:fade-in 0.2s ease}
.tab-content.active{display:block}

/* â”€â”€ TRACKING TIMELINE â”€â”€ */
.timeline{position:relative;padding-left:1.75rem}
.timeline::before{content:'';position:absolute;left:7px;top:10px;bottom:10px;width:2px;background:var(--border-2)}
.tl-step{position:relative;margin-bottom:1.25rem}
.tl-step:last-child{margin-bottom:0}
.tl-dot{position:absolute;left:-24px;top:2px;width:16px;height:16px;border-radius:50%;border:2px solid var(--border);background:var(--navy);display:flex;align-items:center;justify-content:center;font-size:0.55rem}
.tl-dot.done{border-color:var(--green);background:rgba(16,185,129,0.2);color:var(--green)}
.tl-dot.now{border-color:var(--amber);background:rgba(245,158,11,0.2);color:var(--amber);box-shadow:0 0 12px var(--amber-glow);animation:tl-pulse 2s ease infinite}
.tl-dot.pend{border-color:rgba(255,255,255,0.08)}
@keyframes tl-pulse{0%,100%{box-shadow:0 0 6px var(--amber-glow)}50%{box-shadow:0 0 18px var(--amber-glow)}}
.tl-title{font-weight:600;font-size:0.88rem;margin-bottom:0.15rem}
.tl-sub{font-size:0.77rem;color:var(--text-2)}
.tl-time{font-size:0.7rem;color:var(--text-3);margin-top:0.1rem;font-family:'JetBrains Mono',monospace}

/* â”€â”€ HERO â”€â”€ */
.hero{min-height:calc(100vh - 64px);display:flex;align-items:center;position:relative;overflow:hidden;padding:4rem 2rem}
.hero-canvas{position:absolute;inset:0;pointer-events:none}
.hero-content{max-width:1100px;margin:0 auto;width:100%;position:relative;z-index:2;display:grid;grid-template-columns:1fr 1fr;gap:4rem;align-items:center}
@media(max-width:900px){.hero-content{grid-template-columns:1fr}}
.hero-tag{display:inline-flex;align-items:center;gap:0.5rem;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:20px;padding:0.3rem 0.875rem;font-size:0.72rem;font-weight:700;color:var(--amber);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1.25rem}
.hero-h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(3.5rem,7vw,6.5rem);letter-spacing:0.03em;line-height:0.93;margin-bottom:1.25rem}
.hero-h1 .accent{color:var(--amber);display:block}
.hero-sub{font-size:1.05rem;color:var(--text-2);line-height:1.75;max-width:500px;margin-bottom:2rem}
.hero-btns{display:flex;gap:0.875rem;flex-wrap:wrap;margin-bottom:3rem}
.hero-stats{display:flex;gap:2.5rem;flex-wrap:wrap}
.hero-stat-num{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;color:var(--amber);line-height:1}
.hero-stat-lbl{font-size:0.75rem;color:var(--text-3);margin-top:0.15rem}
.hero-right{position:relative}
.hero-card{background:linear-gradient(135deg,var(--navy-4),var(--navy-3));border:1px solid var(--border-2);border-radius:20px;padding:1.5rem;backdrop-filter:blur(10px)}
.hero-card-title{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:1rem}
.track-preview{display:flex;gap:0.5rem}
.track-preview input{flex:1}

/* â”€â”€ SECTIONS â”€â”€ */
.section{padding:5rem 2rem}
.section-inner{max-width:1100px;margin:0 auto}
.section-tag{display:inline-flex;align-items:center;gap:0.5rem;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--amber);background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.18);border-radius:20px;padding:0.22rem 0.75rem;margin-bottom:0.875rem}
.section-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.5rem,5vw,3.75rem);letter-spacing:0.04em;line-height:1;margin-bottom:0.875rem}
.section-sub{font-size:1rem;color:var(--text-2);max-width:520px;line-height:1.75;margin-bottom:3rem}

/* â”€â”€ HOW IT WORKS â”€â”€ */
.steps-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem}
@media(max-width:900px){.steps-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:550px){.steps-grid{grid-template-columns:1fr 1fr}}
.step-card{background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem 1.1rem;text-align:center;transition:all 0.2s;position:relative;overflow:hidden}
.step-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(245,158,11,0.03));opacity:0;transition:opacity 0.2s}
.step-card:hover::before{opacity:1}
.step-card:hover{border-color:rgba(245,158,11,0.25);transform:translateY(-4px)}
.step-num{font-family:'Bebas Neue',sans-serif;font-size:3rem;color:rgba(245,158,11,0.12);line-height:1;margin-bottom:0.4rem}
.step-icon{font-size:1.75rem;margin-bottom:0.65rem;display:block}
.step-title{font-weight:700;font-size:0.875rem;margin-bottom:0.4rem}
.step-desc{font-size:0.78rem;color:var(--text-2);line-height:1.65}

/* â”€â”€ SERVICES â”€â”€ */
.services-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem}
@media(max-width:768px){.services-grid{grid-template-columns:1fr 1fr}}
@media(max-width:500px){.services-grid{grid-template-columns:1fr}}
.service-card{background:linear-gradient(145deg,var(--card-2),var(--card));border:1px solid var(--border);border-radius:var(--radius);padding:1.75rem;transition:all 0.2s;cursor:default}
.service-card:hover{border-color:rgba(245,158,11,0.25);transform:translateY(-3px);box-shadow:0 16px 48px rgba(0,0,0,0.3)}
.service-icon{font-size:2.25rem;margin-bottom:0.875rem;display:block}
.service-title{font-weight:700;font-size:1rem;margin-bottom:0.4rem}
.service-desc{font-size:0.84rem;color:var(--text-2);line-height:1.65}
.service-rate{font-size:0.78rem;color:var(--amber);margin-top:0.75rem;font-weight:600}

/* â”€â”€ STATS BAR â”€â”€ */
.land-stats{display:grid;grid-template-columns:repeat(4,1fr)}
@media(max-width:700px){.land-stats{grid-template-columns:repeat(2,1fr)}}
.land-stat{text-align:center;padding:2.5rem 1rem;border-right:1px solid var(--border)}
.land-stat:last-child{border-right:none}
.land-stat-num{font-family:'Bebas Neue',sans-serif;font-size:3.25rem;color:var(--amber);line-height:1}
.land-stat-lbl{font-size:0.78rem;color:var(--text-2);margin-top:0.25rem}

/* â”€â”€ AUTH PAGES â”€â”€ */
.auth-layout{min-height:100vh;display:grid;grid-template-columns:1fr 1fr}
@media(max-width:900px){.auth-layout{grid-template-columns:1fr}}
.auth-side{background:linear-gradient(145deg,var(--navy-4),var(--navy-2));display:flex;align-items:center;justify-content:center;padding:3rem;position:relative;overflow:hidden}
@media(max-width:900px){.auth-side.hide-mobile{display:none}}
.auth-side-inner{position:relative;z-index:2;max-width:420px;width:100%}
.auth-form-side{background:var(--navy-2);display:flex;align-items:center;justify-content:center;padding:2rem}
.auth-form-inner{width:100%;max-width:440px}
.auth-logo{font-family:'Bebas Neue',sans-serif;font-size:1.75rem;color:var(--amber);margin-bottom:2rem;display:flex;align-items:center;gap:0.5rem;cursor:pointer}
.auth-title{font-family:'Bebas Neue',sans-serif;font-size:2.25rem;letter-spacing:0.03em;margin-bottom:0.5rem}
.auth-sub{font-size:0.9rem;color:var(--text-2);margin-bottom:2rem}
.auth-divider{display:flex;align-items:center;gap:1rem;margin:1.25rem 0}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border-2)}
.auth-divider span{font-size:0.75rem;color:var(--text-3)}
.auth-switch{text-align:center;margin-top:1.25rem;font-size:0.875rem;color:var(--text-2)}
.auth-switch a{color:var(--amber);font-weight:600;cursor:pointer}
.auth-switch a:hover{text-decoration:underline}
.auth-feature{display:flex;align-items:flex-start;gap:0.875rem;margin-bottom:1.5rem}
.auth-feature-icon{width:36px;height:36px;border-radius:10px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.auth-feature-text{font-size:0.85rem;color:var(--text-2);line-height:1.5}
.auth-feature-title{font-weight:700;color:var(--text);font-size:0.9rem;margin-bottom:0.2rem}

/* â”€â”€ STEP INDICATOR â”€â”€ */
.step-indicator{display:flex;align-items:center;gap:0;margin-bottom:2rem}
.step-ind{display:flex;align-items:center;gap:0.5rem}
.step-ind-num{width:28px;height:28px;border-radius:50%;border:2px solid var(--border-2);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;color:var(--text-3);transition:all 0.2s;flex-shrink:0}
.step-ind-num.active{border-color:var(--amber);color:var(--amber);background:rgba(245,158,11,0.1)}
.step-ind-num.done{border-color:var(--green);background:var(--green);color:#fff}
.step-ind-label{font-size:0.78rem;font-weight:600;color:var(--text-3)}
.step-ind-label.active{color:var(--amber)}
.step-ind-label.done{color:var(--green)}
.step-ind-line{flex:1;height:1px;background:var(--border-2);margin:0 0.75rem}
.step-ind-line.done{background:var(--green)}

/* â”€â”€ SHIP CARD â”€â”€ */
.ship-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.1rem 1.25rem;margin-bottom:0.65rem;transition:all 0.2s;cursor:pointer}
.ship-card:hover{border-color:var(--border-2);background:var(--card-2)}
.ship-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:0.65rem}
.ship-tracking{font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:700;color:var(--amber)}
.ship-desc{font-size:0.82rem;color:var(--text-2);margin-top:0.1rem}
.ship-meta{display:flex;gap:1.25rem;flex-wrap:wrap}
.ship-meta-item{font-size:0.75rem;color:var(--text-3)}
.ship-meta-item span{color:var(--text-2);font-weight:500}

/* â”€â”€ ID CARD â”€â”€ */
.id-card{background:linear-gradient(135deg,#081226 0%,#0d1c3a 50%,#060e1c 100%);border:1px solid rgba(245,158,11,0.25);border-radius:18px;padding:1.6rem;position:relative;overflow:hidden;max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 40px rgba(245,158,11,0.06)}
.id-card::before{content:'';position:absolute;top:-30px;right:-30px;width:180px;height:180px;background:radial-gradient(circle,rgba(245,158,11,0.08),transparent 70%)}
.id-card-logo{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:0.1em;color:var(--amber);margin-bottom:1.1rem}
.id-card-name{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:0.04em;margin-bottom:0.2rem}
.id-card-id{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--amber);margin-bottom:1.1rem}
.id-card-fields{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
.id-card-field-lbl{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.15rem}
.id-card-field-val{font-size:0.8rem;font-weight:600;font-family:'JetBrains Mono',monospace}
.id-barcode{margin-top:1.1rem;display:flex;justify-content:center}

/* â”€â”€ LOADER / EMPTY â”€â”€ */
.loader{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.12);border-top-color:var(--amber);border-radius:50%;animation:spin 0.7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-center{display:flex;align-items:center;justify-content:center;padding:3rem;gap:0.75rem;color:var(--text-2);font-size:0.9rem}
.empty-state{text-align:center;padding:3.5rem 2rem;color:var(--text-2)}
.empty-icon{font-size:2.5rem;margin-bottom:0.875rem;opacity:0.3}
.empty-title{font-size:1rem;font-weight:600;margin-bottom:0.35rem}
.empty-sub{font-size:0.83rem;color:var(--text-3)}

/* â”€â”€ INVOICE CARD â”€â”€ */
.invoice-row{display:grid;grid-template-columns:1fr 2fr 1fr 1fr 1fr auto;gap:1rem;align-items:center;padding:0.875rem 1.1rem;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:0.5rem;font-size:0.84rem}
@media(max-width:700px){.invoice-row{grid-template-columns:1fr 1fr;gap:0.5rem}}

/* â”€â”€ SEARCH WRAP â”€â”€ */
.search-wrap{position:relative;display:inline-flex;align-items:center}
.search-wrap>i{position:absolute;left:0.75rem;color:var(--text-3);font-size:0.9rem;pointer-events:none}
.search-wrap .form-input{padding-left:2.25rem}

/* â”€â”€ FOOTER â”€â”€ */
footer{background:var(--navy-2);border-top:1px solid var(--border);padding:3rem 2rem 2rem}
footer .inner{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:2rem}
@media(max-width:768px){footer .inner{grid-template-columns:1fr 1fr}}
@media(max-width:450px){footer .inner{grid-template-columns:1fr}}
.footer-logo{font-family:'Bebas Neue',sans-serif;font-size:1.35rem;color:var(--amber);margin-bottom:0.65rem;display:flex;align-items:center;gap:0.4rem}
.footer-desc{font-size:0.82rem;color:var(--text-3);line-height:1.7;max-width:240px}
.footer-col-title{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-2);margin-bottom:0.75rem}
.footer-link{display:block;font-size:0.83rem;color:var(--text-3);margin-bottom:0.35rem;transition:color 0.15s}
.footer-link:hover{color:var(--amber)}
.footer-bottom{max-width:1100px;margin:2rem auto 0;padding-top:1.25rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem;font-size:0.78rem;color:var(--text-3)}

/* â”€â”€ SEG PILLS â”€â”€ */
.seg-pills{display:flex;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;padding:3px;gap:2px}
.seg-pill{flex:1;text-align:center;padding:0.4rem 0.75rem;border-radius:9px;font-size:0.8rem;font-weight:600;color:var(--text-2);transition:all 0.15s;cursor:pointer;border:none;background:transparent}
.seg-pill.active{background:rgba(255,255,255,0.07);color:var(--text)}

/* â”€â”€ NOTIFICATION BADGE â”€â”€ */
.notif-badge{background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:0.62rem;font-weight:800;margin-left:auto}

/* â”€â”€ ALERTS â”€â”€ */
.alert{padding:0.875rem 1rem;border-radius:12px;font-size:0.85rem;margin-bottom:1rem;border:1px solid;display:flex;align-items:flex-start;gap:0.6rem}
.alert-warning{background:rgba(245,158,11,0.08);border-color:rgba(245,158,11,0.2);color:var(--amber)}
.alert-info{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2);color:var(--blue)}
.alert-success{background:rgba(16,185,129,0.08);border-color:rgba(16,185,129,0.2);color:var(--green)}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.progress-bar{height:5px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--amber),var(--blue));transition:width 1.2s ease}

/* â”€â”€ ADDRESS DISPLAY â”€â”€ */
.address-box{font-family:'JetBrains Mono',monospace;font-size:0.85rem;line-height:2;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:10px;padding:1rem;color:var(--text)}

/* â”€â”€ UPDATE LOG â”€â”€ */
.update-log-item{display:flex;gap:0.75rem;padding:0.75rem 0;border-bottom:1px solid var(--border);align-items:flex-start}
.update-log-item:last-child{border-bottom:none}
.update-log-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}

/* â”€â”€ DEBUG PANEL â”€â”€ */
#debug-panel {
  position:fixed; bottom:1rem; left:1rem; z-index:99999;
  width:420px; max-height:70vh;
  background:#0a0a0a; border:1px solid #333;
  border-radius:12px; font-family:'JetBrains Mono',monospace;
  font-size:0.72rem; box-shadow:0 20px 60px rgba(0,0,0,0.8);
  display:none; flex-direction:column; overflow:hidden;
}
#debug-panel.open { display:flex; }
#debug-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.6rem 0.875rem; background:#111; border-bottom:1px solid #222;
  cursor:move; user-select:none;
}
#debug-title { color:#f59e0b; font-weight:700; font-size:0.75rem; letter-spacing:0.08em; }
#debug-tabs { display:flex; gap:2px; background:#0a0a0a; padding:0.3rem 0.5rem; border-bottom:1px solid #1a1a1a; }
.dtab { padding:0.25rem 0.6rem; border-radius:5px; cursor:pointer; color:#666; font-size:0.68rem; font-weight:700; transition:all 0.15s; }
.dtab.active { background:#1a1a1a; color:#f59e0b; }
#debug-body { flex:1; overflow-y:auto; padding:0.75rem; }
#debug-body::-webkit-scrollbar { width:3px; }
#debug-body::-webkit-scrollbar-thumb { background:#333; }
.dlog { padding:0.3rem 0; border-bottom:1px solid #111; line-height:1.5; }
.dlog-time { color:#444; margin-right:0.4rem; }
.dlog-ok   { color:#10b981; }
.dlog-err  { color:#ef4444; }
.dlog-warn { color:#f59e0b; }
.dlog-info { color:#3b82f6; }
.dlog-label { color:#8b5cf6; font-weight:700; }
#debug-actions { padding:0.5rem; border-top:1px solid #1a1a1a; display:flex; gap:0.35rem; flex-wrap:wrap; }
.daction { padding:0.25rem 0.5rem; border-radius:5px; background:#1a1a1a; border:1px solid #333; color:#aaa; font-size:0.68rem; cursor:pointer; font-family:inherit; transition:all 0.15s; }
.daction:hover { background:#222; color:#fff; border-color:#555; }
.daction.primary { background:#f59e0b22; border-color:#f59e0b55; color:#f59e0b; }
#debug-toggle {
  position:fixed; bottom:1rem; left:1rem; z-index:99998;
  background:#111; border:1px solid #333; border-radius:8px;
  padding:0.4rem 0.7rem; cursor:pointer; font-family:'JetBrains Mono',monospace;
  font-size:0.7rem; color:#f59e0b; display:flex; align-items:center; gap:0.4rem;
  box-shadow:0 4px 16px rgba(0,0,0,0.5);
}
#debug-toggle:hover { background:#1a1a1a; }
#debug-err-count { background:#ef4444; color:#fff; border-radius:10px; padding:0 5px; font-size:0.62rem; font-weight:800; display:none; }

.btn-blue{background:rgba(59,130,246,0.15);color:var(--blue);border:1px solid rgba(59,130,246,0.3);}
.btn-blue:hover{background:rgba(59,130,246,0.25);}

/* â”€â”€ TOGGLE SWITCH â”€â”€ */
.tog{position:relative;display:inline-block;width:38px;height:21px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0;position:absolute}
.tog-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.08);border-radius:21px;transition:.2s;border:1px solid rgba(255,255,255,0.1)}
.tog-slider::before{content:'';position:absolute;width:15px;height:15px;left:2px;bottom:2px;background:rgba(255,255,255,0.35);border-radius:50%;transition:.2s}
.tog input:checked+.tog-slider{background:var(--amber);border-color:var(--amber-2)}
.tog input:checked+.tog-slider::before{transform:translateX(17px);background:#000}
/* â”€â”€ PERM ROW â”€â”€ */
.perm-row{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid var(--border)}
.perm-row:last-child{border-bottom:none}
/* â”€â”€ STAFF CARD â”€â”€ */
.staff-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.1rem 1.25rem;margin-bottom:0.65rem;transition:border-color .15s}
.staff-card:hover{border-color:var(--border-2)}
/* â”€â”€ RATES wrap for admin edit button â”€â”€ */
.rate-wrap{position:relative}
.rate-admin-btn{display:none;position:absolute;top:0.5rem;right:0.5rem;z-index:5}
</style>
</head>
<body>

<div id="toast"></div>
<div id="modals"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOP NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="topnav" id="topnav">
  <div class="topnav-logo" onclick="showPage('landing')">
    <i class="ti ti-anchor" style="color:var(--amber);"></i>
    <span><span class="cc">CARIB</span><span class="cargo">CARGO</span></span>
  </div>
  <div class="nav-links" id="topnavLinks">
    <div class="nav-link" onclick="scrollToSection('.section-how')">How It Works</div>
    <div class="nav-link" onclick="scrollToSection('.section-services')">Services</div>
    <div class="nav-link" onclick="scrollToSection('.section-rates')">Rates</div>
    <div class="nav-link" onclick="scrollToSection('.section-track')">Track</div>
  </div>
  <div class="topnav-right" id="topnavRight">
    <button class="btn btn-ghost btn-sm" onclick="showPage('signin')">Sign In</button>
    <button class="btn btn-amber btn-sm" onclick="showPage('signup')">Get Started â†’</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-landing">
  <!-- Hero -->
  <section class="hero">
    <canvas class="hero-canvas" id="heroCanvas"></canvas>
    <div class="hero-content">
      <div>
        <div class="hero-tag"><i class="ti ti-globe" style="font-size:0.85rem;"></i> Miami â†’ Caribbean Freight Network</div>
        <h1 class="hero-h1">SHIP IT.<span class="accent">TRACK IT.</span>RECEIVE IT.</h1>
        <p class="hero-sub">The Caribbean's most trusted cargo & logistics platform. Ship from anywhere worldwide to our Miami hub â€” then delivered to your door across the Caribbean.</p>
        <div class="hero-btns">
          <button class="btn btn-amber" style="font-size:1rem;padding:0.875rem 1.75rem;" onclick="showPage('signup')">Open Free Account â†’</button>
          <button class="btn btn-ghost" style="font-size:1rem;padding:0.875rem 1.75rem;" onclick="scrollToSection('.section-track')">Track a Package</button>
        </div>
        <div class="hero-stats">
          <div><div class="hero-stat-num">12K+</div><div class="hero-stat-lbl">Packages Delivered</div></div>
          <div><div class="hero-stat-num">98%</div><div class="hero-stat-lbl">On-Time Rate</div></div>
          <div><div class="hero-stat-num">40+</div><div class="hero-stat-lbl">Countries Shipped From</div></div>
          <div><div class="hero-stat-num">24/7</div><div class="hero-stat-lbl">Live Support</div></div>
        </div>
      </div>
      <div class="hero-right">
        <div class="hero-card">
          <div class="hero-card-title"><i class="ti ti-search" style="color:var(--amber);margin-right:0.4rem;"></i>Quick Track</div>
          <div class="track-preview">
            <input class="form-input" id="heroTrackInput" placeholder="e.g. CCJ-2024-00123" onkeydown="if(event.key==='Enter')heroTrack()">
            <button class="btn btn-amber" onclick="heroTrack()"><i class="ti ti-search"></i></button>
          </div>
          <div id="heroTrackResult" style="margin-top:1rem;"></div>
          <div style="margin-top:1.25rem;border-top:1px solid var(--border);padding-top:1.25rem;">
            <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.75rem;">Why CaribCargo?</div>
            <div style="display:flex;flex-direction:column;gap:0.6rem;">
              <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.82rem;color:var(--text-2);"><i class="ti ti-circle-check" style="color:var(--green);"></i>Free US shopping address</div>
              <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.82rem;color:var(--text-2);"><i class="ti ti-circle-check" style="color:var(--green);"></i>Real-time shipment tracking</div>
              <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.82rem;color:var(--text-2);"><i class="ti ti-circle-check" style="color:var(--green);"></i>Email & SMS notifications</div>
              <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.82rem;color:var(--text-2);"><i class="ti ti-circle-check" style="color:var(--green);"></i>Door-to-door Caribbean delivery</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How it works -->
  <section class="section section-how" style="background:var(--navy-2);border-top:1px solid var(--border);">
    <div class="section-inner">
      <div class="section-tag"><i class="ti ti-list-check"></i> Process</div>
      <h2 class="section-title">HOW IT <span style="color:var(--amber);">WORKS</span></h2>
      <p class="section-sub">Five simple steps from any store worldwide to your front door.</p>
      <div class="steps-grid">
        <div class="step-card"><div class="step-num">01</div><span class="step-icon"><i class="ti ti-fingerprint"></i></span><div class="step-title">Create Account</div><div class="step-desc">Register in minutes and receive your unique CaribCargo ID â€” your gateway to global shopping.</div></div>
        <div class="step-card"><div class="step-num">02</div><span class="step-icon"><i class="ti ti-mailbox"></i></span><div class="step-title">Use Our Address</div><div class="step-desc">Shop any US or international store using your personal Miami warehouse address.</div></div>
        <div class="step-card"><div class="step-num">03</div><span class="step-icon"><i class="ti ti-clipboard-list"></i></span><div class="step-title">We Receive It</div><div class="step-desc">Package arrives, we weigh and photograph it, then email you instantly with your invoice.</div></div>
        <div class="step-card"><div class="step-num">04</div><span class="step-icon"><i class="ti ti-plane"></i></span><div class="step-title">We Ship It</div><div class="step-desc">Your goods fly or sail on our next scheduled run. Track every step live in your dashboard.</div></div>
        <div class="step-card"><div class="step-num">05</div><span class="step-icon"><i class="ti ti-home"></i></span><div class="step-title">You Receive It</div><div class="step-desc">Pick up at our depot or get island-wide door-to-door delivery. It's that simple.</div></div>
      </div>
    </div>
  </section>

  <!-- Services -->
  <section class="section section-services">
    <div class="section-inner">
      <div class="section-tag"><i class="ti ti-ship"></i> Services</div>
      <h2 class="section-title">WHAT WE <span style="color:var(--amber);">MOVE</span></h2>
      <p class="section-sub">From parcels to pallets â€” if it needs to get to the Caribbean, we handle it.</p>
      <div class="services-grid">
        <div class="service-card"><span class="service-icon"><i class="ti ti-package" style="color:var(--amber);"></i></span><div class="service-title">General Cargo</div><div class="service-desc">Clothing, electronics, household goods â€” boxed and shipped securely with full tracking from our Miami hub.</div><div class="service-rate" id="svcRateGeneral">From $6.50/lb Â· Air &amp; Sea</div></div>
        <div class="service-card"><span class="service-icon"><i class="ti ti-building-warehouse" style="color:var(--blue);"></i></span><div class="service-title">Commercial / Barrel</div><div class="service-desc">Fixed-rate barrel shipping for businesses and families. Insurance available on all barrels.</div><div class="service-rate" id="svcRateBarrel">From $95/barrel Â· Sea Freight</div></div>
        <div class="service-card"><span class="service-icon"><i class="ti ti-bolt" style="color:var(--amber);"></i></span><div class="service-title">Express Air Freight</div><div class="service-desc">Need it fast? Miami to Kingston in 2â€“3 business days. Priority handling guaranteed.</div><div class="service-rate" id="svcRateAir">From $12/lb Â· Air Only</div></div>
        <div class="service-card"><span class="service-icon"><i class="ti ti-car" style="color:var(--cyan);"></i></span><div class="service-title">Vehicle Shipping</div><div class="service-desc">Cars, motorcycles, ATVs via RoRo or container. Full customs clearance included.</div><div class="service-rate" id="svcRateVehicle">From $850 Â· Sea Freight</div></div>
        <div class="service-card"><span class="service-icon"><i class="ti ti-crane" style="color:var(--purple);"></i></span><div class="service-title">Heavy Machinery</div><div class="service-desc">Industrial and construction equipment on flatbeds and break-bulk containers.</div><div class="service-rate" id="svcRateMachinery">Custom quote Â· Contact us</div></div>
        <div class="service-card"><span class="service-icon"><i class="ti ti-snowflake" style="color:var(--cyan);"></i></span><div class="service-title">Cold Chain</div><div class="service-desc">Perishables, pharmaceuticals, and temperature-sensitive goods in our reefer containers.</div><div class="service-rate" id="svcRateCold">From $8/lb Â· Refrigerated</div></div>
      </div>
    </div>
  </section>

  <!-- Rates -->
  <section class="section section-rates" style="background:var(--navy-2);border-top:1px solid var(--border);">
    <div class="section-inner">
      <div class="section-tag"><i class="ti ti-currency-dollar"></i> Pricing</div>
      <h2 class="section-title">TRANSPARENT <span style="color:var(--amber);">RATES</span></h2>
      <p class="section-sub">No hidden fees. You'll always know exactly what you're paying before we ship.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem;" id="ratesGrid">
        <div class="card rate-wrap" style="border-color:rgba(245,158,11,0.2);">
          <button class="btn btn-amber btn-sm rate-admin-btn" id="rateEditBtn" onclick="openRatesModal()"><i class="ti ti-edit"></i> Edit Rates</button>
          <div class="card-head"><span class="card-title" style="color:var(--amber);">âœˆ AIR FREIGHT</span></div>
          <div class="card-body">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--amber);margin-bottom:0.25rem;"><span id="rateAirPrice">$12</span><span style="font-size:1rem;color:var(--text-3);font-family:'DM Sans';" id="rateAirUnit">/lb</span></div>
            <div style="font-size:0.8rem;color:var(--text-2);margin-bottom:1rem;" id="rateAirTime">2â€“5 business days</div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.82rem;color:var(--text-2);">
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Priority handling</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Live tracking</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Package insurance</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Email notifications</div>
            </div>
          </div>
        </div>
        <div class="card rate-wrap" style="border-color:rgba(59,130,246,0.2);">
          <div class="card-head"><span class="card-title" style="color:var(--blue);">ðŸš¢ SEA FREIGHT</span></div>
          <div class="card-body">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--blue);margin-bottom:0.25rem;"><span id="rateSeaPrice">$6.50</span><span style="font-size:1rem;color:var(--text-3);font-family:'DM Sans';" id="rateSeaUnit">/lb</span></div>
            <div style="font-size:0.8rem;color:var(--text-2);margin-bottom:1rem;" id="rateSeaTime">10â€“14 business days</div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.82rem;color:var(--text-2);">
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Cost-effective</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Live tracking</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>No size limits</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Email notifications</div>
            </div>
          </div>
        </div>
        <div class="card rate-wrap" style="border-color:rgba(16,185,129,0.2);">
          <div class="card-head"><span class="card-title" style="color:var(--green);">ðŸ›¢ BARREL</span></div>
          <div class="card-body">
            <div style="font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--green);margin-bottom:0.25rem;"><span id="rateBarrelPrice">$95</span><span style="font-size:1rem;color:var(--text-3);font-family:'DM Sans';" id="rateBarrelUnit">/barrel</span></div>
            <div style="font-size:0.8rem;color:var(--text-2);margin-bottom:1rem;" id="rateBarrelTime">10â€“14 business days</div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.82rem;color:var(--text-2);">
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Fixed flat rate</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Live tracking</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Insurance available</div>
              <div><i class="ti ti-check" style="color:var(--green);margin-right:0.4rem;"></i>Email notifications</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats bar -->
  <section style="background:var(--navy-3);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
    <div class="land-stats" style="max-width:1100px;margin:0 auto;">
      <div class="land-stat"><div class="land-stat-num">12,400+</div><div class="land-stat-lbl">Packages Delivered</div></div>
      <div class="land-stat"><div class="land-stat-num">$4.2M</div><div class="land-stat-lbl">Goods Shipped (2024)</div></div>
      <div class="land-stat"><div class="land-stat-num">3,200+</div><div class="land-stat-lbl">Active Customers</div></div>
      <div class="land-stat"><div class="land-stat-num">14</div><div class="land-stat-lbl">Years in Operation</div></div>
    </div>
  </section>

  <!-- Track -->
  <section class="section section-track">
    <div class="section-inner" style="max-width:680px;">
      <div class="section-tag"><i class="ti ti-search"></i> Track</div>
      <h2 class="section-title">TRACK YOUR <span style="color:var(--amber);">SHIPMENT</span></h2>
      <p class="section-sub">Enter your tracking number â€” no account required.</p>
      <div style="display:flex;gap:0.75rem;">
        <input class="form-input" id="pubTrackInput" placeholder="e.g. CCJ-2024-00123" style="flex:1;font-size:1rem;padding:0.875rem 1rem;" onkeydown="if(event.key==='Enter')trackPublic()">
        <button class="btn btn-amber" style="font-size:1rem;" onclick="trackPublic()">Track <i class="ti ti-search"></i></button>
      </div>
      <div id="pubTrackResult" style="margin-top:1.5rem;"></div>
    </div>
  </section>

  <!-- CTA -->
  <section class="section" style="text-align:center;background:var(--navy-2);border-top:1px solid var(--border);">
    <div class="section-inner">
      <h2 class="section-title">READY TO <span style="color:var(--amber);">SHIP?</span></h2>
      <p style="color:var(--text-2);font-size:1.05rem;margin-bottom:0.5rem;">Open your free account in under 2 minutes.</p>
      <p style="color:var(--text-3);font-size:0.85rem;margin-bottom:2rem;">No credit card required. Ship from 40+ countries worldwide.</p>
      <button class="btn btn-amber" style="font-size:1rem;padding:0.9rem 2.25rem;" onclick="showPage('signup')">Create Free Account â†’</button>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="inner">
      <div>
        <div class="footer-logo"><i class="ti ti-anchor"></i> CARIBCARGO</div>
        <div class="footer-desc">Jamaica's premier freight and logistics network. Moving goods between the USA and the Caribbean since 2010.</div>
        <div style="margin-top:1rem;display:flex;gap:0.5rem;">
          <div style="width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;"><i class="ti ti-brand-facebook" style="font-size:0.9rem;color:var(--text-3);"></i></div>
          <div style="width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;"><i class="ti ti-brand-instagram" style="font-size:0.9rem;color:var(--text-3);"></i></div>
          <div style="width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;"><i class="ti ti-brand-whatsapp" style="font-size:0.9rem;color:var(--text-3);"></i></div>
        </div>
      </div>
      <div>
        <div class="footer-col-title">Services</div>
        <a class="footer-link">General Cargo</a>
        <a class="footer-link">Barrel Shipping</a>
        <a class="footer-link">Air Freight</a>
        <a class="footer-link">Vehicle Shipping</a>
        <a class="footer-link">Cold Chain</a>
      </div>
      <div>
        <div class="footer-col-title">Company</div>
        <a class="footer-link">About Us</a>
        <a class="footer-link">Our Rates</a>
        <a class="footer-link">Customs Info</a>
        <a class="footer-link">Contact</a>
        <a class="footer-link">Privacy Policy</a>
      </div>
      <div>
        <div class="footer-col-title">Contact</div>
        <div class="footer-link"><i class="ti ti-map-pin"></i> 16 Port Royal St, Kingston, Jamaica</div>
        <div class="footer-link"><i class="ti ti-phone"></i> (876) 555-0100</div>
        <div class="footer-link"><i class="ti ti-mail"></i> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="573e393138173436253e3534362530387934383a">[email&#160;protected]</a></div>
        <div class="footer-link" style="margin-top:0.75rem;"><strong style="color:var(--text-2);">Miami Hub:</strong></div>
        <div class="footer-link"><i class="ti ti-map-pin"></i> 2210 NW 102nd Ave, Miami FL 33172</div>
      </div>
    </div>
    <div class="footer-bottom">
      <span>Â© 2024 CaribCargo Ltd. All rights reserved.</span>
      <span>Privacy Policy Â· Terms of Service Â· Customs Guidelines</span>
    </div>
  </footer>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIGN IN PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-signin">
  <div class="auth-layout">
    <div class="auth-side hide-mobile">
      <canvas style="position:absolute;inset:0;pointer-events:none;width:100%;height:100%;" id="signInCanvas"></canvas>
      <div class="auth-side-inner">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.25rem;color:var(--amber);margin-bottom:2.5rem;display:flex;align-items:center;gap:0.4rem;cursor:pointer;" onclick="showPage('landing')"><i class="ti ti-anchor"></i> CARIBCARGO</div>
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:3rem;letter-spacing:0.03em;line-height:1;margin-bottom:1rem;">WELCOME <span style="color:var(--amber);">BACK</span></h2>
        <p style="color:var(--text-2);font-size:0.95rem;line-height:1.7;margin-bottom:2.5rem;">Access your shipments, track packages, and manage your Caribbean logistics â€” all in one place.</p>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-package"></i></div>
          <div><div class="auth-feature-title">Live Shipment Tracking</div><div class="auth-feature-text">See exactly where your package is at every stage of its journey.</div></div>
        </div>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-bell"></i></div>
          <div><div class="auth-feature-title">Instant Notifications</div><div class="auth-feature-text">Get emailed the moment your package arrives or changes status.</div></div>
        </div>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-receipt"></i></div>
          <div><div class="auth-feature-title">Digital Invoices</div><div class="auth-feature-text">View and pay your shipping invoices directly from your dashboard.</div></div>
        </div>
      </div>
    </div>
    <div class="auth-form-side">
      <div class="auth-form-inner">
        <div class="auth-logo" onclick="showPage('landing')"><i class="ti ti-anchor"></i> CARIBCARGO</div>
        <h2 class="auth-title">SIGN IN</h2>
        <p class="auth-sub">Enter your credentials to access your account.</p>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input class="form-input" id="si-email" type="email" placeholder="you@email.com" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <div style="position:relative;">
            <input class="form-input" id="si-pass" type="password" placeholder="Your password" style="padding-right:3rem;" onkeydown="if(event.key==='Enter')doLogin()">
            <button onclick="togglePass('si-pass')" style="position:absolute;right:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-3);font-size:0.9rem;"><i class="ti ti-eye" id="si-eye"></i></button>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:-0.5rem;margin-bottom:1rem;">
          <a style="font-size:0.8rem;color:var(--amber);cursor:pointer;" onclick="forgotPassword()">Forgot password?</a>
        </div>
        <button class="btn btn-amber" style="width:100%;padding:0.875rem;font-size:0.95rem;" id="loginBtn" onclick="doLogin()">
          Sign In <i class="ti ti-arrow-right"></i>
        </button>
        <div class="auth-divider"><span>or demo access</span></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
          <button class="btn btn-ghost btn-sm" onclick="demoLogin('customer')" style="font-size:0.8rem;"><i class="ti ti-user"></i> Demo Customer</button>
          <button class="btn btn-ghost btn-sm" onclick="demoLogin('admin')" style="font-size:0.8rem;"><i class="ti ti-shield"></i> Demo Admin</button>
        </div>
        <div class="auth-switch">Don't have an account? <a onclick="showPage('signup')">Create one free â†’</a></div>
        <div id="login-help" style="display:none;margin-top:1rem;padding:0.875rem;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;font-size:0.8rem;color:var(--amber);line-height:1.6;">
          <strong>Having trouble?</strong><br>
          â€¢ New account? Check your email for a <strong>confirmation link</strong> first.<br>
          â€¢ Getting rate limited? Wait 60 seconds and try again.<br>
          â€¢ First time setup? Make sure you've run the SQL script in Supabase.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIGN UP PAGE (Multi-step)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-signup">
  <div class="auth-layout">
    <div class="auth-side hide-mobile">
      <canvas style="position:absolute;inset:0;pointer-events:none;width:100%;height:100%;" id="signUpCanvas"></canvas>
      <div class="auth-side-inner">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.25rem;color:var(--amber);margin-bottom:2.5rem;display:flex;align-items:center;gap:0.4rem;cursor:pointer;" onclick="showPage('landing')"><i class="ti ti-anchor"></i> CARIBCARGO</div>
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:3rem;letter-spacing:0.03em;line-height:1;margin-bottom:1rem;">JOIN THE <span style="color:var(--amber);">NETWORK</span></h2>
        <p style="color:var(--text-2);font-size:0.95rem;line-height:1.7;margin-bottom:2.5rem;">Get your free US shopping address and start shipping to the Caribbean in minutes.</p>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-mailbox"></i></div>
          <div><div class="auth-feature-title">Free US Warehouse Address</div><div class="auth-feature-text">Shop any US store and ship to our Miami hub using your personal address.</div></div>
        </div>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-id"></i></div>
          <div><div class="auth-feature-title">Unique CaribCargo ID</div><div class="auth-feature-text">Your personal ID ensures every package is matched to your account instantly.</div></div>
        </div>
        <div class="auth-feature">
          <div class="auth-feature-icon"><i class="ti ti-shield-check"></i></div>
          <div><div class="auth-feature-title">Customs Support</div><div class="auth-feature-text">We handle all customs documentation and clearance on your behalf.</div></div>
        </div>
      </div>
    </div>
    <div class="auth-form-side" style="overflow-y:auto;">
      <div class="auth-form-inner" style="padding:2rem 0;">
        <div class="auth-logo" onclick="showPage('landing')"><i class="ti ti-anchor"></i> CARIBCARGO</div>

        <!-- Step indicator -->
        <div class="step-indicator">
          <div class="step-ind">
            <div class="step-ind-num active" id="si1-num">1</div>
            <div class="step-ind-label active" id="si1-lbl">Account</div>
          </div>
          <div class="step-ind-line" id="si-line1"></div>
          <div class="step-ind">
            <div class="step-ind-num" id="si2-num">2</div>
            <div class="step-ind-label" id="si2-lbl">Personal</div>
          </div>
          <div class="step-ind-line" id="si-line2"></div>
          <div class="step-ind">
            <div class="step-ind-num" id="si3-num">3</div>
            <div class="step-ind-label" id="si3-lbl">Address</div>
          </div>
        </div>

        <!-- Step 1: Account -->
        <div id="reg-step1">
          <h2 class="auth-title">ACCOUNT DETAILS</h2>
          <p class="auth-sub">Set up your login credentials.</p>
          <div class="form-group">
            <label class="form-label">Email Address *</label>
            <input class="form-input" id="r-email" type="email" placeholder="you@email.com">
          </div>
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Password *</label>
              <div style="position:relative;">
                <input class="form-input" id="r-pass" type="password" placeholder="Min 8 characters" style="padding-right:2.5rem;">
                <button onclick="togglePass('r-pass')" style="position:absolute;right:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-3);"><i class="ti ti-eye"></i></button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Confirm Password *</label>
              <input class="form-input" id="r-pass2" type="password" placeholder="Repeat password">
            </div>
          </div>
          <div id="pass-strength" style="margin-top:-0.5rem;margin-bottom:1rem;"></div>
          <button class="btn btn-amber" style="width:100%;padding:0.875rem;" onclick="regStep(2)">Continue <i class="ti ti-arrow-right"></i></button>
          <div class="auth-switch">Already have an account? <a onclick="showPage('signin')">Sign in â†’</a></div>
        </div>

        <!-- Step 2: Personal -->
        <div id="reg-step2" style="display:none;">
          <h2 class="auth-title">PERSONAL INFO</h2>
          <p class="auth-sub">Tell us about yourself.</p>
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">First Name *</label>
              <input class="form-input" id="r-fname" placeholder="Jane">
            </div>
            <div class="form-group">
              <label class="form-label">Last Name *</label>
              <input class="form-input" id="r-lname" placeholder="Smith">
            </div>
          </div>
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">Phone Number *</label>
              <input class="form-input" id="r-phone" placeholder="+1 (876) 555-0100">
            </div>
            <div class="form-group">
              <label class="form-label">TRN / National ID</label>
              <input class="form-input" id="r-trn" placeholder="123-456-789">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Country of Residence *</label>
            <select class="form-select" id="r-country" onchange="updateRegionFields()">
              <option value="">Select your countryâ€¦</option>
              <option value="Jamaica">Jamaica</option>
              <option value="Barbados">Barbados</option>
              <option value="Trinidad and Tobago">Trinidad and Tobago</option>
              <option value="Guyana">Guyana</option>
              <option value="Bahamas">The Bahamas</option>
              <option value="Haiti">Haiti</option>
              <option value="Dominican Republic">Dominican Republic</option>
              <option value="Cayman Islands">Cayman Islands</option>
              <option value="Turks and Caicos">Turks and Caicos</option>
              <option value="Antigua">Antigua and Barbuda</option>
              <option value="United States">United States</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Canada">Canada</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div id="region-field" style="display:none;">
            <!-- dynamically inserted parish / state / province field -->
          </div>
          <div style="display:flex;gap:0.75rem;">
            <button class="btn btn-ghost" onclick="regStep(1)"><i class="ti ti-arrow-left"></i> Back</button>
            <button class="btn btn-amber" style="flex:1;padding:0.875rem;" onclick="regStep(3)">Continue <i class="ti ti-arrow-right"></i></button>
          </div>
        </div>

        <!-- Step 3: Address -->
        <div id="reg-step3" style="display:none;">
          <h2 class="auth-title">DELIVERY ADDRESS</h2>
          <p class="auth-sub">Where should we deliver your packages?</p>
          <div class="form-group">
            <label class="form-label">Street Address *</label>
            <input class="form-input" id="r-addr1" placeholder="123 Main Street">
          </div>
          <div class="form-group">
            <label class="form-label">Apt / Unit / Building</label>
            <input class="form-input" id="r-addr2" placeholder="Apt 4B (optional)">
          </div>
          <div class="form-grid-2">
            <div class="form-group">
              <label class="form-label">City / Town *</label>
              <input class="form-input" id="r-city" placeholder="Kingston">
            </div>
            <div class="form-group">
              <label class="form-label" id="r-region-lbl">Parish / State</label>
              <input class="form-input" id="r-region-addr" placeholder="Kingston">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Postal / ZIP Code</label>
            <input class="form-input" id="r-postal" placeholder="JMAAW15">
          </div>
          <div class="form-group">
            <label class="form-label" style="margin-bottom:0.5rem;">Preferred Delivery Method</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
              <label style="cursor:pointer;">
                <input type="radio" name="r-delivery" value="pickup" style="display:none;" id="rd-pickup">
                <div class="delivery-opt" id="dopt-pickup" onclick="selectDelivery('pickup')" style="border:1.5px solid var(--border-2);border-radius:10px;padding:0.875rem;text-align:center;transition:all 0.15s;">
                  <i class="ti ti-building-store" style="font-size:1.5rem;color:var(--text-2);display:block;margin-bottom:0.35rem;"></i>
                  <div style="font-size:0.82rem;font-weight:600;">Depot Pickup</div>
                  <div style="font-size:0.72rem;color:var(--text-3);">Collect at our office</div>
                </div>
              </label>
              <label style="cursor:pointer;">
                <input type="radio" name="r-delivery" value="door" style="display:none;" id="rd-door">
                <div class="delivery-opt" id="dopt-door" onclick="selectDelivery('door')" style="border:1.5px solid var(--amber);border-radius:10px;padding:0.875rem;text-align:center;background:rgba(245,158,11,0.05);transition:all 0.15s;">
                  <i class="ti ti-home" style="font-size:1.5rem;color:var(--amber);display:block;margin-bottom:0.35rem;"></i>
                  <div style="font-size:0.82rem;font-weight:600;">Door Delivery</div>
                  <div style="font-size:0.72rem;color:var(--text-3);">We come to you</div>
                </div>
              </label>
            </div>
          </div>
          <div style="display:flex;gap:0.75rem;">
            <button class="btn btn-ghost" onclick="regStep(2)"><i class="ti ti-arrow-left"></i> Back</button>
            <button class="btn btn-amber" style="flex:1;padding:0.875rem;" id="regSubmitBtn" onclick="doRegister()">Create Account <i class="ti ti-arrow-right"></i></button>
          </div>
          <div class="auth-switch">Already have an account? <a onclick="showPage('signin')">Sign in â†’</a></div>
          <p style="font-size:0.72rem;color:var(--text-3);text-align:center;margin-top:1rem;line-height:1.6;">By creating an account you agree to our <a style="color:var(--amber);">Terms of Service</a> and <a style="color:var(--amber);">Privacy Policy</a>.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CUSTOMER DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-customer">
  <div class="dash-layout">
    <aside class="sidebar" id="custSidebar">
      <div class="sidebar-section">Main</div>
      <div class="sidebar-item active" onclick="custTab('overview')" id="sitem-overview"><i class="ti ti-dashboard"></i> Overview</div>
      <div class="sidebar-item" onclick="custTab('shipments')" id="sitem-shipments"><i class="ti ti-package"></i> My Shipments</div>
      <div class="sidebar-item" onclick="custTab('track')" id="sitem-track"><i class="ti ti-search"></i> Track Package</div>
      <div class="sidebar-item" onclick="custTab('invoices')" id="sitem-invoices"><i class="ti ti-receipt"></i> Invoices</div>
      <div class="sidebar-item" onclick="custTab('notifications')" id="sitem-notifications"><i class="ti ti-bell"></i> Notifications <span class="notif-badge" id="notifBadge" style="display:none;">0</span></div>
      <div class="sidebar-section">Account</div>
      <div class="sidebar-item" onclick="custTab('idcard')" id="sitem-idcard"><i class="ti ti-id"></i> My ID Card</div>
      <div class="sidebar-item" onclick="custTab('address')" id="sitem-address"><i class="ti ti-mailbox"></i> My Address</div>
      <div class="sidebar-item" onclick="custTab('profile')" id="sitem-profile"><i class="ti ti-user"></i> Profile</div>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-item" onclick="signOut()" style="color:var(--red);"><i class="ti ti-logout"></i> Sign Out</div>
    </aside>
    <main class="dash-main">

      <!-- OVERVIEW -->
      <div class="tab-content active" id="ctab-overview">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 id="custGreeting" style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">GOOD MORNING!</h2>
            <div style="color:var(--text-2);font-size:0.88rem;margin-top:0.2rem;" id="custSubGreeting">Welcome to your CaribCargo dashboard.</div>
          </div>
          <div style="display:flex;gap:0.75rem;">
            <button class="btn btn-ghost btn-sm" onclick="custTab('idcard')"><i class="ti ti-id"></i> My ID</button>
            <button class="btn btn-amber btn-sm" onclick="custTab('track')"><i class="ti ti-search"></i> Track Package</button>
          </div>
        </div>

        <div class="stats-grid-4">
          <div class="stat-card"><span class="stat-icon" style="color:var(--amber);"><i class="ti ti-package"></i></span><div class="stat-val" id="cstat-total">â€”</div><div class="stat-lbl">Total Shipments</div><div class="stat-glow" style="background:var(--amber);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--blue);"><i class="ti ti-plane"></i></span><div class="stat-val" id="cstat-transit">â€”</div><div class="stat-lbl">In Transit</div><div class="stat-glow" style="background:var(--blue);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--green);"><i class="ti ti-circle-check"></i></span><div class="stat-val" id="cstat-delivered">â€”</div><div class="stat-lbl">Delivered</div><div class="stat-glow" style="background:var(--green);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--red);"><i class="ti ti-currency-dollar"></i></span><div class="stat-val" id="cstat-balance">â€”</div><div class="stat-lbl">Outstanding</div><div class="stat-glow" style="background:var(--red);"></div></div>
        </div>

        <!-- Quick address -->
        <div class="card" style="margin-bottom:1.25rem;border-color:rgba(245,158,11,0.15);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-mailbox" style="color:var(--amber);margin-right:0.4rem;"></i>Your Miami Warehouse Address</span>
            <div style="display:flex;gap:0.5rem;">
              <span class="badge badge-green"><i class="ti ti-check"></i> Active</span>
              <button class="btn btn-ghost btn-sm" onclick="copyWarehouseAddr()"><i class="ti ti-clipboard"></i> Copy</button>
            </div>
          </div>
          <div class="card-body">
            <div id="warehouseAddress" class="address-box"></div>
            <div class="alert alert-warning" style="margin-top:0.875rem;margin-bottom:0;"><i class="ti ti-alert-triangle"></i> Always include your <strong>CaribCargo ID</strong> in the address line so we can match packages to your account.</div>
          </div>
        </div>

        <!-- Recent shipments -->
        <div class="card">
          <div class="card-head"><span class="card-title">Recent Shipments</span><button class="btn btn-amber btn-sm" onclick="custTab('shipments')">View All <i class="ti ti-arrow-right"></i></button></div>
          <div class="card-body" id="custRecentShipments"><div class="loading-center"><div class="loader"></div> Loadingâ€¦</div></div>
        </div>
      </div>

      <!-- MY SHIPMENTS -->
      <div class="tab-content" id="ctab-shipments">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">MY SHIPMENTS</h2>
          <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
            <div class="search-wrap"><i class="ti ti-search"></i><input class="form-input" id="shipSearch" placeholder="Search tracking #â€¦" style="width:210px;" oninput="filterShipments()"></div>
            <select class="form-select" id="shipFilter" style="width:155px;" onchange="filterShipments()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="received">Received</option>
              <option value="in_transit">In Transit</option>
              <option value="customs">Customs</option>
              <option value="ready">Ready for Pickup</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
        </div>
        <div id="shipmentsList"><div class="loading-center"><div class="loader"></div></div></div>
      </div>

      <!-- TRACK -->
      <div class="tab-content" id="ctab-track">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">TRACK SHIPMENT</h2>
        <div class="card" style="max-width:600px;margin-bottom:1.5rem;">
          <div class="card-body">
            <div style="display:flex;gap:0.75rem;">
              <input class="form-input" id="dashTrackInput" placeholder="Enter tracking numberâ€¦" style="flex:1;" onkeydown="if(event.key==='Enter')dashTrack()">
              <button class="btn btn-amber" onclick="dashTrack()">Track <i class="ti ti-search"></i></button>
            </div>
          </div>
        </div>
        <div id="dashTrackResult"></div>
      </div>

      <!-- INVOICES -->
      <div class="tab-content" id="ctab-invoices">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">INVOICES</h2>
        <div id="invoicesList"><div class="loading-center"><div class="loader"></div></div></div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="tab-content" id="ctab-notifications">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">NOTIFICATIONS</h2>
        <div id="notificationsList"><div class="loading-center"><div class="loader"></div></div></div>
        <!-- Reply / Contact Admin -->
        <div class="card" style="margin-top:1.5rem;max-width:680px;border-color:rgba(59,130,246,0.2);">
          <div class="card-head"><span class="card-title"><i class="ti ti-message-reply" style="color:var(--blue);margin-right:0.35rem;"></i>Send a Message to Support</span></div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">Have a question about a shipment or invoice? Send us a message and we'll respond to your notifications.</p>
            <div class="form-group">
              <label class="form-label">Subject *</label>
              <input class="form-input" id="cust-reply-title" placeholder="e.g. Question about my shipment CCJ-2024-10025">
            </div>
            <div class="form-group">
              <label class="form-label">Your Message *</label>
              <textarea class="form-input" id="cust-reply-body" rows="4" placeholder="Describe your question or concernâ€¦" style="resize:vertical;"></textarea>
            </div>
            <button class="btn btn-blue" onclick="sendCustomerReply()"><i class="ti ti-send"></i> Send Message</button>
          </div>
        </div>
      </div>

      <!-- MY ADDRESS -->
      <div class="tab-content" id="ctab-address">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">MY SHIPPING ADDRESS</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;max-width:900px;" class="resp-grid">
          <div>
            <div class="card" style="margin-bottom:1.25rem;border-color:rgba(245,158,11,0.15);">
              <div class="card-head"><span class="card-title"><i class="ti ti-mailbox" style="color:var(--amber);"></i> Miami Warehouse Address</span></div>
              <div class="card-body">
                <div id="addrTabWarehouse" class="address-box" style="margin-bottom:1rem;"></div>
                <div style="display:flex;gap:0.75rem;">
                  <button class="btn btn-amber btn-sm" onclick="copyWarehouseAddr()"><i class="ti ti-clipboard"></i> Copy Address</button>
                  <button class="btn btn-ghost btn-sm" onclick="window.print()"><i class="ti ti-printer"></i> Print</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-head"><span class="card-title"><i class="ti ti-info-circle" style="color:var(--blue);"></i> How to Use</span></div>
              <div class="card-body" style="font-size:0.85rem;color:var(--text-2);line-height:1.75;">
                <p style="margin-bottom:0.875rem;">When shopping online from any US or international retailer, use the address above as your shipping address. Include your name and <strong style="color:var(--amber);">CaribCargo ID</strong> exactly as shown.</p>
                <p style="margin-bottom:0.875rem;"><strong style="color:var(--text);">Important:</strong> Your CaribCargo ID (e.g. <span class="mono" style="color:var(--amber);" id="addrTabId">CL-XXXXX</span>) is your unique identifier. Without it, we cannot match packages to your account.</p>
                <p>Once your package arrives at our Miami warehouse, you will receive an email notification with the weight and invoice details.</p>
              </div>
            </div>
          </div>
          <div>
            <div class="card">
              <div class="card-head"><span class="card-title"><i class="ti ti-home" style="color:var(--green);"></i> My Delivery Address</span><span class="badge badge-amber" style="font-size:0.6rem;"><i class="ti ti-lock"></i> Admin Set</span></div>
              <div class="card-body">
                <div id="myDeliveryAddr" class="address-box" style="margin-bottom:1rem;"></div>
                <div style="font-size:0.78rem;color:var(--text-3);line-height:1.6;"><i class="ti ti-info-circle" style="margin-right:0.3rem;"></i>Your delivery address is set by CaribCargo. Contact support to update it.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ID CARD -->
      <div class="tab-content" id="ctab-idcard">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">MY ID CARD</h2>
        <div style="display:flex;gap:2.5rem;flex-wrap:wrap;align-items:flex-start;">
          <div id="idCardEl"></div>
          <div style="max-width:320px;">
            <p style="color:var(--text-2);font-size:0.875rem;margin-bottom:1.25rem;line-height:1.75;">Your CaribCargo ID is your unique identifier. Include it in every shipment address so we can match packages to your account instantly.</p>
            <button class="btn btn-amber" onclick="window.print()" style="margin-bottom:1rem;"><i class="ti ti-printer"></i> Print ID Card</button>
            <div class="alert alert-warning">
              <i class="ti ti-alert-triangle"></i>
              <div>Keep this ID private. Do not share it with others as it grants access to your account information.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="tab-content" id="ctab-profile">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">MY PROFILE</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;max-width:900px;" class="resp-grid">
          <div class="card">
            <div class="card-head"><span class="card-title">Personal Information</span></div>
            <div class="card-body">
              <div class="form-grid-2">
                <div class="form-group"><label class="form-label">First Name</label><input class="form-input" id="prof-fname"></div>
                <div class="form-group"><label class="form-label">Last Name</label><input class="form-input" id="prof-lname"></div>
              </div>
              <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="prof-phone" placeholder="+1 (876) 555-â€¦"></div>
              <div class="form-group"><label class="form-label">TRN / National ID</label><input class="form-input" id="prof-trn"></div>
              <div class="form-group"><label class="form-label">Country</label><input class="form-input" id="prof-country" readonly style="background:rgba(255,255,255,0.02);color:var(--text-2);"></div>
              <button class="btn btn-amber" onclick="saveProfile()">Save Changes</button>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><span class="card-title">Delivery Address</span><span class="badge badge-amber" style="font-size:0.6rem;"><i class="ti ti-lock"></i> Admin Set</span></div>
            <div class="card-body">
              <div id="profileAddrDisplay" style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;padding:1rem;font-size:0.85rem;line-height:1.8;color:var(--text-2);margin-bottom:1rem;"></div>
              <div style="font-size:0.78rem;color:var(--text-3);line-height:1.65;"><i class="ti ti-info-circle" style="margin-right:0.3rem;"></i>Your delivery address is managed by CaribCargo. To update it, please contact us via the Notifications tab.</div>
              <!-- Hidden inputs kept for saveProfile compatibility, not shown -->
              <input type="hidden" id="prof-addr1"><input type="hidden" id="prof-addr2">
              <input type="hidden" id="prof-city"><input type="hidden" id="prof-region"><input type="hidden" id="prof-postal">
            </div>
          </div>
        </div>
        <div class="card" style="max-width:440px;margin-top:1.25rem;">
          <div class="card-head"><span class="card-title" style="color:var(--red);">Danger Zone</span></div>
          <div class="card-body">
            <p style="font-size:0.84rem;color:var(--text-2);margin-bottom:1rem;">Permanently delete your account and all associated data. This action cannot be undone.</p>
            <button class="btn btn-danger btn-sm" onclick="openDeleteMyAccountModal()"><i class="ti ti-trash"></i> Delete Account</button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-admin">
  <div class="dash-layout">
    <aside class="sidebar" id="adminSidebar">
      <div style="padding:0.5rem;margin-bottom:0.5rem;">
        <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.18);border-radius:8px;padding:0.4rem 0.75rem;font-size:0.68rem;font-weight:700;color:var(--red);text-align:center;letter-spacing:0.1em;"><i class="ti ti-shield-lock"></i> ADMIN CONSOLE</div>
      </div>
      <div class="sidebar-section">Dashboard</div>
      <div class="sidebar-item active" onclick="adminTab('overview')" id="aitem-overview"><i class="ti ti-dashboard"></i> Overview</div>
      <div class="sidebar-item" onclick="adminTab('customers')" id="aitem-customers"><i class="ti ti-users"></i> Customers</div>
      <div class="sidebar-item" onclick="adminTab('shipments')" id="aitem-shipments"><i class="ti ti-package"></i> Shipments</div>
      <div class="sidebar-item" onclick="adminTab('pending')" id="aitem-pending"><i class="ti ti-clock-hour-4"></i> Pending <span class="notif-badge" id="adminPendingBadge" style="display:none;">0</span></div>
      <div class="sidebar-item" onclick="adminTab('invoices')" id="aitem-invoices"><i class="ti ti-receipt"></i> Invoices</div>
      <div class="sidebar-item" onclick="adminTab('updates')" id="aitem-updates"><i class="ti ti-send"></i> Send Update</div>
      <div class="sidebar-item" onclick="adminTab('messages')" id="aitem-messages"><i class="ti ti-message-dots"></i> Message Customer</div>
      <div class="sidebar-item" onclick="adminTab('settings')" id="aitem-settings"><i class="ti ti-settings"></i> Settings</div>
      <div class="sidebar-item" onclick="adminTab('reports')" id="aitem-reports"><i class="ti ti-chart-line"></i> Reports</div>
      <div class="sidebar-item" onclick="adminTab('exports')" id="aitem-exports"><i class="ti ti-download"></i> Exports</div>
      <div class="sidebar-item" onclick="adminTab('data')" id="aitem-data" style="color:var(--red);"><i class="ti ti-database-x"></i> Data Management</div>
      <div class="sidebar-item" onclick="adminTab('staff')" id="aitem-staff" style="position:relative;"><i class="ti ti-shield-half"></i> Staff &amp; Roles <span id="ownerCrownBadge" style="display:none;margin-left:auto;font-size:0.62rem;background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;padding:1px 6px;border-radius:8px;font-weight:800;">ðŸ‘‘ OWNER</span></div>
      <div class="sidebar-section">Quick Actions</div>
      <div class="sidebar-item" onclick="openCreateShipment()"><i class="ti ti-plus"></i> New Shipment</div>
      <div class="sidebar-item" onclick="openCreateInvoice()"><i class="ti ti-file-plus"></i> New Invoice</div>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-item" onclick="signOut()" style="color:var(--red);"><i class="ti ti-logout"></i> Sign Out</div>
    </aside>
    <main class="dash-main">

      <!-- ADMIN OVERVIEW -->
      <div class="tab-content active" id="atab-overview">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">ADMIN OVERVIEW</h2>
            <div style="color:var(--text-2);font-size:0.85rem;" id="adminDate"></div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="refreshAdmin()"><i class="ti ti-refresh"></i> Refresh</button>
        </div>
        <div class="stats-grid-4">
          <div class="stat-card"><span class="stat-icon" style="color:var(--amber);"><i class="ti ti-users"></i></span><div class="stat-val" id="astat-customers">â€”</div><div class="stat-lbl">Customers</div><div class="stat-glow" style="background:var(--amber);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--blue);"><i class="ti ti-package"></i></span><div class="stat-val" id="astat-shipments">â€”</div><div class="stat-lbl">Total Shipments</div><div class="stat-glow" style="background:var(--blue);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--cyan);"><i class="ti ti-plane"></i></span><div class="stat-val" id="astat-transit">â€”</div><div class="stat-lbl">In Transit</div><div class="stat-glow" style="background:var(--cyan);"></div></div>
          <div class="stat-card"><span class="stat-icon" style="color:var(--green);"><i class="ti ti-currency-dollar"></i></span><div class="stat-val" id="astat-revenue">â€”</div><div class="stat-lbl">Revenue</div><div class="stat-glow" style="background:var(--green);"></div></div>
        </div>
        <div style="display:grid;grid-template-columns:1.5fr 1fr;gap:1.25rem;margin-bottom:1.25rem;">
          <div class="card">
            <div class="card-head"><span class="card-title">Shipments by Status</span></div>
            <div class="card-body"><div style="height:200px;position:relative;"><canvas id="adminStatusChart"></canvas></div></div>
          </div>
          <div class="card">
            <div class="card-head"><span class="card-title">Recent Activity</span></div>
            <div class="card-body" id="adminRecentActivity" style="max-height:220px;overflow-y:auto;"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><span class="card-title">Pending Actions</span><span class="badge badge-red" id="adminPendingCount">0 pending</span></div>
          <div class="card-body" id="adminPendingList"><div class="loading-center"><div class="loader"></div></div></div>
        </div>
      </div>

      <!-- ADMIN CUSTOMERS -->
      <div class="tab-content" id="atab-customers">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">CUSTOMERS</h2>
          <div class="search-wrap"><i class="ti ti-search"></i><input class="form-input" id="custSearch" placeholder="Search name, email, IDâ€¦" style="width:260px;" oninput="searchCustomers()"></div>
        </div>
        <div class="card">
          <div class="tbl-wrap">
            <table class="tbl">
              <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Country</th><th>Shipments</th><th>Joined</th><th>Actions</th></tr></thead>
              <tbody id="adminCustTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN ALL SHIPMENTS -->
      <div class="tab-content" id="atab-shipments">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">ALL SHIPMENTS</h2>
          <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
            <div class="search-wrap"><i class="ti ti-search"></i><input class="form-input" id="adminShipSearch" placeholder="Searchâ€¦" style="width:200px;" oninput="searchAdminShipments()"></div>
            <select class="form-select" id="adminShipFilter" style="width:150px;" onchange="searchAdminShipments()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="received">Received</option>
              <option value="in_transit">In Transit</option>
              <option value="customs">Customs</option>
              <option value="ready">Ready</option>
              <option value="delivered">Delivered</option>
            </select>
            <button class="btn btn-amber btn-sm" onclick="openCreateShipment()"><i class="ti ti-plus"></i> New</button>
          </div>
        </div>
        <div class="card">
          <div class="tbl-wrap">
            <table class="tbl">
              <thead><tr><th>Tracking #</th><th>Customer</th><th>Type</th><th>Weight</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody id="adminShipTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN PENDING -->
      <div class="tab-content" id="atab-pending">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">PENDING REVIEW</h2>
        <div id="adminPendingFull"><div class="loading-center"><div class="loader"></div></div></div>
      </div>

      <!-- ADMIN INVOICES -->
      <div class="tab-content" id="atab-invoices">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">INVOICES</h2>
          <button class="btn btn-amber btn-sm" onclick="openCreateInvoice()"><i class="ti ti-plus"></i> New Invoice</button>
        </div>
        <div class="card">
          <div class="tbl-wrap">
            <table class="tbl">
              <thead><tr><th>Invoice #</th><th>Customer</th><th>Amount</th><th>Status</th><th>Due</th><th>Actions</th></tr></thead>
              <tbody id="adminInvTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ADMIN SEND UPDATES -->
      <div class="tab-content" id="atab-updates">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">SEND SHIPMENT UPDATE</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;max-width:900px;">
          <div class="card">
            <div class="card-head"><span class="card-title">Update Shipment Status</span></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Tracking Number</label>
                <div class="tpicker-wrap" id="upd-tpicker-wrap">
                  <input class="form-input" id="upd-tracking" placeholder="Type to search tracking #â€¦" autocomplete="off" oninput="filterTpicker('upd')" onfocus="showTpicker('upd')" style="font-family:'JetBrains Mono',monospace;">
                  <div class="tpicker-dropdown" id="upd-tpicker-dropdown">
                    <div class="tpicker-list" id="upd-tpicker-list"></div>
                  </div>
                </div>
                <div id="upd-cust-preview" style="margin-top:0.4rem;display:none;"></div>
              </div>
              <div class="form-group">
                <label class="form-label">New Status</label>
                <select class="form-select" id="upd-status">
                  <option value="">Select statusâ€¦</option>
                  <option value="received">ðŸ“¦ Received at Warehouse</option>
                  <option value="in_transit">âœˆ In Transit</option>
                  <option value="customs">ðŸ›‚ Customs Clearance</option>
                  <option value="ready">ðŸ“« Ready for Pickup</option>
                  <option value="delivered">âœ… Delivered</option>
                  <option value="cancelled">âŒ Cancelled</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Custom Message (optional)</label>
                <textarea class="form-input" id="upd-note" rows="3" placeholder="Additional details for the customerâ€¦" style="resize:vertical;"></textarea>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--text-2);">
                  <input type="checkbox" id="upd-sendemail" checked style="accent-color:var(--amber);width:16px;height:16px;">
                  Send email notification to customer
                </label>
              </div>
              <button class="btn btn-amber" style="width:100%;" onclick="sendShipmentUpdate()"><i class="ti ti-send"></i> Update & Notify Customer</button>
            </div>
          </div>
          <div class="card">
            <div class="card-head"><span class="card-title">Bulk Status Update</span></div>
            <div class="card-body">
              <p style="font-size:0.85rem;color:var(--text-2);margin-bottom:1.25rem;line-height:1.7;">Select multiple shipments and update their status simultaneously. Customers will all receive email notifications.</p>
              <div class="form-group">
                <label class="form-label">Filter by Current Status</label>
                <select class="form-select" id="bulk-filter" onchange="loadBulkShipments()">
                  <option value="pending">Pending</option>
                  <option value="received">Received</option>
                  <option value="in_transit">In Transit</option>
                </select>
              </div>
              <div id="bulk-ship-list" style="max-height:200px;overflow-y:auto;margin-bottom:1rem;">
                <div style="font-size:0.82rem;color:var(--text-3);">Select a status filter above to load shipments.</div>
              </div>
              <div class="form-group">
                <label class="form-label">Update All Selected To</label>
                <select class="form-select" id="bulk-new-status">
                  <option value="received">Received at Warehouse</option>
                  <option value="in_transit">In Transit</option>
                  <option value="customs">Customs</option>
                  <option value="ready">Ready for Pickup</option>
                  <option value="delivered">Delivered</option>
                </select>
              </div>
              <button class="btn btn-blue" style="width:100%;" onclick="bulkUpdate()"><i class="ti ti-refresh"></i> Apply Bulk Update</button>
            </div>
          </div>
        </div>
        <!-- Update Log -->
        <div class="card" style="max-width:900px;margin-top:1.25rem;">
          <div class="card-head"><span class="card-title">Recent Update Log</span></div>
          <div class="card-body" id="updateLog">
            <div style="font-size:0.84rem;color:var(--text-3);">No updates sent yet this session.</div>
          </div>
        </div>
      </div>


      <!-- ADMIN MESSAGES -->
      <div class="tab-content" id="atab-messages">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">MESSAGE CUSTOMER</h2>
            <div style="font-size:0.85rem;color:var(--text-2);margin-top:0.2rem;">Send a direct message that appears on the customer's dashboard + email (when EmailJS is configured).</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1.4fr;gap:1.25rem;max-width:1000px;">

          <!-- Compose -->
          <div class="card">
            <div class="card-head"><span class="card-title"><i class="ti ti-edit" style="color:var(--amber);margin-right:0.35rem;"></i>Compose Message</span></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Send To *</label>
                <div class="cpicker-wrap" id="msg-cpicker-wrap">
                  <div class="cpicker-input" id="msg-cpicker-btn" onclick="toggleCpicker('msg')">
                    <span class="cpicker-placeholder" id="msg-cpicker-placeholder">Select a customerâ€¦</span>
                    <div class="cpicker-selected" id="msg-cpicker-selected" style="display:none;"></div>
                    <i class="ti ti-chevron-down cpicker-arrow"></i>
                  </div>
                  <div class="cpicker-dropdown" id="msg-cpicker-dropdown" style="display:none;">
                    <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i><input type="text" id="msg-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('msg')"></div>
                    <div class="cpicker-list" id="msg-cpicker-list"></div>
                  </div>
                </div>
                <input type="hidden" id="msg-customer-id" value="">
              </div>
              <div class="form-group">
                <label class="form-label">Message Title *</label>
                <input class="form-input" id="msg-title" placeholder="e.g. Your package has arrived">
              </div>
              <div class="form-group">
                <label class="form-label">Message Body *</label>
                <textarea class="form-input" id="msg-body" rows="5" placeholder="Write your message hereâ€¦" style="resize:vertical;"></textarea>
              </div>
              <!-- Quick Templates -->
              <div style="margin-bottom:1rem;">
                <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);margin-bottom:0.5rem;">âš¡ Quick Templates</div>
                <div style="display:flex;flex-wrap:wrap;gap:0.4rem;">
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;border-color:rgba(16,185,129,0.3);color:var(--green);" onclick="applyMsgTemplate('order_arrived')">ðŸ“¦ Your Order Has Arrived</button>
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;border-color:rgba(59,130,246,0.3);color:var(--blue);" onclick="applyMsgTemplate('in_transit')">ðŸš¢ Package In Transit</button>
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;border-color:rgba(245,158,11,0.3);color:var(--amber);" onclick="applyMsgTemplate('customs_hold')">ðŸ›ƒ Customs Hold</button>
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;border-color:rgba(139,92,246,0.3);color:#a78bfa;" onclick="applyMsgTemplate('ready_pickup')">âœ… Ready for Pickup</button>
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;border-color:rgba(245,158,11,0.3);color:var(--amber);" onclick="applyMsgTemplate('action_required')">âš ï¸ Action Required</button>
                  <button class="btn btn-ghost btn-sm" style="font-size:0.75rem;" onclick="applyMsgTemplate('general_update')">ðŸ“‹ General Update</button>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
                <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--text-2);">
                  <input type="checkbox" id="msg-sendemail" checked style="accent-color:var(--amber);width:15px;height:15px;">
                  Also send via email (requires EmailJS)
                </label>
              </div>
              <button class="btn btn-amber" style="width:100%;" onclick="sendAdminMessage()">
                <i class="ti ti-send"></i> Send Message
              </button>
            </div>
          </div>

          <!-- Sent log -->
          <div class="card">
            <div class="card-head">
              <span class="card-title"><i class="ti ti-history" style="color:var(--text-3);margin-right:0.35rem;"></i>Sent Messages</span>
              <button class="btn btn-ghost btn-sm" onclick="clearMsgLog()"><i class="ti ti-trash"></i></button>
            </div>
            <div id="msg-log" style="min-height:200px;">
              <div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">No messages sent yet this session.</div>
            </div>
          </div>
        </div>

        <!-- Customer Inbox â€” replies from customers -->
        <div style="margin-top:1.5rem;max-width:1000px;">
          <div class="card">
            <div class="card-head">
              <span class="card-title"><i class="ti ti-inbox" style="color:var(--cyan);margin-right:0.35rem;"></i>Customer Inbox <span id="inboxUnreadBadge" class="badge badge-amber" style="display:none;margin-left:0.5rem;"></span></span>
              <button class="btn btn-ghost btn-sm" onclick="loadAdminInbox()"><i class="ti ti-refresh"></i> Refresh</button>
            </div>
            <div id="admin-inbox" style="min-height:120px;">
              <div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">Click refresh to load customer replies.</div>
            </div>
          </div>
        </div>
      </div>


      <!-- ADMIN SETTINGS -->
      <div class="tab-content" id="atab-settings">
        <div style="margin-bottom:1.5rem;">
          <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">SETTINGS</h2>
          <div style="font-size:0.85rem;color:var(--text-2);margin-top:0.2rem;">Platform-wide configuration. Changes here apply to all customers instantly.</div>
        </div>

        <!-- Rates Management -->
        <div class="card" style="max-width:680px;margin-bottom:1.25rem;border-color:rgba(245,158,11,0.2);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-currency-dollar" style="color:var(--amber);margin-right:0.4rem;"></i>Landing Page Rates</span>
            <span class="badge badge-amber"><i class="ti ti-lock"></i> Admin Only</span>
          </div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">Edit the public-facing pricing shown on the landing page. Changes are instant and persist for all visitors.</p>
            <button class="btn btn-amber" onclick="openRatesModal()"><i class="ti ti-edit"></i> Edit Rates &amp; Pricing</button>
          </div>
        </div>

        <!-- Edit Customer Profile -->
        <div class="card" style="max-width:680px;margin-bottom:1.25rem;border-color:rgba(59,130,246,0.2);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-user-edit" style="color:var(--blue);margin-right:0.4rem;"></i>Edit Customer Profile</span>
          </div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">Update a customer's name, phone, address, delivery preference, or country. Search by name or CargoLink ID.</p>
            <div class="form-group">
              <div class="cpicker-wrap" id="ep-cpicker-wrap">
                <div class="cpicker-input" id="ep-cpicker-btn" onclick="toggleCpicker('ep')">
                  <span class="cpicker-placeholder" id="ep-cpicker-placeholder">Search customer to editâ€¦</span>
                  <div class="cpicker-selected" id="ep-cpicker-selected" style="display:none;"></div>
                  <i class="ti ti-chevron-down cpicker-arrow"></i>
                </div>
                <div class="cpicker-dropdown" id="ep-cpicker-dropdown" style="display:none;">
                  <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i><input type="text" id="ep-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('ep')"></div>
                  <div class="cpicker-list" id="ep-cpicker-list"></div>
                </div>
              </div>
              <input type="hidden" id="ep-cust-uuid" value="">
            </div>
            <div id="ep-edit-form" style="display:none;">
              <div class="form-grid-2">
                <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="ep-fullname" placeholder="Jane Smith"></div>
                <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="ep-phone" placeholder="+1-876-555-0000"></div>
              </div>
              <div class="form-grid-2">
                <div class="form-group"><label class="form-label">Country</label><input class="form-input" id="ep-country" placeholder="Jamaica"></div>
                <div class="form-group"><label class="form-label">TRN / Tax ID</label><input class="form-input" id="ep-trn" placeholder="123-456-789"></div>
              </div>
              <div class="form-group"><label class="form-label">Address Line 1</label><input class="form-input" id="ep-addr1"></div>
              <div class="form-grid-2">
                <div class="form-group"><label class="form-label">City</label><input class="form-input" id="ep-city"></div>
                <div class="form-group"><label class="form-label">Parish / State</label><input class="form-input" id="ep-region"></div>
              </div>
              <div class="form-group"><label class="form-label">Delivery Preference</label>
                <select class="form-select" id="ep-delivery">
                  <option value="pickup">Pickup at depot</option>
                  <option value="door">Door-to-door delivery</option>
                </select>
              </div>
              <button class="btn btn-amber" onclick="saveCustomerProfileEdit()"><i class="ti ti-check"></i> Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Warehouse Address -->
        <div class="card" style="max-width:680px;margin-bottom:1.25rem;border-color:rgba(245,158,11,0.2);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-building-warehouse" style="color:var(--amber);margin-right:0.4rem;"></i>Miami Warehouse Address</span>
            <span class="badge badge-amber"><i class="ti ti-lock"></i> Admin Only</span>
          </div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">This is the US shipping address shown to ALL customers on their dashboard. Only you can change it.</p>
            <div id="warehouse-display" style="margin-bottom:1rem;">
              <div class="warehouse-locked">
                <i class="ti ti-map-pin" style="color:var(--amber);font-size:1.1rem;margin-top:0.1rem;"></i>
                <div class="warehouse-addr-display" id="warehouse-addr-text"></div>
              </div>
            </div>
            <div id="warehouse-edit" style="display:none;">
              <textarea class="form-input" id="warehouse-edit-input" rows="4" style="font-family:'JetBrains Mono',monospace;font-size:0.82rem;resize:vertical;"></textarea>
              <div style="display:flex;gap:0.75rem;margin-top:0.75rem;">
                <button class="btn btn-amber" onclick="saveWarehouseAddr()"><i class="ti ti-check"></i> Save Address</button>
                <button class="btn btn-ghost" onclick="cancelWarehouseEdit()">Cancel</button>
              </div>
            </div>
            <div id="warehouse-edit-btns">
              <button class="btn btn-ghost btn-sm" onclick="editWarehouseAddr()"><i class="ti ti-edit"></i> Edit Address</button>
            </div>
          </div>
        </div>

        <!-- EmailJS Config reminder -->
        <div class="card" style="max-width:680px;border-color:rgba(59,130,246,0.2);margin-bottom:1.25rem;">
          <div class="card-head"><span class="card-title"><i class="ti ti-mail" style="color:var(--blue);margin-right:0.4rem;"></i>Email Configuration (EmailJS)</span></div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.65;">Update the <code style="font-family:monospace;font-size:0.8rem;color:var(--amber);">EMAILJS_PUBLIC_KEY</code>, <code style="font-family:monospace;font-size:0.8rem;color:var(--amber);">EMAILJS_SERVICE_ID</code>, and template IDs at the top of the HTML source file. All templates live under <strong>EmailJS Dashboard â†’ Email Templates</strong>.</p>
            <div style="background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:8px;padding:0.875rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-2);line-height:2;" id="emailjs-status-display"></div>

            <!-- Template guide -->
            <div style="margin-top:1.25rem;">
              <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-3);margin-bottom:0.75rem;">Your 2 EmailJS Templates (Free Plan)</div>
              <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:0.75rem;margin-bottom:0.75rem;font-size:0.78rem;color:var(--amber);">
                âš¡ Configured for 2-template setup â€” all 4 email types share these 2 templates.
              </div>

              <div style="display:flex;flex-direction:column;gap:0.75rem;">
                <!-- Template 1 -->
                <div style="background:rgba(16,185,129,0.04);border:1px solid rgba(16,185,129,0.15);border-radius:10px;padding:0.875rem;">
                  <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
                    <span class="badge badge-green">1</span>
                    <strong style="font-size:0.875rem;">template_invoice1</strong>
                    <span class="badge badge-gray" style="font-size:0.6rem;">Welcome + Invoice</span>
                  </div>
                  <div style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.5rem;">Used for: new customer welcome emails AND invoice notifications.</div>
                  <div style="font-family:monospace;font-size:0.72rem;color:var(--amber);line-height:2;">
                    Include these variables:<br>
                    <code>{{to_name}}</code> Â· <code>{{to_email}}</code> Â· <code>{{cargolink_id}}</code> Â· <code>{{warehouse_address}}</code><br>
                    <code>{{invoice_id}}</code> Â· <code>{{amount}}</code> Â· <code>{{description}}</code> Â· <code>{{due_date}}</code>
                  </div>
                  <div style="font-size:0.72rem;color:var(--text-3);margin-top:0.3rem;">Make a flexible template that gracefully shows whichever fields are populated.</div>
                </div>
                <!-- Template 2 -->
                <div style="background:rgba(59,130,246,0.04);border:1px solid rgba(59,130,246,0.15);border-radius:10px;padding:0.875rem;">
                  <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
                    <span class="badge badge-blue">2</span>
                    <strong style="font-size:0.875rem;">template_invoice</strong>
                    <span class="badge badge-gray" style="font-size:0.6rem;">Updates + Messages + Replies</span>
                  </div>
                  <div style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.5rem;">Used for: shipment status updates, admin messages to customers, and reply emails.</div>
                  <div style="font-family:monospace;font-size:0.72rem;color:var(--amber);line-height:2;">
                    Include these variables:<br>
                    <code>{{to_name}}</code> Â· <code>{{to_email}}</code> Â· <code>{{tracking_number}}</code> Â· <code>{{status}}</code><br>
                    <code>{{description}}</code> Â· <code>{{note}}</code> Â· <code>{{message}}</code> Â· <code>{{subject}}</code>
                  </div>
                  <div style="font-size:0.72rem;color:var(--text-3);margin-top:0.3rem;">Subject suggestion: "CaribCargo Update â€” {{tracking_number}}" (works for all types)</div>
                </div>
              </div>

              <div style="margin-top:1rem;padding:0.75rem;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;font-size:0.78rem;color:var(--text-2);line-height:1.7;">
                <strong style="color:var(--amber);">âš¡ Setup Steps:</strong><br>
                1. Go to <a href="https://emailjs.com" target="_blank" style="color:var(--blue);">emailjs.com</a> â†’ Create account â†’ Add an Email Service (Gmail, Outlook, etc.)<br>
                2. You only need your 2 existing templates: <strong>template_invoice1</strong> and <strong>template_invoice</strong><br>
                3. Copy your <strong>Public Key</strong> from Account â†’ API Keys<br>
                4. Edit the HTML source file and update the constants at the top (search for <code style="color:var(--amber);">EMAILJS_PUBLIC_KEY</code>)
              </div>
            </div>

            <button class="btn btn-ghost btn-sm" style="margin-top:0.875rem;" onclick="testEmailJSConfig()"><i class="ti ti-send"></i> Send Test Email</button>
          </div>
        </div>

      </div><!-- end atab-settings -->

      <!-- ADMIN REPORTS -->
      <div class="tab-content" id="atab-reports">
        <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;margin-bottom:1.5rem;">REPORTS</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;">
          <div class="card"><div class="card-head"><span class="card-title">Shipments by Type</span></div><div class="card-body"><div style="height:220px;position:relative;"><canvas id="reportTypeChart"></canvas></div></div></div>
          <div class="card"><div class="card-head"><span class="card-title">Monthly Volume</span></div><div class="card-body"><div style="height:220px;position:relative;"><canvas id="reportMonthChart"></canvas></div></div></div>
          <div class="card"><div class="card-head"><span class="card-title">Revenue Breakdown</span></div><div class="card-body" id="revenueBreakdown"></div></div>
          <div class="card"><div class="card-head"><span class="card-title">Top Customers</span></div><div class="card-body"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Customer</th><th>Shipments</th><th>Revenue</th></tr></thead><tbody id="topCustTable"></tbody></table></div></div></div>
        </div>
      </div><!-- end atab-reports -->

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DATA MANAGEMENT TAB
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="tab-content" id="atab-data">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">DATA MANAGEMENT</h2>
            <div style="font-size:0.85rem;color:var(--text-2);margin-top:0.2rem;">Permanently delete records from the database. All actions require typed confirmation and cannot be undone.</div>
          </div>
          <span class="badge badge-red" style="font-size:0.8rem;padding:0.4rem 0.9rem;"><i class="ti ti-alert-triangle"></i> &nbsp;Destructive Actions â€” Admin Only</span>
        </div>

        <!-- Warning banner -->
        <div style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.2);border-radius:var(--radius);padding:1rem 1.25rem;margin-bottom:1.75rem;display:flex;gap:0.875rem;align-items:flex-start;max-width:720px;">
          <i class="ti ti-shield-exclamation" style="color:var(--red);font-size:1.4rem;flex-shrink:0;margin-top:0.1rem;"></i>
          <div style="font-size:0.84rem;color:var(--text-2);line-height:1.7;">
            <strong style="color:var(--red);">These deletions hit the live Supabase database immediately.</strong><br>
            Records removed here are gone forever â€” there is no recycle bin or undo. Each action will ask you to type a confirmation phrase before proceeding.
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;max-width:900px;">

          <!-- â”€â”€ SHIPMENT DELETIONS â”€â”€ -->
          <div class="card" style="border-color:rgba(245,158,11,0.15);">
            <div class="card-head">
              <span class="card-title"><i class="ti ti-package" style="color:var(--amber);margin-right:0.4rem;"></i>Shipments</span>
              <span class="badge badge-amber">3 actions</span>
            </div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:0.75rem;">

              <div style="padding:1rem;background:rgba(16,185,129,0.04);border:1px solid rgba(16,185,129,0.15);border-radius:10px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;">
                  <div>
                    <div style="font-weight:700;font-size:0.875rem;display:flex;align-items:center;gap:0.5rem;">
                      <span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0;"></span>
                      Delivered Shipments
                    </div>
                    <div style="font-size:0.76rem;color:var(--text-2);margin-top:0.3rem;line-height:1.55;">Removes all shipments with status <code style="font-family:monospace;color:var(--green);">delivered</code>. Safe to run regularly to keep the database lean.</div>
                  </div>
                  <button class="btn btn-danger btn-sm" style="flex-shrink:0;margin-top:0.1rem;" onclick="openBulkDeleteModal('delivered_shipments')"><i class="ti ti-trash"></i> Delete</button>
                </div>
              </div>

              <div style="padding:1rem;background:rgba(156,146,134,0.04);border:1px solid rgba(156,146,134,0.15);border-radius:10px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;">
                  <div>
                    <div style="font-weight:700;font-size:0.875rem;display:flex;align-items:center;gap:0.5rem;">
                      <span style="width:8px;height:8px;border-radius:50%;background:var(--text-3);display:inline-block;flex-shrink:0;"></span>
                      Cancelled Shipments
                    </div>
                    <div style="font-size:0.76rem;color:var(--text-2);margin-top:0.3rem;line-height:1.55;">Removes all shipments with status <code style="font-family:monospace;color:var(--text-2);">cancelled</code>. Cleans up rejected or abandoned records.</div>
                  </div>
                  <button class="btn btn-danger btn-sm" style="flex-shrink:0;margin-top:0.1rem;" onclick="openBulkDeleteModal('cancelled_shipments')"><i class="ti ti-trash"></i> Delete</button>
                </div>
              </div>

              <div style="padding:1rem;background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.22);border-radius:10px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;">
                  <div>
                    <div style="font-weight:700;font-size:0.875rem;color:var(--red);display:flex;align-items:center;gap:0.5rem;">
                      <i class="ti ti-alert-triangle" style="font-size:0.85rem;flex-shrink:0;"></i>
                      ALL Shipments
                    </div>
                    <div style="font-size:0.76rem;color:var(--text-2);margin-top:0.3rem;line-height:1.55;">Wipes <strong style="color:var(--red);">every</strong> shipment record regardless of status. Customers will see an empty dashboard. Extremely destructive.</div>
                  </div>
                  <button class="btn btn-danger btn-sm" style="flex-shrink:0;margin-top:0.1rem;" onclick="openBulkDeleteModal('all_shipments')"><i class="ti ti-alert-triangle"></i> Wipe</button>
                </div>
              </div>

            </div>
          </div>

          <!-- â”€â”€ INVOICE DELETIONS â”€â”€ -->
          <div class="card" style="border-color:rgba(59,130,246,0.15);">
            <div class="card-head">
              <span class="card-title"><i class="ti ti-receipt" style="color:var(--blue);margin-right:0.4rem;"></i>Invoices</span>
              <span class="badge badge-blue">2 actions</span>
            </div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:0.75rem;">

              <div style="padding:1rem;background:rgba(16,185,129,0.04);border:1px solid rgba(16,185,129,0.15);border-radius:10px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;">
                  <div>
                    <div style="font-weight:700;font-size:0.875rem;display:flex;align-items:center;gap:0.5rem;">
                      <span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0;"></span>
                      Paid Invoices
                    </div>
                    <div style="font-size:0.76rem;color:var(--text-2);margin-top:0.3rem;line-height:1.55;">Removes all invoices with status <code style="font-family:monospace;color:var(--green);">paid</code>. Good for end-of-period archiving after you've exported records.</div>
                  </div>
                  <button class="btn btn-danger btn-sm" style="flex-shrink:0;margin-top:0.1rem;" onclick="openBulkDeleteModal('paid_invoices')"><i class="ti ti-trash"></i> Delete</button>
                </div>
              </div>

              <div style="padding:1rem;background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.22);border-radius:10px;">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;">
                  <div>
                    <div style="font-weight:700;font-size:0.875rem;color:var(--red);display:flex;align-items:center;gap:0.5rem;">
                      <i class="ti ti-alert-triangle" style="font-size:0.85rem;flex-shrink:0;"></i>
                      ALL Invoices
                    </div>
                    <div style="font-size:0.76rem;color:var(--text-2);margin-top:0.3rem;line-height:1.55;">Wipes <strong style="color:var(--red);">every</strong> invoice including unpaid ones. Customers will lose visibility of outstanding balances. Extremely destructive.</div>
                  </div>
                  <button class="btn btn-danger btn-sm" style="flex-shrink:0;margin-top:0.1rem;" onclick="openBulkDeleteModal('all_invoices')"><i class="ti ti-alert-triangle"></i> Wipe</button>
                </div>
              </div>

              <!-- Spacer card for tip -->
              <div style="padding:1rem;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;">
                <div style="font-size:0.76rem;color:var(--text-3);line-height:1.65;">
                  <i class="ti ti-bulb" style="color:var(--amber);margin-right:0.3rem;"></i>
                  <strong style="color:var(--text-2);">Tip:</strong> Always export a CSV from the <strong>Exports</strong> tab before running any deletion. Deleted data cannot be recovered.
                </div>
              </div>

            </div>
          </div>

        </div>
      </div><!-- end atab-data -->

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EXPORTS TAB
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="tab-content" id="atab-exports">

        <!-- Header -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">EXPORTS &amp; REPORTS</h2>
            <p style="color:var(--text-2);font-size:0.875rem;margin-top:0.25rem;">Download data as CSV or generate branded print reports. PDFs open in a new window â€” use browser Print â†’ Save as PDF.</p>
          </div>
        </div>

        <!-- â”€â”€ SECTION 1: Customer Lookup â”€â”€ -->
        <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.875rem;display:flex;align-items:center;gap:0.5rem;">
          <span style="display:inline-block;width:10px;height:10px;background:var(--blue);border-radius:2px;"></span> Customer Lookup &amp; Filtered Export
        </div>
        <div class="card" style="margin-bottom:2rem;border-color:rgba(59,130,246,0.18);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-user-search" style="color:var(--blue);margin-right:0.4rem;"></i>Search &amp; Filter Customers</span>
            <span class="badge badge-blue">Any field</span>
          </div>
          <div class="card-body">
            <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;line-height:1.65;">Filter by name, email, country, ID, TRN, or address â€” then export only the matching rows.</p>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.65rem;margin-bottom:0.75rem;">
              <input class="form-input" id="exportSearch-name"    placeholder="Nameâ€¦"           oninput="filterExportTable()">
              <input class="form-input" id="exportSearch-email"   placeholder="Emailâ€¦"          oninput="filterExportTable()">
              <input class="form-input" id="exportSearch-id"      placeholder="CargoLink IDâ€¦"   oninput="filterExportTable()">
              <input class="form-input" id="exportSearch-country" placeholder="Countryâ€¦"        oninput="filterExportTable()">
              <input class="form-input" id="exportSearch-trn"     placeholder="TRN / National IDâ€¦" oninput="filterExportTable()">
              <input class="form-input" id="exportSearch-addr"    placeholder="City / Addressâ€¦" oninput="filterExportTable()">
            </div>
            <div style="display:flex;gap:0.65rem;margin-bottom:1.1rem;flex-wrap:wrap;align-items:center;">
              <button class="btn btn-ghost btn-sm" onclick="clearExportSearch()"><i class="ti ti-x"></i> Clear Filters</button>
              <div style="margin-left:auto;display:flex;gap:0.5rem;flex-wrap:wrap;">
                <button class="btn btn-green btn-sm" onclick="exportFilteredCustomers()"><i class="ti ti-download"></i> Export Filtered CSV</button>
                <button class="btn btn-amber btn-sm" onclick="exportAllCustomersFull()"><i class="ti ti-download"></i> Download All (Full)</button>
              </div>
            </div>
            <div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px;">
              <table class="tbl" id="exportCustomerTable">
                <thead>
                  <tr>
                    <th>CargoLink ID</th><th>Full Name</th><th>Email</th><th>Phone</th>
                    <th>Country</th><th>City</th><th>Address</th><th>TRN</th><th>Joined</th>
                  </tr>
                </thead>
                <tbody id="exportCustomerTableBody">
                  <tr><td colspan="9" style="text-align:center;color:var(--text-3);padding:2rem;">Customer list loads when you open this tab.</td></tr>
                </tbody>
              </table>
            </div>
            <div style="font-size:0.75rem;color:var(--text-3);margin-top:0.5rem;" id="exportResultCount"></div>
          </div>
        </div>

        <!-- â”€â”€ SECTION 2: CSV Downloads â”€â”€ -->
        <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.875rem;display:flex;align-items:center;gap:0.5rem;">
          <span style="display:inline-block;width:10px;height:10px;background:var(--green);border-radius:2px;"></span> Bulk CSV Downloads
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem;">

          <div class="card" style="border-color:rgba(16,185,129,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-users" style="color:var(--green);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">Customers</div>
                  <span style="font-size:0.62rem;background:rgba(16,185,129,0.1);color:var(--green);border:1px solid rgba(16,185,129,0.2);padding:1px 6px;border-radius:4px;font-weight:700;">.CSV</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.6;">CargoLink IDs, names, contacts, countries, addresses, join dates.</p>
              <button class="btn btn-green btn-sm" style="width:100%;" onclick="exportCSV('customers')"><i class="ti ti-download"></i> Download CSV</button>
            </div>
          </div>

          <div class="card" style="border-color:rgba(6,182,212,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-package" style="color:var(--cyan);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">All Shipments</div>
                  <span style="font-size:0.62rem;background:rgba(16,185,129,0.1);color:var(--green);border:1px solid rgba(16,185,129,0.2);padding:1px 6px;border-radius:4px;font-weight:700;">.CSV</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.6;">Every shipment with tracking #, customer, status, weight, type, declared value.</p>
              <button class="btn btn-green btn-sm" style="width:100%;" onclick="exportCSV('shipments')"><i class="ti ti-download"></i> Download CSV</button>
            </div>
          </div>

          <div class="card" style="border-color:rgba(139,92,246,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-receipt" style="color:var(--purple);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">All Invoices</div>
                  <span style="font-size:0.62rem;background:rgba(16,185,129,0.1);color:var(--green);border:1px solid rgba(16,185,129,0.2);padding:1px 6px;border-radius:4px;font-weight:700;">.CSV</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.6;">Full ledger â€” amounts, statuses, due dates, customer names.</p>
              <button class="btn btn-green btn-sm" style="width:100%;" onclick="exportCSV('invoices')"><i class="ti ti-download"></i> Download CSV</button>
            </div>
          </div>

        </div>

        <!-- â”€â”€ SECTION 3: Print / PDF Reports â”€â”€ -->
        <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.875rem;display:flex;align-items:center;gap:0.5rem;">
          <span style="display:inline-block;width:10px;height:10px;background:var(--amber);border-radius:2px;"></span> Branded Print Reports
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">

          <div class="card" style="border-color:rgba(245,158,11,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-report-analytics" style="color:var(--amber);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">Monthly Summary</div>
                  <span style="font-size:0.62rem;background:rgba(245,158,11,0.1);color:var(--amber);border:1px solid rgba(245,158,11,0.2);padding:1px 6px;border-radius:4px;font-weight:700;">PRINT / PDF</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.6;">Stats, top customers, status breakdown &amp; recent shipments in a branded report.</p>
              <button class="btn btn-amber btn-sm" style="width:100%;" onclick="printReport('summary')"><i class="ti ti-printer"></i> Open Report</button>
            </div>
          </div>

          <div class="card" style="border-color:rgba(245,158,11,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-file-description" style="color:var(--amber);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">Shipment Manifest</div>
                  <div style="font-size:0.65rem;background:rgba(245,158,11,0.1);color:var(--amber);border:1px solid rgba(245,158,11,0.2);padding:1px 6px;border-radius:4px;font-weight:700;margin-top:1px;display:inline-block;">PRINT / PDF</div>
                </div>
              </div>
            </div>
            <div class="card-body" style="padding:0.875rem 1.1rem;">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.875rem;line-height:1.6;">Official cargo manifest with signature lines, ref number, all active shipments.</p>
              <button class="btn btn-amber btn-sm" style="width:100%;" onclick="printReport('manifest')"><i class="ti ti-printer"></i> Open Manifest</button>
            </div>
          </div>

          <div class="card" style="border-color:rgba(245,158,11,0.18);">
            <div class="card-head">
              <div style="display:flex;align-items:center;gap:0.65rem;">
                <div style="width:34px;height:34px;border-radius:8px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="ti ti-user-circle" style="color:var(--amber);"></i>
                </div>
                <div>
                  <div class="card-title" style="font-size:0.9rem;">Customer Dossier</div>
                  <span style="font-size:0.62rem;background:rgba(245,158,11,0.1);color:var(--amber);border:1px solid rgba(245,158,11,0.2);padding:1px 6px;border-radius:4px;font-weight:700;">CSV OR PRINT</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size:0.8rem;color:var(--text-2);margin-bottom:0.75rem;line-height:1.6;">Full account report â€” profile, all shipments &amp; invoices for one customer.</p>
              <div style="display:flex;gap:0.5rem;">
                <button class="btn btn-amber btn-sm" style="flex:1;" onclick="openDossierModal('print')"><i class="ti ti-printer"></i> Print PDF</button>
                <button class="btn btn-ghost btn-sm" style="flex:1;" onclick="openDossierModal('csv')"><i class="ti ti-download"></i> CSV</button>
              </div>
            </div>
          </div>

        </div><!-- end print grid -->
      </div><!-- end atab-exports -->

      <!-- ADMIN STAFF & ROLES -->
      <div class="tab-content" id="atab-staff">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.75rem;flex-wrap:wrap;gap:1rem;">
          <div>
            <h2 style="font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:0.04em;">STAFF &amp; ROLES</h2>
            <p style="color:var(--text-2);font-size:0.875rem;margin-top:0.25rem;">Manage employee accounts and control exactly which tabs they can access.</p>
          </div>
          <button class="btn btn-amber btn-sm" onclick="openAddStaffModal()"><i class="ti ti-plus"></i> Add Employee</button>
        </div>

        <!-- Owner card -->
        <div class="card" style="max-width:700px;margin-bottom:1.5rem;border-color:rgba(245,158,11,0.25);">
          <div class="card-head">
            <span class="card-title"><i class="ti ti-crown" style="color:var(--amber);margin-right:0.35rem;"></i>Owner Account</span>
            <span class="badge badge-amber">ðŸ‘‘ Full Access</span>
          </div>
          <div class="card-body" style="display:flex;align-items:center;gap:1rem;">
            <div id="ownerAvatar" style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--amber),var(--amber-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#000;font-size:1.1rem;flex-shrink:0;">A</div>
            <div>
              <div style="font-weight:700;font-size:0.95rem;" id="staffOwnerName">Admin User</div>
              <div style="font-size:0.8rem;color:var(--text-2);" id="staffOwnerEmail">â€”</div>
              <div style="font-size:0.73rem;color:var(--text-3);margin-top:0.15rem;">Owner always has full access to every tab â€” cannot be restricted.</div>
            </div>
          </div>
        </div>

        <!-- Employee list -->
        <div style="max-width:700px;">
          <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.875rem;">Employees (<span id="staffCount">0</span>)</div>
          <div id="staffList"></div>
        </div>
      </div>

    </main>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURATION â€” UPDATE THESE VALUES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL      = 'https://fkjwlrijhkdhatgsrckf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrandscmlqaGtkaGF0Z3NyY2tmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTI2OTMsImV4cCI6MjA4NzI4ODY5M30._wSbRHh_tRUj4l2BAmwMWuxQ2KNj143g546eup1cJrU';
const EMAILJS_SERVICE_ID  = 'service_66t6ub9';         // EmailJS â†’ Email Services â†’ Service ID
const EMAILJS_TEMPLATE_WELCOME = 'template_invoice1'; // Reused for welcome emails (uses {{to_name}}, {{to_email}}, {{cargolink_id}}, {{warehouse_address}})
const EMAILJS_TEMPLATE_UPDATE  = 'template_invoice';  // Used for status updates, messages, AND replies
const EMAILJS_TEMPLATE_INVOICE = 'template_invoice1'; // Invoice notifications (uses {{to_name}}, {{to_email}}, {{invoice_id}}, {{amount}}, {{description}}, {{due_date}})
const EMAILJS_TEMPLATE_REPLY   = 'template_invoice';  // Admin replies reuse the update template
const EMAILJS_PUBLIC_KEY  = 'WyOChmnd_2q3rElM8';         // EmailJS â†’ Account â†’ Public Key
// Template variables: {{to_name}} {{to_email}} {{cargolink_id}} {{tracking_number}} {{status}} {{description}} {{note}} {{warehouse_address}}
const MIAMI_WAREHOUSE = '2210 NW 102nd Avenue\nMiami, FL 33172\nUnited States';

const DEMO_MODE = SUPABASE_URL.includes('YOUR_PROJECT') || SUPABASE_ANON_KEY.includes('YOUR_ANON');
let sb = null;
if (!DEMO_MODE) {
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{ persistSession:true, autoRefreshToken:true, storage:window.localStorage }
    });
  } catch(e) { console.warn('Supabase init failed:', e); sb = null; }
}

// EmailJS init
if (!EMAILJS_PUBLIC_KEY.includes('YOUR')) {
  emailjs.init(EMAILJS_PUBLIC_KEY);
}

// â”€â”€ State â”€â”€
let currentUser   = null;
let currentProfile = null;
let allShipments  = [];
let allInvoices   = [];
let allCustomers  = [];
let notifications = [];
let adminCharts   = {};
let selectedDelivery = 'door';
let regData = {};
let updateLog = [];
let bulkShipments = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const el  = id => document.getElementById(id);
const fmt$= v  => '$' + parseFloat(v||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
const fmtDate = d => d ? new Date(d).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}) : 'â€”';
const fmtDateTime = d => d ? new Date(d).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'â€”';

function toast(msg, type='info', icon='') {
  const icons = {success:'<i class="ti ti-circle-check"></i>',error:'<i class="ti ti-circle-x"></i>',info:'<i class="ti ti-info-circle"></i>'};
  const t = document.createElement('div');
  t.className = `toast-item toast-${type}`;
  t.innerHTML = (icons[type]||'') + msg;
  el('toast').appendChild(t);
  setTimeout(()=>t.remove(), 4500);
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const p = el('page-'+name);
  if(p) p.classList.add('active');
  window.scrollTo(0,0);
  // Init canvases
  if(name==='landing') setTimeout(initHeroCanvas, 50);
  if(name==='signin')  setTimeout(()=>initMiniCanvas('signInCanvas'),50);
  if(name==='signup')  setTimeout(()=>initMiniCanvas('signUpCanvas'),50);
}

function togglePass(id) {
  const inp = el(id);
  inp.type = inp.type==='password' ? 'text' : 'password';
}

function scrollToSection(sel) {
  document.querySelector(sel)?.scrollIntoView({behavior:'smooth'});
}

function genTrackingNum() {
  return `CCJ-${new Date().getFullYear()}-${String(Math.floor(Math.random()*99999+1)).padStart(5,'0')}`;
}

function genCargoId(n) {
  return 'CL-' + String(n).padStart(5,'0');
}

// warehouseAddress() is defined dynamically above using getWarehouseAddr()

function statusBadge(s) {
  const map = {
    pending:    ['badge-gray','<i class="ti ti-clock"></i> Pending'],
    received:   ['badge-blue','<i class="ti ti-package-import"></i> Received'],
    in_transit: ['badge-cyan','<i class="ti ti-plane"></i> In Transit'],
    customs:    ['badge-amber','<i class="ti ti-shield-check"></i> Customs'],
    ready:      ['badge-purple','<i class="ti ti-mailbox"></i> Ready for Pickup'],
    delivered:  ['badge-green','<i class="ti ti-circle-check"></i> Delivered'],
    cancelled:  ['badge-red','<i class="ti ti-x"></i> Cancelled'],
    unpaid:     ['badge-red','<i class="ti ti-credit-card"></i> Unpaid'],
    paid:       ['badge-green','<i class="ti ti-check"></i> Paid'],
  };
  const [cls,lbl] = map[s]||['badge-gray',s];
  return `<span class="badge ${cls}">${lbl}</span>`;
}

function statusLabel(s) {
  const labels = {pending:'Pending',received:'Received at Warehouse',in_transit:'In Transit',customs:'Customs Clearance',ready:'Ready for Pickup',delivered:'Delivered',cancelled:'Cancelled'};
  return labels[s]||s;
}

function drawBarcode(canvas, code) {
  if(!canvas) return;
  canvas.width=200; canvas.height=50;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,200,50);
  ctx.fillStyle='#000';
  let x=6;
  for(let i=0;i<code.length*3;i++){
    const w=(i%3===1)?1:2;
    if(i%2===0) ctx.fillRect(x,4,w,32);
    x+=w+1;
  }
  ctx.font='8px JetBrains Mono,monospace'; ctx.textAlign='center'; ctx.fillText(code,100,48);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WAREHOUSE ADDRESS â€” admin controlled, shared
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WAREHOUSE_STORAGE_KEY = 'caribcargo_warehouse_addr';

function getWarehouseAddr() {
  return localStorage.getItem(WAREHOUSE_STORAGE_KEY) || MIAMI_WAREHOUSE;
}

function setWarehouseAddr(addr) {
  localStorage.setItem(WAREHOUSE_STORAGE_KEY, addr);
}

// Override warehouseAddress() to use dynamic addr
function warehouseAddress(id, name) {
  return `${name}\nc/o CaribCargo â€” ${id}\n${getWarehouseAddr()}`;
}

function loadSettingsTab() {
  const addr = getWarehouseAddr();
  const addrEl = el('warehouse-addr-text');
  if(addrEl) addrEl.innerHTML = addr.replace(/\n/g,'<br>');
  const emailStatusEl = el('emailjs-status-display');
  if(emailStatusEl) {
    const configured = !EMAILJS_PUBLIC_KEY.includes('YOUR');
    emailStatusEl.innerHTML = `
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem;">
        <span style="color:${configured?'var(--green)':'var(--red)'};">${configured?'âœ“':'âœ—'}</span>
        <span>Service ID: <strong style="color:var(--text);">${configured ? EMAILJS_SERVICE_ID : 'Not configured'}</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem;">
        <span style="color:${configured?'var(--green)':'var(--red)'};">${configured?'âœ“':'âœ—'}</span>
        <span>Public Key: <strong style="color:var(--text);">${configured ? EMAILJS_PUBLIC_KEY.slice(0,12)+'â€¦' : 'Not configured'}</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <span style="color:var(--text-3);">â„¹</span>
        <span style="color:var(--text-3);">Templates: ${EMAILJS_TEMPLATE_WELCOME} Â· ${EMAILJS_TEMPLATE_UPDATE}</span>
      </div>`;
  }
}

function editWarehouseAddr() {
  const inp = el('warehouse-edit-input');
  if(inp) inp.value = getWarehouseAddr();
  el('warehouse-display').style.display = 'none';
  el('warehouse-edit').style.display = 'block';
  el('warehouse-edit-btns').style.display = 'none';
}

function cancelWarehouseEdit() {
  el('warehouse-display').style.display = 'block';
  el('warehouse-edit').style.display = 'none';
  el('warehouse-edit-btns').style.display = 'block';
}

function saveWarehouseAddr() {
  const newAddr = el('warehouse-edit-input')?.value?.trim();
  if(!newAddr) return toast('Address cannot be empty.','error');
  setWarehouseAddr(newAddr);
  cancelWarehouseEdit();
  loadSettingsTab();
  // Refresh any visible warehouse address displays
  const p = currentProfile;
  if(p) {
    const addr = warehouseAddress(p.cargolink_id||'CL-XXXXX', p.full_name||'Customer');
    ['warehouseAddress','addrTabWarehouse'].forEach(id=>{ if(el(id)) el(id).innerHTML=addr.replace(/\n/g,'<br>'); });
  }
  toast('âœ“ Warehouse address updated for all customers!','success');
}

function testEmailJSConfig() {
  if(EMAILJS_PUBLIC_KEY.includes('YOUR')) {
    toast('EmailJS not configured. Add your keys to the HTML file.','error');
    return;
  }
  toast('Sending test emailâ€¦','info');
  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_UPDATE, {
    to_name: 'Admin',
    to_email: currentProfile?.email||'admin@caribcargo.com',
    admin_message: 'This is a test email from CaribCargo admin. Your EmailJS integration is working correctly!',
  }).then(()=>toast('âœ“ Test email sent!','success'))
    .catch(e=>toast('Email failed: '+e.text,'error'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOMER PICKER (searchable dropdown)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cpickerData = {};  // namespace â†’ array of customers
let cpickerSelected = {}; // namespace â†’ selected customer

function populateCpicker(ns) {
  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  cpickerData[ns] = custs;
  renderCpickerList(ns, custs);
}

function renderCpickerList(ns, custs) {
  const list = el(ns+'-cpicker-list');
  if(!list) return;
  if(!custs.length) {
    list.innerHTML = '<div class="cpicker-empty">No customers found.</div>';
    return;
  }
  list.innerHTML = custs.map(c => {
    const initials = (c.full_name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    return `<div class="cpicker-item" onclick="selectCpicker('${ns}','${c.id}')">
      <div class="cpicker-item-avatar">${initials}</div>
      <div style="flex:1;min-width:0;">
        <div class="cpicker-item-name">${c.full_name||'â€”'}</div>
        <div class="cpicker-item-meta">
          <span class="cpicker-tag">${c.cargolink_id||'â€”'}</span>
          <span>${c.email||''}</span>
          ${c.country ? `<span>Â· ${c.country}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function filterCpicker(ns) {
  const q = (el(ns+'-cpicker-search')?.value||'').toLowerCase();
  const filtered = (cpickerData[ns]||[]).filter(c =>
    !q ||
    (c.full_name||'').toLowerCase().includes(q) ||
    (c.cargolink_id||'').toLowerCase().includes(q) ||
    (c.email||'').toLowerCase().includes(q)
  );
  renderCpickerList(ns, filtered);
}

function toggleCpicker(ns) {
  const dropdown = el(ns+'-cpicker-dropdown');
  const btn      = el(ns+'-cpicker-btn');
  if(!dropdown) return;
  const isOpen = dropdown.style.display !== 'none';
  // Close all pickers first
  document.querySelectorAll('[id$="-cpicker-dropdown"]').forEach(d=>d.style.display='none');
  document.querySelectorAll('[id$="-cpicker-btn"]').forEach(b=>b.classList.remove('open'));
  if(!isOpen) {
    dropdown.style.display = 'block';
    btn?.classList.add('open');
    populateCpicker(ns);
    setTimeout(()=>el(ns+'-cpicker-search')?.focus(), 50);
  }
}

function selectCpicker(ns, id) {
  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  const c = custs.find(x=>x.id===id);
  if(!c) return;
  cpickerSelected[ns] = c;

  // Set hidden fields based on namespace
  if(el(ns+'-customer-uuid')) el(ns+'-customer-uuid').value = c.id;
  if(el(ns+'-customer-email')) el(ns+'-customer-email').value = c.email||'';
  if(el(ns+'-customer-name')) el(ns+'-customer-name').value = c.full_name||'';
  if(el(ns+'-custid')) el(ns+'-custid').value = c.cargolink_id||'';
  if(el(ns+'-cust-uuid')) el(ns+'-cust-uuid').value = c.id;
  if(el(ns+'-cust-email')) el(ns+'-cust-email').value = c.email||'';
  if(el(ns+'-cust-name')) el(ns+'-cust-name').value = c.full_name||'';
  if(el(ns+'-customer-id')) el(ns+'-customer-id').value = c.id;

  // Update display
  const placeholder = el(ns+'-cpicker-placeholder');
  const selected    = el(ns+'-cpicker-selected');
  if(placeholder) placeholder.style.display = 'none';
  if(selected) {
    selected.style.display = 'flex';
    const initials = (c.full_name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    selected.innerHTML = `
      <div class="cpicker-item-avatar" style="width:24px;height:24px;font-size:0.6rem;">${initials}</div>
      <span class="cpicker-name">${c.full_name}</span>
      <span class="cpicker-tag">${c.cargolink_id||''}</span>`;
  }

  // Close dropdown
  el(ns+'-cpicker-dropdown').style.display = 'none';
  el(ns+'-cpicker-btn')?.classList.remove('open');

  // If invoice picker, also populate the tracking dropdown for this customer
  if(ns==='ci') populateTpickerForCustomer('ci', c.id);

  // If create shipment picker, show customer tag + tracking preview
  if(ns==='cs') {
    onCsCustomerSelected(c.id, c.full_name, c.cargolink_id);
    // Generate a preview tracking number (not final until submit)
    const previewEl = el('cs-tracking-preview');
    if(previewEl) {
      const preview = `CCJ-${new Date().getFullYear()}-${String(Math.floor(Math.random()*89999+10000))}`;
      previewEl.textContent = preview + ' (preview â€” changes on submit)';
    }
  }

  // If message picker, update preview
  if(ns==='msg') {
    const preview = el('msg-customer-preview');
    if(preview) {
      preview.style.display = 'block';
      preview.innerHTML = `<div class="badge badge-amber" style="font-size:0.72rem;">${c.cargolink_id}</div> <span style="font-size:0.82rem;color:var(--text-2);">${c.email||''}</span>`;
    }
  }

  // If edit profile picker, populate the edit form
  if(ns==='ep') selectEpCustomer(c);
}

// Close pickers when clicking outside
document.addEventListener('click', e => {
  if(!e.target.closest('[id$="-cpicker-wrap"]') && !e.target.closest('[id$="-cpicker-btn"]')) {
    document.querySelectorAll('[id$="-cpicker-dropdown"]').forEach(d=>d.style.display='none');
    document.querySelectorAll('[id$="-cpicker-btn"]').forEach(b=>b.classList.remove('open'));
  }
  if(!e.target.closest('.tpicker-wrap')) {
    document.querySelectorAll('.tpicker-dropdown').forEach(d=>d.style.display='none');
    document.querySelectorAll('.tpicker-wrap').forEach(w=>w.classList.remove('open'));
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACKING PICKER (autocomplete on input)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTpicker(ns) {
  const wrap = el(ns+'-tpicker-wrap');
  const dropdown = el(ns+'-tpicker-dropdown');
  if(!wrap||!dropdown) return;
  filterTpicker(ns);
  wrap.classList.add('open');
}

function filterTpicker(ns) {
  const input = el(ns+'-tracking')?.value?.trim().toUpperCase();
  const list  = el(ns+'-tpicker-list');
  const wrap  = el(ns+'-tpicker-wrap');
  if(!list||!wrap) return;

  // Get all shipments â€” admin context uses window._adminShipments
  const allShips = DEMO_MODE
    ? getDemoShipments(20)
    : (window._adminShipments || []);

  // For invoice picker, filter to selected customer's shipments
  const ns_custId = ns==='ci' ? el('ci-cust-uuid')?.value : null;
  let ships = allShips;
  if(ns_custId) ships = ships.filter(s=>s.customer_id===ns_custId||s.customer_id===ns_custId);
  if(input) ships = ships.filter(s=>s.tracking_number.includes(input)||(s.description||'').toUpperCase().includes(input));
  ships = ships.slice(0,12);

  if(!ships.length) {
    list.innerHTML = '<div style="padding:0.75rem;font-size:0.78rem;color:var(--text-3);">No shipments found.</div>';
    wrap.classList.add('open');
    return;
  }
  list.innerHTML = ships.map(s=>`
    <div class="tpicker-item" onclick="selectTpicker('${ns}','${s.tracking_number}','${s.id}')">
      <div>
        <div class="tpicker-item-trk">${s.tracking_number}</div>
        <div class="tpicker-item-cust">${s.profiles?.full_name||'â€”'} Â· ${s.description||'Package'} Â· ${statusLabel(s.status)}</div>
      </div>
      ${statusBadge(s.status)}
    </div>`).join('');
  wrap.classList.add('open');
}

function selectTpicker(ns, tracking, shipId) {
  const inp = el(ns+'-tracking');
  if(inp) inp.value = tracking;
  el(ns+'-tpicker-wrap')?.classList.remove('open');

  // Update customer preview for upd tab
  if(ns==='upd') {
    const allShips = DEMO_MODE ? getDemoShipments(20) : (window._adminShipments||[]);
    const s = allShips.find(x=>x.id===shipId);
    const preview = el('upd-cust-preview');
    if(s && preview) {
      preview.style.display = 'block';
      const custName = s.profiles?.full_name||'â€”';
      const custId   = s.profiles?.cargolink_id||'';
      preview.innerHTML = `
        <div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:8px;">
          <i class="ti ti-user" style="color:var(--amber);"></i>
          <span style="font-size:0.82rem;font-weight:600;">${custName}</span>
          <span class="cpicker-tag">${custId}</span>
          <span style="font-size:0.75rem;color:var(--text-3);">${s.profiles?.email||''}</span>
        </div>`;
    }
  }
}

function populateTpickerForCustomer(ns, custId) {
  // Pre-populate the tracking picker filtered to this customer's shipments
  const inp = el(ns+'-tracking');
  if(inp) { inp.value=''; inp.placeholder='Search this customer\'s shipmentsâ€¦'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â†’ SEND MESSAGE TO CUSTOMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let adminMsgLog = [];

async function sendAdminMessage() {
  const custId   = el('msg-customer-id')?.value;
  const title    = el('msg-title')?.value?.trim();
  const body     = el('msg-body')?.value?.trim();
  const sendEmail = el('msg-sendemail')?.checked;

  if(!custId)  return toast('Please select a customer.','error');
  if(!title)   return toast('Please add a message title.','error');
  if(!body)    return toast('Please write a message.','error');

  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  const cust  = custs.find(x=>x.id===custId);
  if(!cust) return toast('Customer not found.','error');

  const btn = document.querySelector('#atab-messages .btn-amber');
  if(btn){ btn.innerHTML='<div class="loader"></div> Sendingâ€¦'; btn.disabled=true; }

  // 1. Write to notifications table (shows on customer dashboard)
  if(!DEMO_MODE && sb) {
    const {error} = await sb.from('notifications').insert({
      customer_id: custId, title, message: body, read: false
    });
    if(error) {
      if(btn){ btn.innerHTML='<i class="ti ti-send"></i> Send Message'; btn.disabled=false; }
      return toast('Notification write failed: '+error.message,'error');
    }
  }

  // 2. Send email if requested
  if(sendEmail) {
    if(EMAILJS_PUBLIC_KEY.includes('YOUR')) {
      toast('Message saved to dashboard. (Add EmailJS keys to also send email)','info');
    } else {
      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_UPDATE, {
          to_name:       cust.full_name||'Customer',
          to_email:      cust.email,
          admin_message: body,
        });
        toast('âœ“ Message sent via dashboard + email!','success');
      } catch(e) {
        toast('Dashboard updated. Email failed: '+(e.text||e.message),'error');
      }
    }
  } else {
    toast('âœ“ Message delivered to customer dashboard!','success');
  }

  if(btn){ btn.innerHTML='<i class="ti ti-send"></i> Send Message'; btn.disabled=false; }

  // Log it
  adminMsgLog.unshift({ cust: cust.full_name, custTag: cust.cargolink_id, title, body, time: new Date(), emailed: sendEmail });
  renderMsgLog();

  // Clear form
  if(el('msg-title')) el('msg-title').value='';
  if(el('msg-body'))  el('msg-body').value='';
}

function renderMsgLog() {
  const c = el('msg-log'); if(!c) return;
  if(!adminMsgLog.length) {
    c.innerHTML='<div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">No messages sent yet this session.</div>';
    return;
  }
  c.innerHTML = adminMsgLog.map(m=>`
    <div class="update-log-item" style="padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);">
      <div class="update-log-dot" style="background:var(--amber);"></div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem;flex-wrap:wrap;">
          <span style="font-size:0.88rem;font-weight:700;">${m.cust}</span>
          <span class="cpicker-tag">${m.custTag}</span>
          ${m.emailed?'<span class="badge badge-blue" style="font-size:0.65rem;"><i class="ti ti-mail"></i> Emailed</span>':''}
        </div>
        <div style="font-size:0.85rem;font-weight:600;color:var(--text);">${m.title}</div>
        <div style="font-size:0.78rem;color:var(--text-2);margin-top:0.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.body}</div>
        <div style="font-size:0.68rem;color:var(--text-3);margin-top:0.25rem;">${fmtDateTime(m.time)}</div>
      </div>
    </div>`).join('');
}

function clearMsgLog() {
  adminMsgLog=[];
  renderMsgLog();
}

// â”€â”€ Quick Message Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MSG_TEMPLATES = {
  order_arrived: {
    title: 'ðŸ“¦ Your Package Has Arrived!',
    body: 'Great news! Your package has arrived at our warehouse and is ready for processing. You will receive another notification once it has been checked in and is ready for pickup or delivery. Thank you for choosing CaribCargo!'
  },
  in_transit: {
    title: 'ðŸš¢ Your Shipment Is On Its Way',
    body: 'Your shipment is currently in transit and on its way to you. You can track the latest status on your dashboard at any time. We will notify you as soon as it arrives. Thank you for your patience!'
  },
  customs_hold: {
    title: 'ðŸ›ƒ Customs Hold â€“ Action May Be Required',
    body: 'Your package is currently being held at customs for inspection. This is a routine process and may take a few additional business days. Please ensure your identification documents are ready. Contact us if you have any questions.'
  },
  ready_pickup: {
    title: 'âœ… Your Package Is Ready for Pickup',
    body: 'Your package is now available for pickup at our warehouse. Please bring a valid photo ID and your CaribCargo tracking number when you arrive. Our hours are Monâ€“Fri 9amâ€“5pm. See you soon!'
  },
  action_required: {
    title: 'âš ï¸ Action Required â€“ Please Contact Us',
    body: 'We need your attention regarding your recent shipment. Please log in to your dashboard or contact our team as soon as possible so we can resolve this quickly and get your package to you without further delay.'
  },
  general_update: {
    title: 'ðŸ“‹ Shipment Update from CaribCargo',
    body: 'Here is a quick update regarding your shipment. Please check your dashboard for the latest status. If you have any questions, feel free to reply to this message or contact our support team. Thank you!'
  }
};

function applyMsgTemplate(key, subjectId, bodyId) {
  const t = MSG_TEMPLATES[key]; if(!t) return;
  const sId = subjectId || 'msg-title';
  const bId = bodyId || 'msg-body';
  const sEl = el(sId); const bEl = el(bId);
  if(sEl) sEl.value = t.title;
  if(bEl) bEl.value = t.body;
  // Visual flash feedback
  [sEl, bEl].forEach(e => { if(!e) return; e.style.transition='background 0.3s'; e.style.background='rgba(245,158,11,0.08)'; setTimeout(()=>e.style.background='',600); });
}


async function loadAdminInbox() {
  const c = el('admin-inbox'); if(!c) return;
  c.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-3);">Loadingâ€¦</div>';
  if(DEMO_MODE) {
    c.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-3);font-size:0.84rem;">Demo mode â€” no real customer replies.</div>';
    return;
  }
  if(!sb) return;
  try {
    // Load notifications that are customer replies (title starts with [Customer Reply])
    const { data, error } = await sb.from('notifications')
      .select('*, profiles(full_name, cargolink_id, email)')
      .like('title', '[Customer Reply]%')
      .order('created_at', { ascending: false })
      .limit(50);
    if(error) throw error;
    const unread = (data||[]).filter(n=>!n.read).length;
    const badge = el('inboxUnreadBadge');
    if(badge) { badge.textContent = unread + ' new'; badge.style.display = unread > 0 ? 'inline-flex' : 'none'; }
    if(!data?.length) {
      c.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-3);font-size:0.84rem;">No customer replies yet.</div>';
      return;
    }
    c.innerHTML = '<div class="card-body" style="padding:0;">' + data.map(n=>`
      <div class="update-log-item" style="padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);${!n.read?'background:rgba(245,158,11,0.03);':''}">
        <div class="update-log-dot" style="background:${n.read?'var(--text-3)':'var(--amber)'};"></div>
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.25rem;">
            <span style="font-weight:700;font-size:0.88rem;">${n.profiles?.full_name||'Customer'}</span>
            <span style="font-size:0.72rem;color:var(--amber);font-family:monospace;">${n.profiles?.cargolink_id||''}</span>
            ${!n.read?'<span class="badge badge-amber" style="font-size:0.6rem;">New</span>':''}
          </div>
          <div style="font-size:0.85rem;font-weight:600;">${n.title.replace('[Customer Reply] ','')}</div>
          <div style="font-size:0.8rem;color:var(--text-2);margin-top:0.15rem;">${n.message}</div>
          <div style="font-size:0.68rem;color:var(--text-3);margin-top:0.2rem;">${fmtDateTime(n.created_at)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.35rem;flex-shrink:0;">
          ${n.profiles?.email ? '<button class="btn btn-blue btn-sm" onclick="emailCustomerDirect(\''+( n.profiles.email||'')+'\',\''+((n.profiles.full_name||'').replace(/'/g,''))+'\')"><i class="ti ti-mail"></i> Reply</button>' : ''}
          ${!n.read ? '<button class="btn btn-ghost btn-sm" onclick="markInboxRead(\''+n.id+'\', this)"><i class="ti ti-check"></i> Mark Read</button>' : ''}
        </div>
      </div>`).join('') + '</div>';
  } catch(e) {
    c.innerHTML = '<div style="padding:1.5rem;color:var(--red);font-size:0.84rem;">Error loading inbox: ' + e.message + '</div>';
  }
}

async function markInboxRead(notifId, btn) {
  if(!sb) return;
  await sb.from('notifications').update({ read: true }).eq('id', notifId);
  if(btn) btn.closest('.update-log-item').style.background = '';
  btn?.remove();
  loadAdminInbox();
}

function emailCustomerDirect(email, name) {
  // Pre-fill the email customer modal
  const fakeId = allCustomers?.find(c=>c.email===email)?.id;
  if(fakeId) { emailCustomer(fakeId); return; }
  // Fallback: open compose with mailto
  const m = document.createElement('div');
  m.className = 'modal-overlay'; m.onclick = e => { if(e.target===m) m.remove(); };
  m.innerHTML = `<div class="modal-box">
    <div class="modal-head"><span class="modal-title">REPLY TO ${name||email}</span>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
    </div>
    <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;">To: <strong style="color:var(--text);">${email}</strong></p>
    <div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="em-subject" value="Reply from CaribCargo"></div>
    <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="em-body" rows="5" style="resize:vertical;" placeholder="Type your replyâ€¦"></textarea></div>
    <button class="btn btn-amber" style="width:100%;" id="emSendBtn" onclick="sendDirectEmail('${email}','${name}')"><i class="ti ti-mail"></i> Send Reply</button>
  </div>`;
  el('modals').appendChild(m);
}

async function sendDirectEmail(email, name) {
  const subject = el('em-subject')?.value?.trim();
  const body    = el('em-body')?.value?.trim();
  if(!body) return toast('Please write a message.','error');
  const btn = el('emSendBtn');
  if(btn){btn.innerHTML='<div class="loader"></div> Sendingâ€¦';btn.disabled=true;}
  if(EMAILJS_PUBLIC_KEY.includes('YOUR')) {
    await new Promise(r=>setTimeout(r,600));
    if(btn){btn.innerHTML='<i class="ti ti-mail"></i> Send Reply';btn.disabled=false;}
    document.querySelector('.modal-overlay')?.remove();
    toast('Email sent (add EmailJS keys to go live)','info');
    return;
  }
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_REPLY, { to_name: name, to_email: email, admin_message: body });
    document.querySelector('.modal-overlay')?.remove();
    toast('âœ“ Reply sent to '+email,'success');
  } catch(e) {
    if(btn){btn.innerHTML='<i class="ti ti-mail"></i> Send Reply';btn.disabled=false;}
    toast('Email failed: '+(e.text||e.message),'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMAILJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendWelcomeEmail(profile) {
  if(EMAILJS_PUBLIC_KEY.includes('YOUR')) return;
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_WELCOME, {
      to_name:       profile.full_name,
      to_email:      profile.email,
      admin_message: 'Welcome to CaribCargo! Your account is ready.\n\nYour CaribCargo ID: ' + profile.cargolink_id + '\n\nUse this ID when shipping packages to our warehouse. You can log in at any time to track your shipments and view invoices.\n\nThank you for choosing CaribCargo!',
    });
    console.log('Welcome email sent');
  } catch(e) { console.warn('Email failed:', e); }
}

async function sendStatusEmail(profile, ship, newStatus, note='') {
  if(EMAILJS_PUBLIC_KEY.includes('YOUR')) return;
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_UPDATE, {
      to_name:       profile.full_name,
      to_email:      profile.email,
      admin_message: 'Your shipment status has been updated.\n\nTracking #: ' + ship.tracking_number + '\nPackage: ' + (ship.description||'Package') + '\nStatus: ' + statusLabel(newStatus) + (note ? '\n\nNote: ' + note : '') + '\n\nLog in to your dashboard to view full details.',
    });
    console.log('Status email sent');
  } catch(e) { console.warn('Email failed:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkSession() {
  if(DEMO_MODE || !sb) { updateNavForGuest(); return; }
  // Listen for future auth changes (sign out, token refresh, password recovery etc)
  sb.auth.onAuthStateChange(async(ev, session) => {
    if(ev === 'SIGNED_OUT') {
      currentUser=null; currentProfile=null;
      showPage('landing'); updateNavForGuest();
    }
    if(ev === 'PASSWORD_RECOVERY') {
      // Close any existing modal, show reset form
      document.querySelectorAll('.modal-overlay').forEach(m=>m.remove());
      showPage('signin');
      updateNavForGuest();
      openResetPasswordModal();
    }
    // SIGNED_IN here would double-trigger on page load â€” handled below instead
  });

  // â”€â”€ CHECK FOR PASSWORD RECOVERY IN URL â”€â”€
  // If the URL contains type=recovery (Supabase implicit flow), intercept before normal login
  const hashParams = new URLSearchParams(window.location.hash.replace('#',''));
  if(hashParams.get('type') === 'recovery') {
    showPage('signin');
    updateNavForGuest();
    // Let Supabase process the recovery token from the hash
    try {
      const { data, error } = await sb.auth.getSession();
      if(!error && data?.session) {
        // Clear the hash to clean up URL
        history.replaceState(null, '', window.location.pathname + window.location.search);
        openResetPasswordModal();
      } else {
        toast('Reset link expired or invalid. Please request a new one.','error');
      }
    } catch(e) {
      toast('Error processing reset link: ' + e.message,'error');
    }
    return; // Don't do normal session check
  }

  // Check if already logged in from a previous session
  try {
    const { data, error } = await sb.auth.getSession();
    if(error) { console.warn('getSession error:', error); updateNavForGuest(); return; }
    const session = data?.session;
    if(session?.user) {
      currentUser = session.user;
      // Immediately hide Sign In â€” user IS authenticated
      updateNavLoading();
      await loadProfile();
    } else {
      updateNavForGuest();
    }
  } catch(e) {
    console.warn('Session check error:', e);
    updateNavForGuest();
  }
}

async function loadProfile() {
  if(!sb || !currentUser) return;
  try {
    const { data, error } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(error) {
      // Table does not exist yet
      if(error.message?.includes('relation') || error.message?.includes('does not exist') || error.code === '42P01') {
        toast('âš ï¸ Database tables not found. Please run the SQL setup script in Supabase SQL Editor.', 'error');
        updateNavAuthError(); return;
      }
      if(error.code === 'PGRST116') {
        toast('Account exists but profile not found. Run the admin INSERT in Supabase.', 'error');
        updateNavAuthError(); return;
      }
      throw error;
    }
    if(!data) { updateNavAuthError(); return; }
    currentProfile = data;
    if(data.role === 'admin') {
      showPage('admin'); updateNavForAdmin(); await refreshAdmin();
    } else if(data.role === 'employee') {
      // Employee: load staff permissions from localStorage (set by admin on this device)
      // OR use embedded perms stored on profile if available
      const staffList = JSON.parse(localStorage.getItem('cc_staff')||'[]');
      const me = staffList.find(s=>s.email===data.email);
      if(me) {
        currentProfile._isEmployee = true;
        currentProfile._employeePerms = me.perms;
      } else {
        // No local staff record â€” grant default read-only tabs
        currentProfile._isEmployee = true;
        currentProfile._employeePerms = {overview:true, shipments:true, customers:true};
      }
      showPage('admin'); updateNavForEmployee(); await refreshAdmin();
    } else {
      showPage('customer'); updateNavForCustomer(); await loadCustomerData();
    }
  } catch(e) {
    console.warn('loadProfile error:', e);
    toast('Profile error: ' + (e.message||'Unknown error') + ' â€” check Supabase RLS (re-run SQL setup)', 'error');
    // Keep sign-out visible â€” user IS authenticated even if profile load failed
    updateNavAuthError();
  }
}

function updateNavLoading() {
  el('topnavLinks').innerHTML = '';
  el('topnavRight').innerHTML = `
    <span style="font-size:0.83rem;color:var(--text-2);">Loadingâ€¦</span>
    <button class="btn btn-ghost btn-sm" onclick="signOut()">Sign Out</button>
  `;
}

function updateNavAuthError() {
  el('topnavLinks').innerHTML = '';
  el('topnavRight').innerHTML = `
    <span style="font-size:0.8rem;color:var(--red);"><i class="ti ti-alert-circle"></i> Profile error</span>
    <button class="btn btn-ghost btn-sm" onclick="signOut()">Sign Out</button>
  `;
}

function updateNavForGuest() {
  el('topnavLinks').innerHTML = `
    <div class="nav-link" onclick="scrollToSection('.section-how')">How It Works</div>
    <div class="nav-link" onclick="scrollToSection('.section-services')">Services</div>
    <div class="nav-link" onclick="scrollToSection('.section-rates')">Rates</div>
    <div class="nav-link" onclick="scrollToSection('.section-track')">Track</div>
  `;
  el('topnavRight').innerHTML = `
    <button class="btn btn-ghost btn-sm" onclick="showPage('signin')">Sign In</button>
    <button class="btn btn-amber btn-sm" onclick="showPage('signup')">Get Started â†’</button>
  `;
}

function updateNavForCustomer() {
  const name = currentProfile?.full_name?.split(' ')[0]||'Customer';
  el('topnavLinks').innerHTML = '';
  el('topnavRight').innerHTML = `
    <span style="font-size:0.83rem;color:var(--text-2);">Hello, <strong style="color:var(--text);">${name}</strong></span>
    <button class="btn btn-ghost btn-sm" onclick="signOut()">Sign Out</button>
  `;
}

function updateNavForAdmin() {
  el('topnavLinks').innerHTML = '';
  el('topnavRight').innerHTML = `
    <span class="badge badge-red"><i class="ti ti-shield"></i> ADMIN</span>
    <button class="btn btn-ghost btn-sm" onclick="signOut()">Sign Out</button>
  `;
  // Show owner crown in sidebar
  const crownBadge = el('ownerCrownBadge');
  if(crownBadge) crownBadge.style.display='inline';
  // Show rates edit button on landing page
  const rateBtn = el('rateEditBtn');
  if(rateBtn) rateBtn.style.display='block';
}

function updateNavForEmployee() {
  const name = currentProfile?.full_name?.split(' ')[0]||'Staff';
  el('topnavLinks').innerHTML = '';
  el('topnavRight').innerHTML = `
    <span class="badge badge-blue"><i class="ti ti-user-check"></i> STAFF</span>
    <span style="font-size:0.83rem;color:var(--text-2);">${name}</span>
    <button class="btn btn-ghost btn-sm" onclick="signOut()">Sign Out</button>
  `;
  // Hide owner-only sidebar items for employees
  const dataItem = el('aitem-data');
  if(dataItem) dataItem.style.display = 'none';
  const staffItem = el('aitem-staff');
  if(staffItem) staffItem.style.display = 'none';
}

async function signOut() {
  if(sb) await sb.auth.signOut();
  currentUser=null; currentProfile=null; allShipments=[]; allInvoices=[];
  showPage('landing'); updateNavForGuest();
  toast('Signed out successfully.','info');
}

async function doLogin() {
  const email = (el('si-email')?.value||'').trim().toLowerCase();
  const pass  = el('si-pass')?.value||'';
  if(!email||!pass) return toast('Please enter your email and password.','error');

  const btn = el('loginBtn');
  btn.innerHTML='<div class="loader"></div> Signing Inâ€¦'; btn.disabled=true;

  if(DEMO_MODE) {
    await new Promise(r=>setTimeout(r,700));
    if(email==='admin@caribcargo.com'&&pass==='admin123') {
      currentUser={id:'admin-demo',email};
      currentProfile={id:'admin-demo',full_name:'Admin User',role:'admin',cargolink_id:'ADMIN',email};
      btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
      showPage('admin'); updateNavForAdmin(); await refreshAdmin();
    } else {
      currentUser={id:'demo-user',email};
      currentProfile={id:'demo-user',full_name:'Sarah Brown',cargolink_id:'CL-00001',role:'customer',email,phone:'+1 (876) 555-0110',country:'Jamaica',region:'Kingston',addr1:'45 Dunrobin Ave',city:'Kingston',postal:'JA-001'};
      btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
      showPage('customer'); updateNavForCustomer(); await loadCustomerData();
    }
    toast('Welcome to CaribCargo!','success');
    return;
  }

  // â”€â”€ LIVE SUPABASE MODE â”€â”€
  if(!sb) { btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false; return toast('Supabase not initialized. Check your API keys.','error'); }
  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if(error) throw error;
    // Success â€” immediately update nav to hide Sign In, then load profile
    currentUser = data.user;
    updateNavLoading();
    await loadProfile();
    btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
  } catch(e) {
    btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
    const msg = e.message || 'Login failed.';
    if(msg.includes('Invalid login') || msg.includes('invalid_credentials')) {
      toast('Incorrect email or password. Please try again.','error');
    } else if(msg.includes('Email not confirmed') || msg.includes('email_not_confirmed')) {
      toast('Please check your email inbox and click the confirmation link first.','error');
    } else if(msg.includes('security purposes') || msg.includes('seconds') || msg.includes('rate') || msg.includes('429')) {
      toast('Too many attempts â€” please wait 60 seconds then try again.','error');
    } else if(msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.includes('fetch')) {
      toast('Connection error. Check your internet and try again.','error');
    } else {
      toast('Login error: ' + msg, 'error');
    }
    const helpBox = el('login-help');
    if(helpBox) helpBox.style.display = 'block';
  }
}

async function demoLogin(role) {
  // Completely bypasses Supabase - pure local demo, never hits the API
  const btn = el('loginBtn');
  if(btn){ btn.innerHTML='<div class="loader"></div> Loading Demoâ€¦'; btn.disabled=true; }
  await new Promise(r=>setTimeout(r,700));
  if(role==='admin') {
    currentUser    = { id:'demo-admin', email:'admin@caribcargo.com' };
    currentProfile = { id:'demo-admin', full_name:'Admin User', role:'admin', cargolink_id:'ADMIN', email:'admin@caribcargo.com' };
    if(btn){ btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false; }
    showPage('admin'); updateNavForAdmin(); await refreshAdmin();
  } else {
    currentUser    = { id:'demo-user', email:'demo@caribcargo.com' };
    currentProfile = { id:'demo-user', full_name:'Sarah Brown', cargolink_id:'CL-00001', role:'customer',
      email:'demo@caribcargo.com', phone:'+1 (876) 555-0110', country:'Jamaica',
      region:'Kingston', addr1:'45 Dunrobin Ave', city:'Kingston', postal:'JA-001' };
    if(btn){ btn.innerHTML='Sign In <i class="ti ti-arrow-right"></i>'; btn.disabled=false; }
    showPage('customer'); updateNavForCustomer(); await loadCustomerData();
  }
  toast('Welcome! (Demo Mode â€” no real data)', 'success');
}

function forgotPassword() {
  const email = el('si-email')?.value?.trim();
  if(!email) return toast('Enter your email address first.','info');
  if(!DEMO_MODE&&sb) {
    const redirectTo = window.location.origin + window.location.pathname + '#reset-password';
    sb.auth.resetPasswordForEmail(email, { redirectTo }).then(({error})=>{
      if(error) toast('Error: '+error.message,'error');
      else toast('Reset link sent to '+email+' â€” check your inbox!','success');
    });
  } else {
    toast('Password reset email sent (demo mode)','info');
  }
}

function openResetPasswordModal() {
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.id = 'resetModal';
  m.innerHTML = `
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title">SET NEW PASSWORD</span>
      </div>
      <p style="font-size:0.875rem;color:var(--text-2);margin-bottom:1.25rem;line-height:1.6;">
        Enter your new password below. Make sure it's at least 8 characters.
      </p>
      <div class="form-group">
        <label class="form-label">New Password</label>
        <div style="position:relative;">
          <input class="form-input" id="rp-pass" type="password" placeholder="New password (8+ chars)" style="padding-right:3rem;">
          <button onclick="togglePass('rp-pass')" style="position:absolute;right:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-3);font-size:0.9rem;"><i class="ti ti-eye"></i></button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm New Password</label>
        <input class="form-input" id="rp-pass2" type="password" placeholder="Repeat new password" onkeydown="if(event.key==='Enter')doResetPassword()">
      </div>
      <button class="btn btn-amber" style="width:100%;padding:0.875rem;" id="resetPwBtn" onclick="doResetPassword()">
        Save New Password <i class="ti ti-check"></i>
      </button>
    </div>`;
  el('modals').appendChild(m);
}

async function doResetPassword() {
  const pass  = el('rp-pass')?.value || '';
  const pass2 = el('rp-pass2')?.value || '';
  if(pass.length < 8) return toast('Password must be at least 8 characters.','error');
  if(pass !== pass2)  return toast('Passwords do not match.','error');
  const btn = el('resetPwBtn');
  btn.innerHTML='<div class="loader"></div> Savingâ€¦'; btn.disabled=true;
  const { error } = await sb.auth.updateUser({ password: pass });
  btn.innerHTML='Save New Password <i class="ti ti-check"></i>'; btn.disabled=false;
  if(error) return toast('Error: '+error.message,'error');
  document.getElementById('resetModal')?.remove();
  history.replaceState(null,'',window.location.pathname + window.location.search);
  toast('âœ“ Password updated! You can now sign in.','success');
  showPage('signin');
}

// â”€â”€ MULTI-STEP REGISTRATION â”€â”€
function updateRegionFields() {
  const country = el('r-country')?.value||'';
  const wrap = el('region-field');
  if(!wrap) return;
  const jamaicaParishes = ['Kingston','St. Andrew','St. Thomas','Portland','St. Mary','St. Ann','Trelawny','St. James','Hanover','Westmoreland','St. Elizabeth','Manchester','Clarendon','St. Catherine'];

  if(country==='Jamaica') {
    wrap.style.display='block';
    wrap.innerHTML=`<div class="form-group"><label class="form-label">Parish *</label><select class="form-select" id="r-region"><option value="">Select parishâ€¦</option>${jamaicaParishes.map(p=>`<option>${p}</option>`).join('')}</select></div>`;
  } else if(['United States','Canada'].includes(country)) {
    wrap.style.display='block';
    wrap.innerHTML=`<div class="form-group"><label class="form-label">${country==='United States'?'State':'Province'}</label><input class="form-input" id="r-region" placeholder="${country==='United States'?'Florida':'Ontario'}"></div>`;
  } else if(country) {
    wrap.style.display='block';
    wrap.innerHTML=`<div class="form-group"><label class="form-label">Region / District</label><input class="form-input" id="r-region" placeholder="Region (optional)"></div>`;
  } else { wrap.style.display='none'; wrap.innerHTML=''; }
}

function selectDelivery(mode) {
  selectedDelivery = mode;
  ['pickup','door'].forEach(m=>{
    const opt = el('dopt-'+m);
    if(m===mode) {
      opt.style.borderColor='var(--amber)'; opt.style.background='rgba(245,158,11,0.05)';
      opt.querySelector('i').style.color='var(--amber)';
    } else {
      opt.style.borderColor='var(--border-2)'; opt.style.background='';
      opt.querySelector('i').style.color='var(--text-2)';
    }
  });
}

function regStep(step) {
  // Validate before advancing
  if(step===2) {
    const email = el('r-email')?.value?.trim();
    const pass  = el('r-pass')?.value||'';
    const pass2 = el('r-pass2')?.value||'';
    if(!email||!pass) return toast('Please fill in email and password.','error');
    if(!/\S+@\S+\.\S+/.test(email)) return toast('Please enter a valid email.','error');
    if(pass.length<8) return toast('Password must be at least 8 characters.','error');
    if(pass!==pass2) return toast('Passwords do not match.','error');
    regData.email=email; regData.pass=pass;
  }
  if(step===3) {
    const fname = el('r-fname')?.value?.trim();
    const lname = el('r-lname')?.value?.trim();
    const phone = el('r-phone')?.value?.trim();
    const country = el('r-country')?.value;
    if(!fname||!lname||!phone||!country) return toast('Please fill in all required fields.','error');
    regData.fname=fname; regData.lname=lname; regData.phone=phone;
    regData.country=country; regData.trn=el('r-trn')?.value?.trim()||'';
    regData.region=el('r-region')?.value?.trim()||'';
  }

  [1,2,3].forEach(i=>{
    el('reg-step'+i).style.display = i===step?'block':'none';
    const numEl=el('si'+i+'-num'), lblEl=el('si'+i+'-lbl');
    if(i<step){numEl.className='step-ind-num done';numEl.innerHTML='âœ“';lblEl.className='step-ind-label done';}
    else if(i===step){numEl.className='step-ind-num active';numEl.innerHTML=i;lblEl.className='step-ind-label active';}
    else{numEl.className='step-ind-num';numEl.innerHTML=i;lblEl.className='step-ind-label';}
    if(i<3){const l=el('si-line'+i);if(l)l.className='step-ind-line'+(i<step?' done':'');}
  });
}

// Password strength
document.addEventListener('input', e=>{
  if(e.target.id==='r-pass') {
    const v=e.target.value; const wrap=el('pass-strength'); if(!wrap)return;
    let score=0;
    if(v.length>=8)score++;if(/[A-Z]/.test(v))score++;if(/[0-9]/.test(v))score++;if(/[^A-Za-z0-9]/.test(v))score++;
    const colors=['','var(--red)','var(--amber)','var(--amber)','var(--green)'];
    const labels=['','Weak','Fair','Good','Strong'];
    wrap.innerHTML=v?`<div class="progress-bar" style="margin-bottom:0.25rem;"><div class="progress-fill" style="width:${score*25}%;background:${colors[score]};"></div></div><div style="font-size:0.72rem;color:${colors[score]};">${labels[score]}</div>`:'';
  }
});

async function doRegister() {
  const addr1 = el('r-addr1')?.value?.trim();
  const city  = el('r-city')?.value?.trim();
  if(!addr1||!city) return toast('Please fill in your delivery address.','error');

  regData.addr1=addr1; regData.addr2=el('r-addr2')?.value?.trim()||'';
  regData.city=city; regData.regionAddr=el('r-region-addr')?.value?.trim()||'';
  regData.postal=el('r-postal')?.value?.trim()||''; regData.delivery=selectedDelivery;

  const btn=el('regSubmitBtn');
  btn.innerHTML='<div class="loader"></div> Creating Accountâ€¦'; btn.disabled=true;

  if(DEMO_MODE) {
    await new Promise(r=>setTimeout(r,900));
    const newId=genCargoId(Math.floor(Math.random()*9999+100));
    currentUser={id:'demo-new',email:regData.email};
    currentProfile={id:'demo-new',full_name:`${regData.fname} ${regData.lname}`,cargolink_id:newId,role:'customer',
      email:regData.email,phone:regData.phone,country:regData.country,trn:regData.trn,
      addr1:regData.addr1,addr2:regData.addr2,city:regData.city,region:regData.regionAddr||regData.region,postal:regData.postal,delivery:regData.delivery};
    btn.innerHTML='Create Account <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
    showPage('customer'); updateNavForCustomer(); await loadCustomerData();
    toast(`ðŸŽ‰ Account created! Your ID: ${newId}`,'success');
    // Would send email in production
    return;
  }

  if(!sb) return toast('Supabase not initialized.','error');
  try {
    const { data:authData, error:authErr } = await sb.auth.signUp({
      email: regData.email, password: regData.pass,
      options:{ data:{ full_name:`${regData.fname} ${regData.lname}` } }
    });
    if(authErr) throw authErr;
    if(!authData.user) throw new Error('Account creation failed. Please try again.');

    const { count } = await sb.from('profiles').select('*', {count:'exact', head:true});
    const cargoId = genCargoId((count||0)+1);

    const profile = {
      id: authData.user.id, email: regData.email,
      full_name: `${regData.fname} ${regData.lname}`,
      phone: regData.phone, trn: regData.trn, country: regData.country, region: regData.region,
      addr1: regData.addr1, addr2: regData.addr2, city: regData.city,
      region_addr: regData.regionAddr, postal: regData.postal,
      delivery_pref: regData.delivery, cargolink_id: cargoId, role: 'customer'
    };

    const { error: profErr } = await sb.from('profiles').upsert(profile);
    if(profErr) throw profErr;

    await sendWelcomeEmail({ ...profile });
    toast(`ðŸŽ‰ Account created! Your CaribCargo ID: ${cargoId}`, 'success');
    // If email confirmation required, let them know
    if(authData.session === null) {
      toast('Please check your email to confirm your account before signing in.', 'info');
    }
  } catch(e) {
    const msg = e.message || 'Registration failed.';
    if(msg.includes('already registered')) toast('An account with this email already exists.','error');
    else toast(msg, 'error');
  } finally {
    btn.innerHTML='Create Account <i class="ti ti-arrow-right"></i>'; btn.disabled=false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function heroTrack() {
  const num=(el('heroTrackInput')?.value||'').trim().toUpperCase();
  if(!num) return;
  const result = await fetchTrackingInfo(num);
  renderTrackResult(el('heroTrackResult'), result);
}

async function trackPublic() {
  const num=(el('pubTrackInput')?.value||'').trim().toUpperCase();
  if(!num) return;
  const result=await fetchTrackingInfo(num);
  renderTrackResult(el('pubTrackResult'),result);
}

async function dashTrack() {
  const num=(el('dashTrackInput')?.value||'').trim().toUpperCase();
  if(!num) return;
  const result=await fetchTrackingInfo(num);
  renderTrackResult(el('dashTrackResult'),result);
}

async function fetchTrackingInfo(num) {
  if(DEMO_MODE) return getDemoShipments(10).find(s=>s.tracking_number===num)||null;
  const {data}=await sb.from('shipments').select('*,profiles(full_name,cargolink_id)').eq('tracking_number',num).single();
  return data;
}

function renderTrackResult(container, ship) {
  if(!ship) {
    container.innerHTML=`
      <div style="display:flex;flex-direction:column;align-items:center;padding:2.5rem 1rem;text-align:center;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:var(--radius);">
        <div style="width:56px;height:56px;border-radius:50%;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);display:flex;align-items:center;justify-content:center;margin-bottom:1rem;">
          <i class="ti ti-search-off" style="font-size:1.5rem;color:var(--red);"></i>
        </div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:0.05em;margin-bottom:0.4rem;">TRACKING NUMBER NOT FOUND</div>
        <div style="font-size:0.84rem;color:var(--text-2);">Double-check the number and try again. Format: CCJ-YYYY-XXXXX</div>
      </div>`;
    return;
  }

  const steps = [
    { key:'pending',    label:'Order Placed',         sub:'Shipment registered in our system',          icon:'ti-file-invoice',    color:'var(--text-3)' },
    { key:'received',   label:'Received at Warehouse', sub:'Package arrived at Miami hub',               icon:'ti-package-import',  color:'var(--blue)' },
    { key:'in_transit', label:'In Transit',            sub:'En route to Caribbean destination',          icon:'ti-plane',           color:'var(--cyan)' },
    { key:'customs',    label:'Customs Clearance',     sub:'Being processed by customs authorities',     icon:'ti-shield-check',    color:'var(--amber)' },
    { key:'ready',      label:'Ready for Pickup',      sub:'Available at depot or out for delivery',     icon:'ti-mailbox',         color:'var(--purple)' },
    { key:'delivered',  label:'Delivered',             sub:'Package successfully delivered',             icon:'ti-circle-check',    color:'var(--green)' },
  ];

  const curIdx = steps.findIndex(s=>s.key===ship.status);
  const pct = curIdx < 0 ? 0 : Math.round((curIdx / (steps.length - 1)) * 100);

  const etaMap = {
    pending:'Awaiting warehouse receipt', received:'Processing â€” 1-2 days',
    in_transit:'Est. 5-14 business days', customs:'Est. 1-3 business days clearance',
    ready:'Ready now â€” contact us to arrange', delivered:'Delivered âœ“'
  };

  container.innerHTML=`
    <div style="border:1px solid var(--border-2);border-radius:20px;overflow:hidden;background:linear-gradient(145deg,rgba(255,255,255,0.04),rgba(255,255,255,0.015));">

      <!-- Header bar -->
      <div style="padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
        <div>
          <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-3);margin-bottom:0.3rem;">Tracking Number</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:700;color:var(--amber);letter-spacing:0.05em;">${ship.tracking_number}</div>
        </div>
        <div style="text-align:right;">
          ${statusBadge(ship.status)}
          <div style="font-size:0.75rem;color:var(--text-3);margin-top:0.4rem;">${etaMap[ship.status]||'â€”'}</div>
        </div>
      </div>

      <!-- Package info row -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);border-bottom:1px solid var(--border);">
        ${[
          ['<i class="ti ti-package"></i> Contents', ship.description||'Package'],
          ['<i class="ti ti-scale"></i> Weight',      (ship.weight ? ship.weight+' kg' : 'â€”')],
          ['<i class="ti ti-truck"></i> Service',     ship.ship_type||'General Cargo']
        ].map(([lbl,val])=>`
          <div style="padding:0.875rem 1.25rem;border-right:1px solid var(--border);">
            <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);margin-bottom:0.25rem;">${lbl}</div>
            <div style="font-size:0.88rem;font-weight:600;">${val}</div>
          </div>`).join('')}
      </div>

      <!-- Progress bar -->
      <div style="padding:1.25rem 1.5rem 0;border-bottom:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.6rem;">
          <span style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-3);">Shipment Progress</span>
          <span style="font-size:0.75rem;font-weight:700;color:var(--amber);">${pct}%</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;margin-bottom:1.25rem;">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--blue),var(--amber));border-radius:3px;transition:width 0.6s ease;"></div>
        </div>
      </div>

      <!-- Timeline steps -->
      <div style="padding:1.25rem 1.5rem;">
        <div style="display:flex;flex-direction:column;gap:0;">
          ${steps.map((s,i) => {
            const isDone = i < curIdx;
            const isNow  = i === curIdx;
            const isPend = i > curIdx;
            const dotColor = isDone ? 'var(--green)' : isNow ? s.color : 'rgba(255,255,255,0.1)';
            const dotBorder = isDone ? 'var(--green)' : isNow ? s.color : 'rgba(255,255,255,0.12)';
            const lineColor = i < curIdx ? 'var(--green)' : 'rgba(255,255,255,0.06)';
            return `
              <div style="display:flex;gap:1rem;align-items:flex-start;">
                <div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;">
                  <div style="width:32px;height:32px;border-radius:50%;border:2px solid ${dotBorder};background:${isDone?'rgba(16,185,129,0.15)':isNow?'rgba(245,158,11,0.1)':'rgba(255,255,255,0.025)'};display:flex;align-items:center;justify-content:center;${isNow?'box-shadow:0 0 16px '+s.color+'44;':''};flex-shrink:0;">
                    ${isDone ? '<i class="ti ti-check" style="font-size:0.85rem;color:var(--green);"></i>' : isNow ? '<i class="ti '+s.icon+'" style="font-size:0.85rem;color:'+s.color+';"></i>' : '<div style="width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.12);"></div>'}
                  </div>
                  ${i < steps.length-1 ? `<div style="width:2px;height:28px;background:${lineColor};margin:3px 0;"></div>` : ''}
                </div>
                <div style="padding-top:6px;padding-bottom:${i<steps.length-1?'0':'0'}px;flex:1;min-width:0;">
                  <div style="font-size:0.875rem;font-weight:${isNow?'700':'500'};color:${isDone?'var(--green)':isNow?s.color:'var(--text-3)'};margin-bottom:0.1rem;">${s.label}${isNow?` <span style="font-size:0.65rem;font-weight:700;background:${s.color}22;color:${s.color};border:1px solid ${s.color}44;border-radius:10px;padding:0.1rem 0.45rem;margin-left:0.4rem;vertical-align:middle;">CURRENT</span>`:''}</div>
                  <div style="font-size:0.78rem;color:${isNow?'var(--text-2)':'var(--text-3)'};">${isNow?s.sub:isDone?'Completed':'Pending'}</div>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>

      <!-- Footer -->
      <div style="padding:0.875rem 1.5rem;background:rgba(255,255,255,0.015);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;">
        <div style="font-size:0.75rem;color:var(--text-3);display:flex;align-items:center;gap:0.4rem;">
          <i class="ti ti-map-pin" style="color:var(--amber);"></i> Miami, FL â†’ Kingston, Jamaica
        </div>
        <div style="font-size:0.75rem;color:var(--text-3);">
          ${ship.created_at ? 'Registered: '+fmtDate(ship.created_at) : ''}
        </div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOMER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function custTab(name) {
  document.querySelectorAll('#page-customer .tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#custSidebar .sidebar-item').forEach(s=>s.classList.remove('active'));
  el(`ctab-${name}`)?.classList.add('active');
  el(`sitem-${name}`)?.classList.add('active');
  if(name==='idcard') renderIDCard();
  if(name==='profile') fillProfileForm();
  if(name==='invoices') renderCustomerInvoices();
  if(name==='notifications') renderNotifications();
  if(name==='address') renderAddressTab();
}

async function loadCustomerData() {
  const p = currentProfile;
  const hr = new Date().getHours();
  const greeting = hr<12?'GOOD MORNING':hr<17?'GOOD AFTERNOON':'GOOD EVENING';
  if(el('custGreeting')) el('custGreeting').textContent=`${greeting}, ${p?.full_name?.split(' ')[0]?.toUpperCase()||'THERE'}!`;
  if(el('custSubGreeting')) el('custSubGreeting').textContent=`Welcome to your CaribCargo dashboard â€” ${fmtDate(new Date().toISOString())}`;

  // Warehouse address
  const addr = warehouseAddress(p?.cargolink_id||'CL-XXXXX', p?.full_name||'Customer');
  ['warehouseAddress','addrTabWarehouse'].forEach(id=>{ if(el(id)) el(id).innerHTML=addr.replace(/\n/g,'<br>'); });

  if(DEMO_MODE) {
    allShipments=getDemoShipments(8); allInvoices=getDemoInvoices(5); notifications=getDemoNotifications();
  } else {
    try {
      const [ships, invs, notifs] = await Promise.all([
        sb.from('shipments').select('*').eq('customer_id',currentUser.id).order('created_at',{ascending:false}),
        sb.from('invoices').select('*').eq('customer_id',currentUser.id).order('created_at',{ascending:false}),
        sb.from('notifications').select('*').eq('customer_id',currentUser.id).order('created_at',{ascending:false}).limit(20)
      ]);
      if(ships.error) {
        console.warn('Shipments query error:', ships.error);
        toast('Could not load shipments: ' + ships.error.message + ' â€” re-run SQL setup in Supabase.','error');
      }
      allShipments = ships.data || [];
      allInvoices  = invs.data  || [];
      notifications = notifs.data || [];
    } catch(e) {
      console.warn('loadCustomerData error:', e);
      toast('Data load error: ' + (e.message||'unknown') + ' â€” check Supabase RLS policies.','error');
      allShipments=[]; allInvoices=[]; notifications=[];
    }
  }

  const transit=allShipments.filter(s=>['in_transit','customs'].includes(s.status)).length;
  const delivered=allShipments.filter(s=>s.status==='delivered').length;
  const outstanding=allInvoices.filter(i=>i.status==='unpaid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
  if(el('cstat-total'))     el('cstat-total').textContent=allShipments.length;
  if(el('cstat-transit'))   el('cstat-transit').textContent=transit;
  if(el('cstat-delivered')) el('cstat-delivered').textContent=delivered;
  if(el('cstat-balance'))   el('cstat-balance').textContent=fmt$(outstanding);

  const unread=notifications.filter(n=>!n.read).length;
  if(el('notifBadge')){ el('notifBadge').textContent=unread; el('notifBadge').style.display=unread>0?'inline':'none'; }

  renderRecentShipments();
  renderShipmentsList();
  renderCustomerInvoices();
  renderNotifications();
}

function renderRecentShipments() {
  const c=el('custRecentShipments'); if(!c) return;
  const recent=allShipments.slice(0,5);
  if(!recent.length){ c.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="ti ti-package"></i></div><div class="empty-title">No shipments yet</div><div class="empty-sub">Once your first package arrives at our Miami warehouse, it will appear here.</div></div>`; return; }
  c.innerHTML=recent.map(s=>shipCard(s)).join('');
}

function shipCard(s) {
  // Use data-shipid attribute to avoid querySelector issues with UUID/numeric IDs
  return `<div class="ship-card" data-shipid="${s.id}" onclick="openShipDetailById(this)">
    <div class="ship-card-top">
      <div><div class="ship-tracking">${s.tracking_number}</div><div class="ship-desc">${s.description||'Package'}</div></div>
      ${statusBadge(s.status)}
    </div>
    <div class="ship-meta">
      <div class="ship-meta-item">Type: <span>${s.ship_type||'General'}</span></div>
      <div class="ship-meta-item">Weight: <span>${s.weight||'â€”'} kg</span></div>
      <div class="ship-meta-item">Date: <span>${fmtDate(s.created_at)}</span></div>
    </div>
  </div>`;
}

function openShipDetailById(el) {
  const id = el.dataset.shipid;
  openShipDetail(id);
}

function filterShipments(){ renderShipmentsList(); }

function renderShipmentsList() {
  const c=el('shipmentsList'); if(!c) return;
  const q=(el('shipSearch')?.value||'').toLowerCase();
  const flt=el('shipFilter')?.value||'';
  const shown=allShipments.filter(s=>
    (!q||s.tracking_number.toLowerCase().includes(q)||(s.description||'').toLowerCase().includes(q))&&
    (!flt||s.status===flt)
  );
  c.innerHTML=shown.length ? shown.map(s=>shipCard(s)).join('') : `<div class="empty-state"><div class="empty-icon"><i class="ti ti-package"></i></div><div class="empty-title">No shipments match your filter</div></div>`;
}

function renderCustomerInvoices() {
  const c=el('invoicesList'); if(!c) return;
  if(!allInvoices.length){ c.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="ti ti-receipt"></i></div><div class="empty-title">No invoices yet</div></div>`; return; }
  c.innerHTML=allInvoices.map(inv=>`
    <div class="invoice-row">
      <div class="mono" style="font-size:0.8rem;color:var(--text-2);">#${(inv.id||'').slice(-6)}</div>
      <div>
        <div style="font-weight:600;font-size:0.875rem;">${inv.description||'Shipping Invoice'}</div>
        <div style="font-size:0.73rem;color:var(--text-3);">Due: ${fmtDate(inv.due_date)}</div>
      </div>
      ${statusBadge(inv.status)}
      <div style="font-family:'JetBrains Mono',monospace;font-weight:700;color:${inv.status==='paid'?'var(--green)':'var(--amber)'};">${fmt$(inv.amount)}</div>
      <div style="font-size:0.75rem;color:var(--text-3);">${fmtDate(inv.created_at)}</div>
      ${inv.status==='unpaid'?'<button class="btn btn-amber btn-sm" onclick="toast(\'Redirecting to paymentâ€¦\',\'info\')"><i class="ti ti-credit-card"></i> Pay</button>':'<span style="color:var(--green);font-size:0.82rem;"><i class="ti ti-check"></i> Paid</span>'}
    </div>
  `).join('');
}

function renderNotifications() {
  const c=el('notificationsList'); if(!c) return;
  if(!notifications.length){ c.innerHTML=`<div class="empty-state"><div class="empty-icon"><i class="ti ti-bell"></i></div><div class="empty-title">No notifications</div></div>`; return; }
  c.innerHTML=`<div class="card"><div class="card-body">`+notifications.map(n=>`
    <div class="update-log-item">
      <div class="update-log-dot" style="background:${n.read?'var(--text-3)':'var(--amber)'}"></div>
      <div style="flex:1;">
        <div style="font-size:0.88rem;font-weight:${n.read?'400':'600'};">${n.title}</div>
        <div style="font-size:0.8rem;color:var(--text-2);margin-top:0.15rem;">${n.message}</div>
        <div style="font-size:0.72rem;color:var(--text-3);margin-top:0.15rem;">${fmtDateTime(n.created_at)}</div>
      </div>
      ${!n.read?`<span class="badge badge-amber" style="flex-shrink:0;">New</span>`:''}
    </div>
  `).join('')+`</div></div>`;
}

function renderAddressTab() {
  const p=currentProfile;
  if(el('addrTabId')) el('addrTabId').textContent=p?.cargolink_id||'CL-XXXXX';
  if(el('myDeliveryAddr')) {
    const parts=[p?.addr1,p?.addr2,p?.city,(p?.region_addr||p?.region),p?.postal,p?.country].filter(Boolean);
    el('myDeliveryAddr').innerHTML=parts.join('<br>')||'<span style="color:var(--text-3);">No address saved yet.</span>';
  }
}

function openShipDetail(id) {
  const s=allShipments.find(x=>x.id===id); if(!s) return;
  const steps=['pending','received','in_transit','customs','ready','delivered'];
  const labels=['Order Placed','Received at Warehouse','In Transit','Customs Clearance','Ready for Pickup','Delivered'];
  const icons=['<i class="ti ti-file-description"></i>','<i class="ti ti-package"></i>','<i class="ti ti-plane"></i>','<i class="ti ti-shield-check"></i>','<i class="ti ti-mailbox"></i>','<i class="ti ti-circle-check"></i>'];
  const curIdx=steps.indexOf(s.status);
  const m=document.createElement('div');
  m.className='modal-overlay'; m.onclick=e=>{if(e.target===m)m.remove()};
  m.innerHTML=`
    <div class="modal-box lg">
      <div class="modal-head">
        <div><span class="modal-title">${s.tracking_number}</span><div style="margin-top:0.25rem;">${statusBadge(s.status)}</div></div>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
        <div>
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-3);margin-bottom:0.75rem;">Shipment Details</div>
          ${[['Description',s.description||'â€”'],['Type',s.ship_type||'General'],['Weight',s.weight?s.weight+' kg':'â€”'],['Origin','Miami, FL, USA'],['Destination','Kingston, Jamaica'],['Created',fmtDate(s.created_at)],['Notes',s.notes||'None']].map(([k,v])=>`
            <div style="display:flex;justify-content:space-between;font-size:0.85rem;padding:0.55rem 0;border-bottom:1px solid var(--border);">
              <span style="color:var(--text-3);">${k}</span><span style="font-weight:600;">${v}</span>
            </div>`).join('')}
        </div>
        <div>
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-3);margin-bottom:0.75rem;">Tracking Timeline</div>
          <div class="timeline">
            ${steps.map((st,i)=>{
              const isDone=i<curIdx,isNow=i===curIdx;
              return `<div class="tl-step">
                <div class="tl-dot ${isDone?'done':isNow?'now':'pend'}">${isDone?'âœ“':isNow?'â—':''}</div>
                <div class="tl-title" style="${isDone?'color:var(--green)':isNow?'color:var(--amber)':'color:var(--text-3)'};">${icons[i]} ${labels[i]}</div>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>
    </div>`;
  el('modals').appendChild(m);
}

function renderIDCard() {
  const p=currentProfile; if(!p) return;
  const c=el('idCardEl'); if(!c) return;
  c.innerHTML=`
    <div class="id-card" id="printableIDCard">
      <div class="id-card-logo"><i class="ti ti-anchor"></i> CARIBCARGO</div>
      <div class="id-card-name">${p.full_name||'â€”'}</div>
      <div class="id-card-id">${p.cargolink_id||'CL-XXXXX'}</div>
      <div class="id-card-fields">
        <div><div class="id-card-field-lbl">Country</div><div class="id-card-field-val" style="font-size:0.78rem;">${p.country||'â€”'}</div></div>
        <div><div class="id-card-field-lbl">Phone</div><div class="id-card-field-val" style="font-size:0.78rem;">${p.phone||'â€”'}</div></div>
        <div><div class="id-card-field-lbl">TRN / ID</div><div class="id-card-field-val">${p.trn||'â€”'}</div></div>
        <div><div class="id-card-field-lbl">Member Since</div><div class="id-card-field-val">${new Date().getFullYear()}</div></div>
      </div>
      <div class="id-barcode"><canvas id="barcodeCanvas"></canvas></div>
    </div>`;
  setTimeout(()=>drawBarcode(el('barcodeCanvas'),p.cargolink_id||'CL-00000'),100);
}

function copyWarehouseAddr() {
  const p=currentProfile;
  const addr=warehouseAddress(p?.cargolink_id||'CL-XXXXX',p?.full_name||'Customer');
  navigator.clipboard?.writeText(addr).then(()=>toast('Address copied to clipboard!','success'));
}

function fillProfileForm() {
  const p=currentProfile; if(!p) return;
  // Only fill non-address fields (address is now read-only)
  const nameFields = ['fname','lname','phone','trn','country'];
  nameFields.forEach(f=>{
    const inp=el('prof-'+f);
    if(!inp) return;
    const val = f==='fname'?p.full_name?.split(' ')[0]||'': f==='lname'?p.full_name?.split(' ').slice(1).join(' ')||'':p[f]||'';
    inp.value=val;
  });
  // Populate hidden address fields for saveProfile compatibility
  if(el('prof-addr1')) el('prof-addr1').value=p.addr1||'';
  if(el('prof-addr2')) el('prof-addr2').value=p.addr2||'';
  if(el('prof-city'))  el('prof-city').value=p.city||'';
  if(el('prof-region'))el('prof-region').value=p.region_addr||p.region||'';
  if(el('prof-postal'))el('prof-postal').value=p.postal||'';
  updateProfileAddressDisplay();
}

async function saveProfile() {
  // Address fields are admin-only â€” customers can only update personal info
  const updates={
    full_name:`${el('prof-fname')?.value||''} ${el('prof-lname')?.value||''}`.trim(),
    phone:el('prof-phone')?.value||'',
    trn:el('prof-trn')?.value||''
  };
  if(!DEMO_MODE&&sb){ const {error}=await sb.from('profiles').update(updates).eq('id',currentUser.id); if(error) return toast(error.message,'error'); }
  Object.assign(currentProfile,updates);
  toast('Profile saved successfully!','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adminTab(name) {
  // Employee permission check
  const isOwner = (currentProfile?.role==='admin');
  // Data Management is always owner-only regardless of permissions
  if(name === 'data' && !isOwner) {
    toast('ðŸ”’ Data Management is restricted to the account owner only.','error');
    return;
  }
  if(!isOwner && currentProfile?._isEmployee) {
    const perms = currentProfile._employeePerms || {};
    if(!perms[name]) {
      toast(`ðŸ”’ Access to "${name}" is restricted. Contact your admin.`,'error');
      return;
    }
  } else if(!isOwner) {
    // Also check localStorage staff list for live mode
    const staffList = JSON.parse(localStorage.getItem('cc_staff')||'[]');
    const me = staffList.find(s=>s.email===currentProfile?.email);
    if(me && me.perms && !me.perms[name]) {
      toast(`ðŸ”’ You don't have permission to access "${name}".`,'error');
      return;
    }
  }
  document.querySelectorAll('#page-admin .tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#adminSidebar .sidebar-item').forEach(s=>s.classList.remove('active'));
  el(`atab-${name}`)?.classList.add('active');
  el(`aitem-${name}`)?.classList.add('active');
  if(name==='updates')  loadBulkShipments();
  if(name==='settings') { loadSettingsTab(); setTimeout(()=>populateCpicker('ep'), 50); }
  if(name==='messages') { renderMsgLog(); setTimeout(()=>{ populateCpicker('msg'); loadAdminInbox(); }, 50); }
  if(name==='staff')    renderStaffTab();
  if(name==='exports')  { renderExportTable(); }
}

async function refreshAdmin() {
  el('adminDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  let customers=[],shipments=[],invoices=[];
  if(DEMO_MODE){
    customers=getDemoCustomers(); shipments=getDemoShipments(20); invoices=getDemoInvoices(15);
  } else {
    try {
      const [c,s,i] = await Promise.all([
        sb.from('profiles').select('*').or('role.eq.customer,role.is.null'),
        sb.from('shipments').select('*,profiles(full_name,cargolink_id,email,country)').order('created_at',{ascending:false}),
        sb.from('invoices').select('*,profiles(full_name,email)').order('created_at',{ascending:false})
      ]);
      if(c.error) throw c.error;
      customers=c.data||[]; shipments=s.data||[]; invoices=i.data||[];
    } catch(e) {
      console.warn('refreshAdmin error:', e);
      if(e.message?.includes('relation') || e.message?.includes('does not exist')) {
        toast('âš ï¸ Tables not found. Please run the SQL setup script in Supabase first.','error');
      } else {
        toast('Error loading data: '+e.message,'error');
      }
      return;
    }
  }
  allCustomers=customers;
  window._adminShipments = shipments; // store for edit modal

  const transit=shipments.filter(s=>['in_transit','customs'].includes(s.status)).length;
  const revenue=invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
  const pending=shipments.filter(s=>s.status==='pending');
  if(el('astat-customers')) el('astat-customers').textContent=customers.length;
  if(el('astat-shipments')) el('astat-shipments').textContent=shipments.length;
  if(el('astat-transit'))   el('astat-transit').textContent=transit;
  if(el('astat-revenue'))   el('astat-revenue').textContent=fmt$(revenue);

  const pb=el('adminPendingBadge');
  if(pb){ pb.textContent=pending.length; pb.style.display=pending.length>0?'inline':'none'; }
  if(el('adminPendingCount')) el('adminPendingCount').textContent=pending.length+' pending';

  renderAdminStatusChart(shipments);
  renderAdminActivity(shipments.slice(0,10));
  renderAdminPendingList(pending);
  renderAdminCustomers(customers,shipments);
  renderAdminShipments(shipments);
  renderAdminInvoices(invoices,customers);
  renderReports(shipments,invoices,customers);
}

function renderAdminStatusChart(shipments) {
  const ctx=el('adminStatusChart'); if(!ctx) return;
  const counts={pending:0,received:0,in_transit:0,customs:0,ready:0,delivered:0};
  shipments.forEach(s=>{counts[s.status]=(counts[s.status]||0)+1;});
  if(adminCharts.status) adminCharts.status.destroy();
  adminCharts.status=new Chart(ctx,{
    type:'doughnut',
    data:{labels:['Pending','Received','In Transit','Customs','Ready','Delivered'],datasets:[{data:Object.values(counts),backgroundColor:['rgba(92,86,80,0.7)','rgba(59,130,246,0.7)','rgba(6,182,212,0.7)','rgba(245,158,11,0.7)','rgba(139,92,246,0.7)','rgba(16,185,129,0.7)'],borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'rgba(255,255,255,0.45)',font:{size:11},boxWidth:12}}}}
  });
}

function renderAdminActivity(shipments) {
  const c=el('adminRecentActivity'); if(!c) return;
  c.innerHTML=shipments.map(s=>`
    <div class="update-log-item">
      <div class="update-log-dot" style="background:var(--amber);"></div>
      <div style="flex:1;">
        <div style="font-size:0.82rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--amber);">${s.tracking_number}</div>
        <div style="font-size:0.75rem;color:var(--text-3);">${s.profiles?.full_name||'Customer'} Â· ${fmtDate(s.created_at)}</div>
      </div>
      ${statusBadge(s.status)}
    </div>`).join('');
}

function renderAdminPendingList(pending) {
  const html=!pending.length?`<div class="empty-state"><div class="empty-icon"><i class="ti ti-circle-check"></i></div><div class="empty-title">No pending shipments</div></div>`:
    pending.map(s=>`
      <div class="ship-card" style="margin-bottom:0.75rem;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
          <div>
            <div class="ship-tracking">${s.tracking_number}</div>
            <div class="ship-desc">${s.description||'Package'} Â· ${s.profiles?.full_name||'Unknown'} Â· ${s.weight||'â€”'} kg Â· ${s.ship_type||'General'}</div>
          </div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn btn-blue btn-sm" onclick="quickUpdateStatus('${s.id}','received')"><i class="ti ti-check"></i> Approve</button>
            <button class="btn btn-ghost btn-sm" data-shipid="${s.id}" onclick="openEditShipment(this.dataset.shipid)"><i class="ti ti-edit"></i> Edit</button>
            <button class="btn btn-danger btn-sm" onclick="quickUpdateStatus('${s.id}','cancelled')"><i class="ti ti-x"></i> Reject</button>
          </div>
        </div>
      </div>`).join('');
  [el('adminPendingList'),el('adminPendingFull')].forEach(c=>{if(c)c.innerHTML=html;});
}

function renderAdminCustomers(customers,shipments) {
  const tbody=el('adminCustTable'); if(!tbody) return;
  tbody.innerHTML=customers.map(c=>{
    const count=shipments.filter(s=>s.customer_id===c.id).length;
    return `<tr>
      <td class="mono" style="color:var(--amber);font-size:0.8rem;">${c.cargolink_id||'â€”'}</td>
      <td style="font-weight:600;">${c.full_name||'â€”'}</td>
      <td style="font-size:0.82rem;color:var(--text-2);">${c.email||'â€”'}</td>
      <td style="font-size:0.82rem;">${c.phone||'â€”'}</td>
      <td><span class="badge badge-gray" style="font-size:0.68rem;">${c.country||'â€”'}</span></td>
      <td style="text-align:center;font-weight:600;">${count}</td>
      <td style="font-size:0.76rem;color:var(--text-3);">${fmtDate(c.created_at)}</td>
      <td>
        <div style="display:flex;gap:0.4rem;">
          <button class="btn btn-ghost btn-sm" onclick="viewCustomerDetail('${c.id}')"><i class="ti ti-eye"></i></button>
          <button class="btn btn-ghost btn-sm" onclick="emailCustomer('${c.id}')"><i class="ti ti-mail"></i></button>
          <button class="btn btn-danger btn-sm" data-custid="${c.id}" data-custname="${(c.full_name||'').replace(/"/g,'&quot;')}" onclick="openDeleteCustomerModal(this.dataset.custid, this.dataset.custname)" title="Delete account"><i class="ti ti-trash"></i></button>
        </div>
      </td>
    </tr>`;
  }).join('')||`<tr><td colspan="8" style="text-align:center;color:var(--text-3);padding:2rem;">No customers found.</td></tr>`;
}

function searchCustomers() {
  const q=(el('custSearch')?.value||'').toLowerCase();
  document.querySelectorAll('#adminCustTable tr').forEach(r=>{r.style.display=!q||r.textContent.toLowerCase().includes(q)?'':'none';});
}

function renderAdminShipments(shipments) {
  const tbody=el('adminShipTable'); if(!tbody) return;
  tbody.innerHTML=shipments.map(s=>`<tr>
    <td class="mono" style="color:var(--amber);font-size:0.8rem;">${s.tracking_number}</td>
    <td>
      <div style="font-size:0.875rem;font-weight:500;">${s.profiles?.full_name||'â€”'}</div>
      <div style="font-size:0.72rem;color:var(--text-3);">${s.profiles?.cargolink_id||''}</div>
    </td>
    <td style="font-size:0.82rem;">${s.ship_type||'General'}</td>
    <td style="font-size:0.82rem;">${s.weight||'â€”'} kg</td>
    <td>${statusBadge(s.status)}</td>
    <td style="font-size:0.76rem;color:var(--text-3);">${fmtDate(s.created_at)}</td>
    <td>
      <div style="display:flex;gap:0.4rem;align-items:center;">
        <select class="form-select" style="padding:0.3rem 0.5rem;font-size:0.78rem;width:130px;" onchange="adminUpdateStatus('${s.id}',this.value,this)">
          <option value="">Statusâ€¦</option>
          <option value="received" ${s.status==='received'?'selected':''}>Received</option>
          <option value="in_transit" ${s.status==='in_transit'?'selected':''}>In Transit</option>
          <option value="customs" ${s.status==='customs'?'selected':''}>Customs</option>
          <option value="ready" ${s.status==='ready'?'selected':''}>Ready</option>
          <option value="delivered" ${s.status==='delivered'?'selected':''}>Delivered</option>
          <option value="cancelled" ${s.status==='cancelled'?'selected':''}>Cancelled</option>
        </select>
                    <button class="btn btn-ghost btn-sm" data-shipid="${s.id}" onclick="openEditShipment(this.dataset.shipid)" title="Edit"><i class="ti ti-edit"></i></button>
      </div>
    </td>
  </tr>`).join('');
}

function searchAdminShipments() {
  const q=(el('adminShipSearch')?.value||'').toLowerCase();
  const flt=el('adminShipFilter')?.value||'';
  document.querySelectorAll('#adminShipTable tr').forEach(r=>{
    const txt=r.textContent.toLowerCase();
    r.style.display=(!q||txt.includes(q))&&(!flt||txt.includes(flt.replace(/_/g,' ')))?'':'none';
  });
}

function renderAdminInvoices(invoices,customers) {
  const tbody=el('adminInvTable'); if(!tbody) return;
  tbody.innerHTML=invoices.map(inv=>{
    const cust=customers.find(c=>c.id===inv.customer_id);
    return `<tr>
      <td class="mono" style="font-size:0.8rem;color:var(--amber);">#${(inv.id||'').slice(-6)}</td>
      <td style="font-size:0.875rem;">${cust?.full_name||inv.profiles?.full_name||'â€”'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:700;">${fmt$(inv.amount)}</td>
      <td>${statusBadge(inv.status)}</td>
      <td style="font-size:0.76rem;color:var(--text-3);">${fmtDate(inv.due_date)}</td>
      <td>
        <div style="display:flex;gap:0.4rem;">
          ${inv.status==='unpaid'?'<button class="btn btn-green btn-sm" onclick="markInvoicePaid(\''+inv.id+'\')"><i class="ti ti-check"></i> Paid</button>':'<span style="color:var(--green);font-size:0.82rem;"><i class="ti ti-check"></i> Paid</span>'}
          <button class="btn btn-ghost btn-sm" onclick="sendInvoiceReminder('${inv.id}')"><i class="ti ti-mail"></i></button>
        </div>
      </td>
    </tr>`;
  }).join('')||`<tr><td colspan="6" style="text-align:center;color:var(--text-3);padding:2rem;">No invoices.</td></tr>`;
}

function renderReports(shipments,invoices,customers) {
  const typeCtx=el('reportTypeChart');
  if(typeCtx){
    const types={};
    shipments.forEach(s=>{const t=s.ship_type||'General';types[t]=(types[t]||0)+1;});
    if(adminCharts.type) adminCharts.type.destroy();
    adminCharts.type=new Chart(typeCtx,{type:'bar',data:{labels:Object.keys(types),datasets:[{data:Object.values(types),backgroundColor:'rgba(245,158,11,0.6)',borderColor:'rgba(245,158,11,0.9)',borderWidth:1,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'rgba(255,255,255,0.35)',font:{size:10}}},y:{ticks:{color:'rgba(255,255,255,0.35)',font:{size:10}},grid:{color:'rgba(255,255,255,0.035)'}}}}});
  }
  const monthCtx=el('reportMonthChart');
  if(monthCtx){
    const months={};
    shipments.forEach(s=>{const m=new Date(s.created_at).toLocaleDateString('en-US',{month:'short',year:'2-digit'});months[m]=(months[m]||0)+1;});
    const labels=Object.keys(months).slice(-8);
    if(adminCharts.month) adminCharts.month.destroy();
    adminCharts.month=new Chart(monthCtx,{type:'line',data:{labels,datasets:[{data:labels.map(l=>months[l]||0),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.08)',fill:true,tension:0.4,pointRadius:4,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'rgba(255,255,255,0.35)',font:{size:10}}},y:{ticks:{color:'rgba(255,255,255,0.35)',font:{size:10}},grid:{color:'rgba(255,255,255,0.035)'}}}}});
  }
  const rev=el('revenueBreakdown');
  if(rev){
    const paid=invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
    const unpaid=invoices.filter(i=>i.status==='unpaid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
    rev.innerHTML=[['Collected',paid,'var(--green)'],['Outstanding',unpaid,'var(--red)'],['Total (All)',paid+unpaid,'var(--amber)']].map(([l,v,c])=>`
      <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 0;border-bottom:1px solid var(--border);">
        <span style="color:var(--text-2);font-size:0.875rem;">${l}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;color:${c};">${fmt$(v)}</span>
      </div>`).join('');
  }
  const topTbl=el('topCustTable');
  if(topTbl){
    const custMap={};
    shipments.forEach(s=>{const name=s.profiles?.full_name||'â€”';custMap[name]=(custMap[name]||0)+1;});
    topTbl.innerHTML=Object.entries(custMap).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([name,cnt])=>`<tr><td>${name}</td><td style="text-align:center;font-weight:600;">${cnt}</td><td style="font-family:'JetBrains Mono',monospace;color:var(--green);">${fmt$(cnt*85)}</td></tr>`).join('');
  }
}

// â”€â”€ ADMIN ACTIONS â”€â”€
async function adminUpdateStatus(id,status,selectEl) {
  if(!status) return;
  if(selectEl) selectEl.value='';
  await doUpdateStatus(id,status,true);
}

async function quickUpdateStatus(id,status) {
  await doUpdateStatus(id,status,false);
  await refreshAdmin();
}

async function doUpdateStatus(id,status,skipRefresh) {
  if(!DEMO_MODE&&sb){
    const {error}=await sb.from('shipments').update({status,updated_at:new Date().toISOString()}).eq('id',id);
    if(error) return toast(error.message,'error');
    // Push notification to customer so they see the update on their dashboard
    try {
      const {data:ship}=await sb.from('shipments').select('customer_id,tracking_number,description').eq('id',id).single();
      if(ship?.customer_id) {
        await sb.from('notifications').insert({
          customer_id: ship.customer_id,
          title: `Shipment Update: ${statusLabel(status)}`,
          message: `Your shipment ${ship.tracking_number} (${ship.description||'Package'}) status has been updated to: ${statusLabel(status)}.`,
          read: false,
          created_at: new Date().toISOString()
        });
      }
    } catch(e){ console.warn('Notification insert error (non-fatal):', e.message); }
  }
  toast(`Status updated to: ${statusLabel(status)}`,'success');
  if(!skipRefresh) return;
  await refreshAdmin();
}

async function sendShipmentUpdate() {
  const tracking=(el('upd-tracking')?.value||'').trim().toUpperCase();
  const status=el('upd-status')?.value;
  const note=el('upd-note')?.value||'';
  const sendEmail=el('upd-sendemail')?.checked;
  if(!tracking||!status) return toast('Enter a tracking number and select a status.','error');

  let ship=null;
  if(DEMO_MODE){ ship=getDemoShipments(20).find(s=>s.tracking_number===tracking); }
  else {
    const {data}=await sb.from('shipments').select('*,profiles(full_name,email)').eq('tracking_number',tracking).single();
    ship=data;
  }
  if(!ship) return toast('Tracking number not found.','error');

  await doUpdateStatus(ship.id,status,false);

  if(sendEmail&&!DEMO_MODE&&ship.profiles?.email) {
    await sendStatusEmail(ship.profiles,ship,status,note);
    toast('Email notification sent to customer.','success');
  } else if(sendEmail&&DEMO_MODE) {
    toast('Email would be sent in production (demo mode).','info');
  }

  // Log the update
  updateLog.unshift({tracking,status,note,time:new Date(),sent:sendEmail});
  renderUpdateLog();

  if(el('upd-tracking')) el('upd-tracking').value='';
  if(el('upd-status'))   el('upd-status').value='';
  if(el('upd-note'))     el('upd-note').value='';
  await refreshAdmin();
}

function renderUpdateLog() {
  const c=el('updateLog'); if(!c) return;
  if(!updateLog.length){ c.innerHTML=`<div style="font-size:0.84rem;color:var(--text-3);">No updates sent yet.</div>`; return; }
  c.innerHTML=updateLog.slice(0,10).map(u=>`
    <div class="update-log-item">
      <div class="update-log-dot" style="background:var(--green);"></div>
      <div>
        <div style="font-size:0.88rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--amber);">${u.tracking}</div>
        <div style="font-size:0.8rem;color:var(--text-2);">â†’ ${statusLabel(u.status)}${u.sent?' Â· Email sent':' Â· No email'}</div>
        ${u.note?`<div style="font-size:0.78rem;color:var(--text-3);">${u.note}</div>`:''}
        <div style="font-size:0.72rem;color:var(--text-3);">${fmtDateTime(u.time)}</div>
      </div>
    </div>`).join('');
}

function loadBulkShipments() {
  const flt=el('bulk-filter')?.value||'pending';
  const c=el('bulk-ship-list'); if(!c) return;
  const ships=getDemoShipments(20).filter(s=>s.status===flt);
  if(!ships.length){ c.innerHTML=`<div style="font-size:0.82rem;color:var(--text-3);padding:0.5rem 0;">No shipments with this status.</div>`; return; }
  bulkShipments=ships;
  c.innerHTML=ships.map(s=>`
    <label style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0;border-bottom:1px solid var(--border);cursor:pointer;">
      <input type="checkbox" class="bulk-chk" data-id="${s.id}" style="accent-color:var(--amber);width:14px;height:14px;" checked>
      <span style="font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--amber);">${s.tracking_number}</span>
      <span style="font-size:0.78rem;color:var(--text-2);">${s.profiles?.full_name||'â€”'}</span>
    </label>`).join('');
}

async function bulkUpdate() {
  const checked=[...document.querySelectorAll('.bulk-chk:checked')].map(cb=>cb.dataset.id);
  const newStatus=el('bulk-new-status')?.value;
  if(!checked.length) return toast('No shipments selected.','error');
  if(!newStatus) return toast('Select a new status.','error');
  for(const id of checked){ if(!DEMO_MODE&&sb) await sb.from('shipments').update({status:newStatus}).eq('id',id); }
  toast(`Updated ${checked.length} shipments to: ${statusLabel(newStatus)}`,'success');
  await refreshAdmin();
}

async function markInvoicePaid(id) {
  if(!DEMO_MODE&&sb) await sb.from('invoices').update({status:'paid'}).eq('id',id);
  toast('Invoice marked as paid','success');
  await refreshAdmin();
}

function sendInvoiceReminder(id) {
  toast('Invoice reminder sent (email)','success');
}

function viewCustomerDetail(id) {
  const c=allCustomers.find(x=>x.id===id); if(!c) return;
  const m=document.createElement('div');
  m.className='modal-overlay'; m.onclick=e=>{if(e.target===m)m.remove();};
  m.innerHTML=`
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title">${c.full_name||'Customer'}</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      ${[['CaribCargo ID',c.cargolink_id||'â€”'],['Email',c.email||'â€”'],['Phone',c.phone||'â€”'],['Country',c.country||'â€”'],['TRN',c.trn||'â€”'],['Delivery Preference',c.delivery_pref||'pickup'],['Member Since',fmtDate(c.created_at)]].map(([k,v])=>`
        <div style="display:flex;justify-content:space-between;padding:0.65rem 0;border-bottom:1px solid var(--border);font-size:0.875rem;">
          <span style="color:var(--text-3);">${k}</span><span style="font-weight:600;">${v}</span>
        </div>`).join('')}
      <div style="margin-top:1.25rem;display:flex;gap:0.75rem;">
        <button class="btn btn-blue btn-sm" onclick="emailCustomer('${id}')"><i class="ti ti-mail"></i> Email</button>
        <button class="btn btn-ghost btn-sm" onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
}

function emailCustomer(id) {
  const c = allCustomers.find(x=>x.id===id)||{};
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.onclick = e => { if(e.target===m) m.remove(); };
  m.innerHTML = `
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title">EMAIL CUSTOMER</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <p style="font-size:0.82rem;color:var(--text-2);margin-bottom:1rem;">To: <strong style="color:var(--text);">${c.email||'(no email on file)'}</strong></p>
      <div style="margin-bottom:1rem;">
        <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);margin-bottom:0.45rem;">âš¡ Quick Templates</div>
        <div style="display:flex;flex-wrap:wrap;gap:0.35rem;">
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;border-color:rgba(16,185,129,0.3);color:var(--green);" onclick="applyMsgTemplate('order_arrived','em-subject','em-body')">ðŸ“¦ Arrived</button>
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;border-color:rgba(59,130,246,0.3);color:var(--blue);" onclick="applyMsgTemplate('in_transit','em-subject','em-body')">ðŸš¢ In Transit</button>
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;border-color:rgba(245,158,11,0.3);color:var(--amber);" onclick="applyMsgTemplate('customs_hold','em-subject','em-body')">ðŸ›ƒ Customs</button>
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;border-color:rgba(139,92,246,0.3);color:#a78bfa;" onclick="applyMsgTemplate('ready_pickup','em-subject','em-body')">âœ… Ready Pickup</button>
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;border-color:rgba(239,68,68,0.3);color:var(--red);" onclick="applyMsgTemplate('action_required','em-subject','em-body')">âš ï¸ Action Needed</button>
          <button class="btn btn-ghost btn-sm" style="font-size:0.7rem;" onclick="applyMsgTemplate('general_update','em-subject','em-body')">ðŸ“‹ General Update</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Subject</label>
        <input class="form-input" id="em-subject" value="Update from CaribCargo">
      </div>
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea class="form-input" id="em-body" rows="5" placeholder="Type your message hereâ€¦" style="resize:vertical;"></textarea>
      </div>
      <button class="btn btn-amber" style="width:100%;" id="emSendBtn" onclick="sendEmailToCustomer('${id}')">
        <i class="ti ti-mail"></i> Send Email
      </button>
    </div>`;
  el('modals').appendChild(m);
}

async function sendEmailToCustomer(id) {
  const c = allCustomers.find(x=>x.id===id)||{};
  const subject = el('em-subject')?.value?.trim();
  const body    = el('em-body')?.value?.trim();
  if(!body) return toast('Please write a message first.','error');
  if(!c.email) return toast('This customer has no email on file.','error');
  const btn = el('emSendBtn');
  btn.innerHTML = '<div class="loader"></div> Sendingâ€¦'; btn.disabled = true;
  if(EMAILJS_PUBLIC_KEY.includes('YOUR')) {
    await new Promise(r=>setTimeout(r,700));
    btn.innerHTML = '<i class="ti ti-mail"></i> Send Email'; btn.disabled = false;
    document.querySelector('.modal-overlay')?.remove();
    toast('Email sent to '+c.email+' (add EmailJS keys to go live)','info');
    return;
  }
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_UPDATE, {
      to_name:       c.full_name||'Customer',
      to_email:      c.email,
      admin_message: body,
    });
    btn.innerHTML = '<i class="ti ti-mail"></i> Send Email'; btn.disabled = false;
    document.querySelector('.modal-overlay')?.remove();
    toast('âœ“ Email sent to '+c.email,'success');
  } catch(e) {
    btn.innerHTML = '<i class="ti ti-mail"></i> Send Email'; btn.disabled = false;
    toast('Email failed: '+(e.text||e.message||'unknown error'),'error');
  }
}

function openEditShipment(id) {
  // Find from admin's loaded shipments list, fall back to demo
  const adminShips = DEMO_MODE ? getDemoShipments(20) : (window._adminShipments || getDemoShipments(20));
  const s = adminShips.find(x=>x.id===id);
  if(!s) return toast('Shipment not found.','error');
  const m=document.createElement('div');
  m.className='modal-overlay'; m.onclick=e=>{if(e.target===m)m.remove();};
  m.innerHTML=`
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title">EDIT SHIPMENT</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div class="form-group"><label class="form-label">Tracking #</label><input class="form-input" value="${s.tracking_number}" readonly style="color:var(--amber);font-family:'JetBrains Mono',monospace;"></div>
      <div class="form-grid-2">
        <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="edit-desc" value="${s.description||''}"></div>
        <div class="form-group"><label class="form-label">Weight (kg)</label><input class="form-input" id="edit-weight" type="number" step="0.1" value="${s.weight||''}"></div>
      </div>
      <div class="form-group"><label class="form-label">Status</label>
        <select class="form-select" id="edit-status">
          ${['pending','received','in_transit','customs','ready','delivered','cancelled'].map(st=>`<option value="${st}" ${s.status===st?'selected':''}>${statusLabel(st)}</option>`).join('')}
        </select>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="edit-notes" rows="3" style="resize:vertical;">${s.notes||''}</textarea></div>
      <button class="btn btn-amber" style="width:100%;" onclick="saveEditShipment('${s.id}')">Save Changes</button>
    </div>`;
  el('modals').appendChild(m);
}

async function saveEditShipment(id) {
  const status=el('edit-status')?.value;
  const updates={status,description:el('edit-desc')?.value,weight:parseFloat(el('edit-weight')?.value)||null,notes:el('edit-notes')?.value};
  if(!DEMO_MODE&&sb) await sb.from('shipments').update(updates).eq('id',id);
  document.querySelector('.modal-overlay')?.remove();
  toast('Shipment updated!','success');
  await refreshAdmin();
}

function openCreateShipment() {
  const m=document.createElement('div');
  m.className='modal-overlay'; m.onclick=e=>{if(e.target===m)m.remove();};
  m.innerHTML=`
    <div class="modal-box lg">
      <div class="modal-head">
        <span class="modal-title">CREATE SHIPMENT</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div class="form-group">
        <label class="form-label">Customer *</label>
        <div class="cpicker-wrap" id="cs-cpicker-wrap">
          <div class="cpicker-input" id="cs-cpicker-btn" onclick="toggleCpicker('cs')">
            <span class="cpicker-placeholder" id="cs-cpicker-placeholder">Search by name or CargoLink IDâ€¦</span>
            <div class="cpicker-selected" id="cs-cpicker-selected" style="display:none;"></div>
            <i class="ti ti-chevron-down cpicker-arrow"></i>
          </div>
          <div class="cpicker-dropdown" id="cs-cpicker-dropdown" style="display:none;">
            <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i><input type="text" id="cs-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('cs')"></div>
            <div class="cpicker-list" id="cs-cpicker-list"></div>
          </div>
        </div>
        <input type="hidden" id="cs-customer-uuid" value="">
        <input type="hidden" id="cs-customer-email" value="">
        <input type="hidden" id="cs-customer-name" value="">
        <div id="cs-cust-tag" style="display:none;margin-top:0.4rem;"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Tracking Number</label>
        <div style="display:flex;align-items:center;gap:0.65rem;padding:0.6rem 1rem;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15);border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:0.88rem;color:var(--amber);">
          <i class="ti ti-barcode" style="color:var(--text-3);"></i>
          <span id="cs-tracking-preview" style="flex:1;">Auto-generated on submit</span>
          <span style="font-size:0.65rem;color:var(--text-3);font-family:'DM Sans';">CCJ-YYYY-XXXXX</span>
        </div>
      </div>
      <div class="form-grid-2">
        <div class="form-group"><label class="form-label">Description *</label><input class="form-input" id="cs-desc" placeholder="Clothing, electronicsâ€¦"></div>
        <div class="form-group"><label class="form-label">Weight (kg)</label><input class="form-input" id="cs-weight" type="number" step="0.1" placeholder="2.5"></div>
      </div>
      <div class="form-grid-3">
        <div class="form-group"><label class="form-label">Shipment Type</label>
          <select class="form-select" id="cs-type"><option value="General">General Cargo</option><option value="Barrel">Barrel</option><option value="Air">Air Freight</option><option value="Vehicle">Vehicle</option><option value="Cold Chain">Cold Chain</option></select>
        </div>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-select" id="cs-status"><option value="pending">Pending</option><option value="received">Received</option></select>
        </div>
        <div class="form-group"><label class="form-label">Declared Value ($)</label><input class="form-input" id="cs-value" type="number" step="0.01" placeholder="250.00"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes / Special Instructions</label><textarea class="form-input" id="cs-notes" rows="2" placeholder="Fragile, hazmat, etc." style="resize:vertical;"></textarea></div>
      <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--text-2);">
          <input type="checkbox" id="cs-notify" checked style="accent-color:var(--amber);width:16px;height:16px;">
          Send email notification to customer
        </label>
      </div>
      <button class="btn btn-amber" style="width:100%;" onclick="submitCreateShipment()">Create Shipment <i class="ti ti-arrow-right"></i></button>
    </div>`;
  el('modals').appendChild(m);
  // Populate picker after modal is in DOM
  setTimeout(()=>populateCpicker('cs'), 0);
}

async function submitCreateShipment() {
  const desc = el('cs-desc')?.value?.trim();
  const customerUUID = el('cs-customer-uuid')?.value;
  if(!customerUUID) return toast('Please select a customer.','error');
  if(!desc) return toast('Please add a description.','error');
  const tracking = genTrackingNum();

  if(DEMO_MODE) {
    document.querySelector('.modal-overlay')?.remove();
    toast(`Shipment created (demo): ${tracking}`,'success');
    await refreshAdmin();
    return;
  }

  if(!sb) return toast('Supabase not connected.','error');

  // Get customer email for notification (from the dropdown option)
  const custEmail = el('cs-customer-email')?.value || null;
  const custName  = el('cs-customer-name')?.value || '';

  const { error } = await sb.from('shipments').insert({
    tracking_number: tracking,
    customer_id: customerUUID,   // UUID directly â€” no lookup needed
    description: desc,
    weight: parseFloat(el('cs-weight')?.value) || null,
    ship_type: el('cs-type')?.value,
    status: el('cs-status')?.value,
    notes: el('cs-notes')?.value,
    declared_value: parseFloat(el('cs-value')?.value) || null
  });

  if(error) { toast('Error creating shipment: ' + error.message,'error'); return; }

  // Insert a notification so customer sees it on their dashboard immediately
  await sb.from('notifications').insert({
    customer_id: customerUUID,
    title: 'New Shipment Created',
    message: `Your shipment ${tracking} (${desc}) has been created with status: ${el('cs-status')?.value||'pending'}. You can track it on your dashboard.`,
    read: false,
    created_at: new Date().toISOString()
  });

  // Send notification email if checked
  if(el('cs-notify')?.checked && custEmail) {
    await sendStatusEmail(
      { email: custEmail, full_name: custName },
      { tracking_number: tracking, description: desc },
      el('cs-status')?.value
    );
  }

  document.querySelector('.modal-overlay')?.remove();
  toast(`âœ“ Shipment created: ${tracking}`,'success');
  dlog(`Shipment created: ${tracking} â†’ customer ${customerUUID.slice(0,8)}â€¦`, 'ok', 'SHIP');
  await refreshAdmin();
}

function openCreateInvoice() {
  const m=document.createElement('div');
  m.className='modal-overlay'; m.onclick=e=>{if(e.target===m)m.remove();};
  m.innerHTML=`
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title">CREATE INVOICE</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div class="form-group">
        <label class="form-label">Customer *</label>
        <div class="cpicker-wrap" id="ci-cpicker-wrap">
          <div class="cpicker-input" id="ci-cpicker-btn" onclick="toggleCpicker('ci')">
            <span class="cpicker-placeholder" id="ci-cpicker-placeholder">Search by name or CargoLink IDâ€¦</span>
            <div class="cpicker-selected" id="ci-cpicker-selected" style="display:none;"></div>
            <i class="ti ti-chevron-down cpicker-arrow"></i>
          </div>
          <div class="cpicker-dropdown" id="ci-cpicker-dropdown" style="display:none;">
            <div class="cpicker-search"><i class="ti ti-search" style="color:var(--text-3);"></i><input type="text" id="ci-cpicker-search" placeholder="Search name or IDâ€¦" oninput="filterCpicker('ci')"></div>
            <div class="cpicker-list" id="ci-cpicker-list"></div>
          </div>
        </div>
        <input type="hidden" id="ci-custid" value="">
        <input type="hidden" id="ci-cust-uuid" value="">
        <input type="hidden" id="ci-cust-email" value="">
        <input type="hidden" id="ci-cust-name" value="">
      </div>
      <div class="form-group">
        <label class="form-label">Linked Shipment (optional)</label>
        <div class="tpicker-wrap" id="ci-tpicker-wrap">
          <input class="form-input" id="ci-tracking" placeholder="Type to search tracking #â€¦" autocomplete="off" oninput="filterTpicker('ci')" onfocus="showTpicker('ci')" style="font-family:'JetBrains Mono',monospace;">
          <div class="tpicker-dropdown" id="ci-tpicker-dropdown">
            <div class="tpicker-list" id="ci-tpicker-list"></div>
          </div>
        </div>
      </div>
      <div class="form-grid-2">
        <div class="form-group"><label class="form-label">Amount (USD) *</label><input class="form-input" id="ci-amount" type="number" step="0.01" placeholder="85.00"></div>
        <div class="form-group"><label class="form-label">Due Date *</label><input class="form-input" id="ci-due" type="date"></div>
      </div>
      <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="ci-desc" placeholder="Air freight â€” 3.2 kg package"></div>
      <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;color:var(--text-2);">
          <input type="checkbox" id="ci-notify" checked style="accent-color:var(--amber);">
          Email invoice to customer
        </label>
      </div>
      <button class="btn btn-amber" style="width:100%;" onclick="submitCreateInvoice()">Create Invoice <i class="ti ti-arrow-right"></i></button>
    </div>`;
  el('modals').appendChild(m);
  setTimeout(()=>populateCpicker('ci'), 0);
}

async function submitCreateInvoice() {
  const amount=parseFloat(el('ci-amount')?.value||0);
  const due=el('ci-due')?.value;
  const desc=el('ci-desc')?.value?.trim();
  if(!amount||!due) return toast('Please fill amount and due date.','error');
  if(!DEMO_MODE&&sb){
    const custUUID  = el('ci-cust-uuid')?.value?.trim();
    const custEmail = el('ci-cust-email')?.value?.trim();
    const custName  = el('ci-cust-name')?.value?.trim() || 'Customer';
    if(!custUUID) return toast('Please select a customer.','error');
    const {data:invData, error}=await sb.from('invoices').insert({customer_id:custUUID,amount,due_date:due,description:desc,status:'unpaid'}).select().single();
    if(error) return toast(error.message,'error');
    // Insert a notification so customer sees the invoice immediately
    await sb.from('notifications').insert({
      customer_id: custUUID,
      title: 'New Invoice Created',
      message: `Invoice for ${desc||'shipping charge'} â€” $${parseFloat(amount).toFixed(2)} due on ${due}. Please log in to view and pay.`,
      read: false,
      created_at: new Date().toISOString()
    });
    if(el('ci-notify')?.checked && custEmail) {
      // Send email via EmailJS
      if(!EMAILJS_PUBLIC_KEY.includes('YOUR')) {
        try {
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_INVOICE, {
            to_name:       custName,
            to_email:      custEmail,
            admin_message: 'You have a new invoice from CaribCargo.\n\nInvoice #: ' + (invData?.id||'').slice(-6) + '\nAmount: ' + fmt$(amount) + '\nDescription: ' + (desc||'Shipping charge') + '\nDue Date: ' + due + '\n\nPlease log in to your dashboard to view and pay your invoice.',
          });
          toast(`Invoice emailed to ${custEmail}`,'success');
        } catch(e) { console.warn('Invoice email failed:', e); toast(`Invoice created but email failed: ${e.text||e.message}`,'info'); }
      } else {
        toast(`Invoice created! (Add EmailJS keys to send email to ${custEmail})`,'info');
      }
    }
  }
  document.querySelector('.modal-overlay')?.remove();
  toast('Invoice created!','success');
  await refreshAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDemoShipments(n=8) {
  const statuses=['pending','received','in_transit','customs','ready','delivered'];
  const types=['General','Barrel','Air','Vehicle','Cold Chain'];
  const names=['Sarah Brown','Michael Thompson','Keisha Williams','Devon Green','Tracey Clarke'];
  const descs=['Clothing & Shoes','Electronics','Household Items','Tools & Hardware','Food Items & Spices','Books & Media','Beauty Products','Auto Parts'];
  return Array.from({length:n},(_,i)=>({
    id:'shipment-'+i,
    tracking_number:`CCJ-2024-${String(10023+i).padStart(5,'0')}`,
    description:descs[i%8],ship_type:types[i%5],weight:(2.5+i*1.3).toFixed(1),
    status:statuses[i%statuses.length],
    created_at:new Date(Date.now()-i*86400000*7).toISOString(),
    customer_id:currentProfile?.id||'demo-user',
    notes:i%3===0?'Handle with care':'',
    profiles:{full_name:names[i%5],cargolink_id:`CL-0000${(i%5)+1}`,email:`demo${i}@test.com`,country:'Jamaica'}
  }));
}

function getDemoInvoices(n=5) {
  return Array.from({length:n},(_,i)=>({
    id:'inv-'+i,customer_id:'demo-user',
    amount:(45+i*25.5).toFixed(2),status:i%3===0?'unpaid':'paid',
    due_date:new Date(Date.now()+(i-1)*86400000*14).toISOString().slice(0,10),
    description:`Shipping charge for CCJ-2024-${String(10023+i).padStart(5,'0')}`,
    created_at:new Date(Date.now()-i*86400000*5).toISOString()
  }));
}

function getDemoCustomers() {
  return [
    {id:'c1',full_name:'Sarah Brown',email:'sarah@email.com',phone:'876-555-0110',country:'Jamaica',cargolink_id:'CL-00001',trn:'123-456-789',delivery_pref:'door',created_at:new Date(Date.now()-86400000*90).toISOString()},
    {id:'c2',full_name:'Michael Thompson',email:'mthompson@email.com',phone:'876-555-0222',country:'Jamaica',cargolink_id:'CL-00002',created_at:new Date(Date.now()-86400000*60).toISOString()},
    {id:'c3',full_name:'Keisha Williams',email:'kwilliams@email.com',phone:'246-555-0333',country:'Barbados',cargolink_id:'CL-00003',created_at:new Date(Date.now()-86400000*30).toISOString()},
    {id:'c4',full_name:'Devon Green',email:'dgreen@email.com',phone:'1-868-555-0444',country:'Trinidad and Tobago',cargolink_id:'CL-00004',created_at:new Date(Date.now()-86400000*10).toISOString()},
    {id:'c5',full_name:'Tracey Clarke',email:'tclarke@email.com',phone:'1-345-555-0555',country:'Cayman Islands',cargolink_id:'CL-00005',created_at:new Date(Date.now()-86400000*5).toISOString()},
  ];
}

function getDemoNotifications() {
  return [
    {id:'n1',title:'Package Received',message:'Your package CCJ-2024-10023 (Clothing & Shoes) has arrived at our Miami warehouse.',read:false,created_at:new Date(Date.now()-86400000*1).toISOString()},
    {id:'n2',title:'Shipment In Transit',message:'CCJ-2024-10024 is now in transit and expected to arrive in Kingston within 5 business days.',read:false,created_at:new Date(Date.now()-86400000*3).toISOString()},
    {id:'n3',title:'Invoice Created',message:'Invoice #inv-002 for $95.50 is due on Feb 28, 2024.',read:true,created_at:new Date(Date.now()-86400000*7).toISOString()},
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS BACKGROUNDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initHeroCanvas() {
  const canvas=el('heroCanvas'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let W=canvas.width=canvas.offsetWidth,H=canvas.height=canvas.offsetHeight;
  window.addEventListener('resize',()=>{W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight;});
  const pts=Array.from({length:55},()=>({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.25,vy:(Math.random()-.5)*.25,r:Math.random()*1.5+.5}));
  function draw(){
    ctx.clearRect(0,0,W,H);
    pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle='rgba(245,158,11,0.2)';ctx.fill();});
    for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){const dx=pts[i].x-pts[j].x,dy=pts[i].y-pts[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<120){ctx.beginPath();ctx.moveTo(pts[i].x,pts[i].y);ctx.lineTo(pts[j].x,pts[j].y);ctx.strokeStyle=`rgba(245,158,11,${(1-d/120)*.07})`;ctx.lineWidth=.8;ctx.stroke();}}
    requestAnimationFrame(draw);
  }
  draw();
}

function initMiniCanvas(id) {
  const canvas=el(id); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let W=canvas.width=canvas.offsetWidth,H=canvas.height=canvas.offsetHeight;
  const pts=Array.from({length:30},()=>({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.2,vy:(Math.random()-.5)*.2,r:Math.random()*1.2+.4}));
  function draw(){ctx.clearRect(0,0,W,H);pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fillStyle='rgba(245,158,11,0.15)';ctx.fill();});for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){const dx=pts[i].x-pts[j].x,dy=pts[i].y-pts[j].y,d=Math.sqrt(dx*dx+dy*dy);if(d<100){ctx.beginPath();ctx.moveTo(pts[i].x,pts[i].y);ctx.lineTo(pts[j].x,pts[j].y);ctx.strokeStyle=`rgba(245,158,11,${(1-d/100)*.05})`;ctx.lineWidth=.7;ctx.stroke();}}requestAnimationFrame(draw);}
  draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RATES SYSTEM â€” persistent landing page rate editing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RATES_KEY = 'cc_rates';
const RATES_DEFAULT = {
  airPrice:'$12', airUnit:'/lb', airTime:'2â€“5 business days',
  seaPrice:'$6.50', seaUnit:'/lb', seaTime:'10â€“14 business days',
  barrelPrice:'$95', barrelUnit:'/barrel', barrelTime:'10â€“14 business days',
  svcGeneral:'From $6.50/lb Â· Air & Sea', svcBarrel:'From $95/barrel Â· Sea Freight',
  svcAir:'From $12/lb Â· Air Only', svcVehicle:'From $850 Â· Sea Freight',
  svcCold:'From $8/lb Â· Refrigerated', svcMachinery:'Custom quote Â· Contact us'
};

function getRates() {
  try { return Object.assign({}, RATES_DEFAULT, JSON.parse(localStorage.getItem(RATES_KEY)||'{}')); }
  catch(e) { return Object.assign({}, RATES_DEFAULT); }
}

function applyRates() {
  const r = getRates();
  const s = (id,v) => { const e=el(id); if(e) e.textContent=v; };
  s('rateAirPrice',r.airPrice); s('rateAirUnit',r.airUnit); s('rateAirTime',r.airTime);
  s('rateSeaPrice',r.seaPrice); s('rateSeaUnit',r.seaUnit); s('rateSeaTime',r.seaTime);
  s('rateBarrelPrice',r.barrelPrice); s('rateBarrelUnit',r.barrelUnit); s('rateBarrelTime',r.barrelTime);
  s('svcRateGeneral',r.svcGeneral); s('svcRateBarrel',r.svcBarrel); s('svcRateAir',r.svcAir);
  s('svcRateVehicle',r.svcVehicle); s('svcRateCold',r.svcCold); s('svcRateMachinery',r.svcMachinery);
}

function openRatesModal() {
  const r = getRates();
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.innerHTML = `
    <div class="modal-box xl" style="max-width:820px;">
      <div class="modal-head">
        <span class="modal-title">EDIT LANDING PAGE RATES</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <p style="font-size:0.84rem;color:var(--text-2);margin-bottom:1.25rem;">Changes apply instantly to the public landing page and persist for all visitors.</p>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem;margin-bottom:1.25rem;">
        <div>
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--amber);margin-bottom:0.75rem;padding-bottom:0.4rem;border-bottom:1px solid rgba(245,158,11,0.2);">âœˆ Air Freight</div>
          <div class="form-group"><label class="form-label">Price Display</label><input class="form-input" id="re-airPrice" value="${r.airPrice}" placeholder="e.g. $12"></div>
          <div class="form-group"><label class="form-label">Unit</label><input class="form-input" id="re-airUnit" value="${r.airUnit}" placeholder="e.g. /lb"></div>
          <div class="form-group"><label class="form-label">Delivery Time</label><input class="form-input" id="re-airTime" value="${r.airTime}" placeholder="e.g. 2â€“5 business days"></div>
          <div class="form-group"><label class="form-label">Service Card Rate Text</label><input class="form-input" id="re-svcAir" value="${r.svcAir}"></div>
        </div>
        <div>
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--blue);margin-bottom:0.75rem;padding-bottom:0.4rem;border-bottom:1px solid rgba(59,130,246,0.2);">ðŸš¢ Sea Freight</div>
          <div class="form-group"><label class="form-label">Price Display</label><input class="form-input" id="re-seaPrice" value="${r.seaPrice}"></div>
          <div class="form-group"><label class="form-label">Unit</label><input class="form-input" id="re-seaUnit" value="${r.seaUnit}"></div>
          <div class="form-group"><label class="form-label">Delivery Time</label><input class="form-input" id="re-seaTime" value="${r.seaTime}"></div>
          <div class="form-group"><label class="form-label">Service Card Rate Text</label><input class="form-input" id="re-svcGeneral" value="${r.svcGeneral}"></div>
        </div>
        <div>
          <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--green);margin-bottom:0.75rem;padding-bottom:0.4rem;border-bottom:1px solid rgba(16,185,129,0.2);">ðŸ›¢ Barrel</div>
          <div class="form-group"><label class="form-label">Price Display</label><input class="form-input" id="re-barrelPrice" value="${r.barrelPrice}"></div>
          <div class="form-group"><label class="form-label">Unit</label><input class="form-input" id="re-barrelUnit" value="${r.barrelUnit}"></div>
          <div class="form-group"><label class="form-label">Delivery Time</label><input class="form-input" id="re-barrelTime" value="${r.barrelTime}"></div>
          <div class="form-group"><label class="form-label">Service Card Rate Text</label><input class="form-input" id="re-svcBarrel" value="${r.svcBarrel}"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem;">
        <div class="form-group"><label class="form-label">Vehicle Shipping Rate</label><input class="form-input" id="re-svcVehicle" value="${r.svcVehicle}"></div>
        <div class="form-group"><label class="form-label">Cold Chain Rate</label><input class="form-input" id="re-svcCold" value="${r.svcCold}"></div>
      </div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-ghost btn-sm" onclick="resetRates()"><i class="ti ti-refresh"></i> Reset to Default</button>
        <button class="btn btn-amber" style="margin-left:auto;" onclick="saveRates()"><i class="ti ti-check"></i> Save All Rates</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
}

function saveRates() {
  const g = id => el(id)?.value?.trim() || '';
  const rates = {
    airPrice: g('re-airPrice') || RATES_DEFAULT.airPrice,
    airUnit:  g('re-airUnit')  || RATES_DEFAULT.airUnit,
    airTime:  g('re-airTime')  || RATES_DEFAULT.airTime,
    seaPrice: g('re-seaPrice') || RATES_DEFAULT.seaPrice,
    seaUnit:  g('re-seaUnit')  || RATES_DEFAULT.seaUnit,
    seaTime:  g('re-seaTime')  || RATES_DEFAULT.seaTime,
    barrelPrice: g('re-barrelPrice') || RATES_DEFAULT.barrelPrice,
    barrelUnit:  g('re-barrelUnit')  || RATES_DEFAULT.barrelUnit,
    barrelTime:  g('re-barrelTime')  || RATES_DEFAULT.barrelTime,
    svcGeneral:  g('re-svcGeneral')  || RATES_DEFAULT.svcGeneral,
    svcBarrel:   g('re-svcBarrel')   || RATES_DEFAULT.svcBarrel,
    svcAir:      g('re-svcAir')      || RATES_DEFAULT.svcAir,
    svcVehicle:  g('re-svcVehicle')  || RATES_DEFAULT.svcVehicle,
    svcCold:     g('re-svcCold')     || RATES_DEFAULT.svcCold,
    svcMachinery: RATES_DEFAULT.svcMachinery,
  };
  localStorage.setItem(RATES_KEY, JSON.stringify(rates));
  applyRates();
  document.querySelector('.modal-overlay')?.remove();
  toast('âœ“ Rates updated on landing page!', 'success');
}

function resetRates() {
  localStorage.removeItem(RATES_KEY);
  applyRates();
  document.querySelector('.modal-overlay')?.remove();
  toast('Rates reset to default.','info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAFF & ROLES SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAFF_KEY = 'cc_staff';
const ADMIN_TABS = [
  {id:'overview',   label:'Overview',          icon:'ti-dashboard'},
  {id:'customers',  label:'Customers',          icon:'ti-users'},
  {id:'shipments',  label:'All Shipments',      icon:'ti-package'},
  {id:'pending',    label:'Pending Queue',      icon:'ti-clock-hour-4'},
  {id:'invoices',   label:'Invoices',           icon:'ti-receipt'},
  {id:'updates',    label:'Send Update',        icon:'ti-send'},
  {id:'messages',   label:'Message Customer',  icon:'ti-message-dots'},
  {id:'reports',    label:'Reports',            icon:'ti-chart-line'},
  {id:'exports',    label:'Exports',            icon:'ti-download'},
  {id:'data',       label:'Data Management',    icon:'ti-database-x'},
  {id:'settings',   label:'Settings',           icon:'ti-settings'},
];

function getStaff() {
  try { return JSON.parse(localStorage.getItem(STAFF_KEY)||'[]'); }
  catch(e) { return []; }
}
function setStaff(list) { localStorage.setItem(STAFF_KEY, JSON.stringify(list)); }

function renderStaffTab() {
  // Update owner card
  const p = currentProfile;
  if(p) {
    const initials = (p.full_name||'A').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const ownerAv = el('ownerAvatar'); if(ownerAv) ownerAv.textContent=initials;
    const ownerNm = el('staffOwnerName'); if(ownerNm) ownerNm.textContent=p.full_name||'Admin';
    const ownerEm = el('staffOwnerEmail'); if(ownerEm) ownerEm.textContent=p.email||'â€”';
  }
  const staff = getStaff();
  const countEl = el('staffCount'); if(countEl) countEl.textContent=staff.length;
  const listEl = el('staffList'); if(!listEl) return;

  if(!staff.length) {
    listEl.innerHTML=`<div style="text-align:center;padding:2.5rem 1rem;color:var(--text-3);">
      <i class="ti ti-users-group" style="font-size:2rem;display:block;margin-bottom:0.5rem;opacity:0.25;"></i>
      No employees yet. Add one with the button above.
    </div>`;
    return;
  }

  listEl.innerHTML = staff.map((emp, i) => {
    const initials = emp.name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const allowed = ADMIN_TABS.filter(t=>emp.perms[t.id]);
    const locked  = ADMIN_TABS.filter(t=>!emp.perms[t.id]);
    return `<div class="staff-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.75rem;margin-bottom:1rem;">
        <div style="display:flex;align-items:center;gap:0.75rem;">
          <div style="width:40px;height:40px;border-radius:50%;background:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.25);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--blue);font-size:0.9rem;flex-shrink:0;">${initials}</div>
          <div>
            <div style="font-weight:700;font-size:0.925rem;display:flex;align-items:center;gap:0.5rem;">${emp.name} <span class="badge badge-blue" style="font-size:0.6rem;">ðŸ’¼ Employee</span></div>
            <div style="font-size:0.8rem;color:var(--text-2);margin-top:0.1rem;">${emp.email}</div>
            <div style="font-size:0.7rem;color:var(--text-3);margin-top:0.1rem;">Added ${fmtDate(emp.added)}</div>
          </div>
        </div>
        <div style="display:flex;gap:0.4rem;flex-shrink:0;">
          <button class="btn btn-ghost btn-sm" onclick="openEditPermsModal(${i})" title="Edit permissions"><i class="ti ti-edit"></i> Perms</button>
          <button class="btn btn-danger btn-sm" onclick="removeStaff(${i})" title="Remove employee"><i class="ti ti-trash"></i></button>
        </div>
      </div>
      <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);margin-bottom:0.45rem;">Access</div>
      <div style="display:flex;flex-wrap:wrap;gap:0.3rem;">
        ${allowed.map(t=>`<span style="display:inline-flex;align-items:center;gap:0.25rem;padding:0.2rem 0.55rem;border-radius:6px;font-size:0.7rem;font-weight:600;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:var(--green);"><i class="ti ${t.icon}" style="font-size:0.65rem;"></i>${t.label}</span>`).join('')}
        ${locked.map(t=>`<span style="display:inline-flex;align-items:center;gap:0.25rem;padding:0.2rem 0.55rem;border-radius:6px;font-size:0.7rem;font-weight:600;background:rgba(255,255,255,0.02);border:1px solid var(--border);color:var(--text-3);opacity:0.55;"><i class="ti ti-lock" style="font-size:0.65rem;"></i>${t.label}</span>`).join('')}
      </div>
    </div>`;
  }).join('');
}

function buildPermsUI(currentPerms, prefix) {
  return `<div style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:12px;padding:0.75rem 1rem;">
    ${ADMIN_TABS.map(t=>`
      <div class="perm-row">
        <div style="display:flex;align-items:center;gap:0.6rem;font-size:0.875rem;">
          <i class="ti ${t.icon}" style="color:var(--text-2);width:16px;text-align:center;font-size:0.9rem;"></i>
          ${t.label}
        </div>
        <label class="tog">
          <input type="checkbox" id="${prefix}-${t.id}" ${(currentPerms&&currentPerms[t.id])?'checked':''}>
          <span class="tog-slider"></span>
        </label>
      </div>`).join('')}
  </div>`;
}

function openAddStaffModal() {
  const defaultPerms = {};
  ADMIN_TABS.forEach(t => { defaultPerms[t.id] = ['overview','shipments','customers'].includes(t.id); });
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.innerHTML = `
    <div class="modal-box lg" style="max-width:600px;">
      <div class="modal-head">
        <span class="modal-title">ADD EMPLOYEE</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div class="form-grid-2" style="margin-bottom:0.25rem;">
        <div class="form-group"><label class="form-label">Full Name *</label><input class="form-input" id="ns-name" placeholder="Jane Smith" list="staffNameSuggestions"><datalist id="staffNameSuggestions"></datalist></div>
        <div class="form-group"><label class="form-label">Email Address *</label><input class="form-input" id="ns-email" type="email" placeholder="jane@company.com" list="staffEmailSuggestions"><datalist id="staffEmailSuggestions"></datalist></div>
      </div>
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-2);margin-bottom:0.6rem;margin-top:0.25rem;">Tab Permissions â€” toggle on/off</div>
      ${buildPermsUI(defaultPerms,'ns')}
      <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
        <button class="btn btn-ghost" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-amber" style="flex:1;" onclick="submitAddStaff()"><i class="ti ti-user-plus"></i> Add Employee</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
  // Populate datalists from existing customers
  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  const nameList = el('staffNameSuggestions');
  const emailList = el('staffEmailSuggestions');
  if(nameList)  nameList.innerHTML  = custs.map(c=>`<option value="${c.full_name||''}">`).join('');
  if(emailList) emailList.innerHTML = custs.map(c=>`<option value="${c.email||''}">`).join('');
}

async function submitAddStaff() {
  const name  = el('ns-name')?.value?.trim();
  const email = el('ns-email')?.value?.trim().toLowerCase();
  if(!name||!email) return toast('Please enter name and email.','error');
  if(!/\S+@\S+\.\S+/.test(email)) return toast('Please enter a valid email address.','error');
  const staff = getStaff();
  if(staff.find(s=>s.email===email)) return toast('An employee with this email already exists.','error');
  const perms = {};
  ADMIN_TABS.forEach(t => { perms[t.id] = !!(el('ns-'+t.id)?.checked); });
  staff.push({ name, email, perms, added: new Date().toISOString() });
  setStaff(staff);

  // Also update their Supabase profile role to 'employee' so they can log in from any device
  if(!DEMO_MODE && sb) {
    try {
      const { data: profile } = await sb.from('profiles').select('id').eq('email', email).single();
      if(profile) {
        await sb.from('profiles').update({ role: 'employee' }).eq('id', profile.id);
      } else {
        toast('âš  Employee added locally, but no Supabase account found for ' + email + '. They must register first.', 'info');
      }
    } catch(e) { console.warn('Could not update employee role in DB:', e.message); }
  }

  document.querySelector('.modal-overlay')?.remove();
  renderStaffTab();
  toast(`âœ“ ${name} added as employee! Their role in Supabase has been updated.`, 'success');
}

function openEditPermsModal(idx) {
  const staff = getStaff();
  const emp = staff[idx];
  if(!emp) return;
  const initials = emp.name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.innerHTML = `
    <div class="modal-box lg" style="max-width:600px;">
      <div class="modal-head">
        <span class="modal-title">EDIT PERMISSIONS</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem;padding:0.875rem;background:rgba(59,130,246,0.05);border:1px solid rgba(59,130,246,0.15);border-radius:10px;">
        <div style="width:36px;height:36px;border-radius:50%;background:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.25);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--blue);">${initials}</div>
        <div><div style="font-weight:700;">${emp.name}</div><div style="font-size:0.8rem;color:var(--text-2);">${emp.email}</div></div>
      </div>
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-2);margin-bottom:0.6rem;">Tab Permissions</div>
      ${buildPermsUI(emp.perms,'ep')}
      <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
        <button class="btn btn-ghost" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-amber" style="flex:1;" onclick="saveStaffPerms(${idx})"><i class="ti ti-check"></i> Save Permissions</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
}

function saveStaffPerms(idx) {
  const staff = getStaff();
  if(!staff[idx]) return;
  const perms = {};
  ADMIN_TABS.forEach(t => { perms[t.id] = !!(el('ep-'+t.id)?.checked); });
  staff[idx].perms = perms;
  setStaff(staff);
  document.querySelector('.modal-overlay')?.remove();
  renderStaffTab();
  toast('âœ“ Permissions saved!', 'success');
}

async function removeStaff(idx) {
  const staff = getStaff();
  const emp = staff[idx];
  if(!emp) return;
  if(!confirm(`Remove ${emp.name} from staff? They'll lose all access.`)) return;
  staff.splice(idx,1);
  setStaff(staff);
  // Revert their DB role back to customer
  if(!DEMO_MODE && sb) {
    try {
      await sb.from('profiles').update({ role: 'customer' }).eq('email', emp.email);
    } catch(e) { console.warn('Could not revert employee role:', e.message); }
  }
  renderStaffTab();
  toast(`${emp.name} removed from staff.`, 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORTS â€” CSV downloads
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dlCSV(filename, headers, rows) {
  const csv = [headers, ...rows].map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})),
    download: filename
  });
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function exportCSV(type) {
  const custs  = DEMO_MODE ? getDemoCustomers()   : (allCustomers||[]);
  const ships  = DEMO_MODE ? getDemoShipments(20)  : (window._adminShipments||[]);
  const invs   = DEMO_MODE ? getDemoInvoices(15)   : (allInvoices||[]);
  const date   = new Date().toISOString().slice(0,10);

  if(type==='customers') {
    if(!custs.length) return toast('No customers to export.','info');
    dlCSV(`CaribCargo_Customers_${date}.csv`,
      ['CargoLink ID','Full Name','Email','Phone','Country','City','Region','Delivery Pref','Joined'],
      custs.map(c=>[c.cargolink_id,c.full_name,c.email,c.phone,c.country,c.city,c.region,c.delivery_pref,fmtDate(c.created_at)]));
    toast(`âœ“ Customers CSV downloaded (${custs.length} rows)`,'success');
  }
  else if(type==='shipments') {
    if(!ships.length) return toast('No shipments to export.','info');
    dlCSV(`CaribCargo_Shipments_${date}.csv`,
      ['Tracking #','Customer Name','CargoLink ID','Type','Weight (kg)','Status','Description','Declared Value','Notes','Date'],
      ships.map(s=>[s.tracking_number,s.profiles?.full_name,s.profiles?.cargolink_id,s.ship_type,s.weight,s.status,s.description,s.declared_value,s.notes,fmtDate(s.created_at)]));
    toast(`âœ“ Shipments CSV downloaded (${ships.length} rows)`,'success');
  }
  else if(type==='invoices') {
    if(!invs.length) return toast('No invoices to export.','info');
    const custMap = Object.fromEntries(custs.map(c=>[c.id,c]));
    dlCSV(`CaribCargo_Invoices_${date}.csv`,
      ['Invoice ID','Customer Name','CargoLink ID','Amount','Status','Description','Due Date','Created'],
      invs.map(inv=>{const c=custMap[inv.customer_id]||{};return[(inv.id||'').slice(-8),c.full_name||inv.profiles?.full_name,c.cargolink_id,fmt$(inv.amount),inv.status,inv.description,fmtDate(inv.due_date),fmtDate(inv.created_at)];}));
    toast(`âœ“ Invoices CSV downloaded (${invs.length} rows)`,'success');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINT REPORTS â€” open in new branded window
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRINT_STYLES = `
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,Helvetica,sans-serif;color:#111;background:#fff;font-size:13px}
  .hdr{background:#030c1a;color:#fff;padding:1.4rem 2rem;display:flex;align-items:flex-start;justify-content:space-between}
  .hdr-logo{font-family:'Arial Black',sans-serif;font-size:1.2rem;font-weight:900;letter-spacing:0.08em;color:#f59e0b;margin-bottom:0.2rem}
  .hdr-sub{font-size:0.72rem;color:#9c9286}
  .hdr-right{text-align:right;font-size:0.78rem;color:#9c9286}
  .hdr-right strong{color:#f59e0b;font-size:1rem;display:block}
  .body{padding:1.5rem 2rem}
  .section-lbl{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:#9c9286;margin:1.25rem 0 0.75rem;padding-bottom:0.35rem;border-bottom:2px solid #f3f4f6}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:1rem}
  .stat{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:0.875rem;text-align:center}
  .stat-n{font-size:1.75rem;font-weight:900;line-height:1}
  .stat-l{font-size:0.65rem;color:#6b7280;margin-top:0.2rem}
  table{width:100%;border-collapse:collapse;font-size:0.78rem}
  th{background:#f3f4f6;padding:0.45rem 0.75rem;text-align:left;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.07em;color:#6b7280;border-bottom:1px solid #e5e7eb}
  td{padding:0.55rem 0.75rem;border-bottom:1px solid #f3f4f6;vertical-align:middle}
  tr:hover td{background:#fffbeb}
  .ftr{margin-top:2rem;padding:0.875rem 2rem;background:#f9fafb;border-top:1px solid #e5e7eb;font-size:0.7rem;color:#9c9286;display:flex;justify-content:space-between}
  .print-btn{position:fixed;top:1rem;right:1rem;background:#f59e0b;color:#000;border:none;padding:0.55rem 1.1rem;border-radius:8px;font-weight:700;cursor:pointer;font-size:0.875rem;z-index:999;font-family:Arial,sans-serif;box-shadow:0 4px 16px rgba(245,158,11,0.4)}
  .print-btn:hover{background:#d97706}
  @media print{.print-btn{display:none!important}}
  .sig-line{border-top:1px solid #374151;margin-top:2.5rem;padding-top:0.4rem;font-size:0.68rem;color:#9c9286}
  .manifest-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1rem}
  .meta-box{background:#071120;border-radius:6px;padding:0.75rem}
  .meta-lbl{font-size:0.58rem;text-transform:uppercase;letter-spacing:0.08em;color:#9c9286;margin-bottom:0.15rem}
  .meta-val{font-weight:700;color:#fff;font-size:0.875rem}
`;

function openPrintWindow(title, bodyHTML) {
  const w = window.open('','_blank','width=1100,height=900');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>${PRINT_STYLES}</style></head><body><button class="print-btn" onclick="window.print()">ðŸ–¨ Print / Save as PDF</button>${bodyHTML}</body></html>`);
  w.document.close();
}

function printReport(type) {
  const custs = DEMO_MODE ? getDemoCustomers()  : (allCustomers||[]);
  const ships = DEMO_MODE ? getDemoShipments(20) : (window._adminShipments||[]);
  const invs  = DEMO_MODE ? getDemoInvoices(15)  : (allInvoices||[]);
  const now   = new Date();
  const mon   = now.toLocaleString('en-US',{month:'long',year:'numeric'});
  const today = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  if(type==='summary') {
    const paid   = invs.filter(i=>i.status==='paid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
    const unpaid = invs.filter(i=>i.status==='unpaid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
    const statCounts = {};
    ships.forEach(s=>{statCounts[s.status]=(statCounts[s.status]||0)+1;});
    const custMap2 = {};
    ships.forEach(s=>{const n=s.profiles?.full_name||'Unknown';custMap2[n]=(custMap2[n]||0)+1;});
    const topC = Object.entries(custMap2).sort((a,b)=>b[1]-a[1]).slice(0,5);

    openPrintWindow(`CaribCargo Monthly Summary â€” ${mon}`, `
      <div class="hdr">
        <div><div class="hdr-logo">âš“ CARIBCARGO</div><div class="hdr-sub">Monthly Operations Summary</div></div>
        <div class="hdr-right"><strong>${mon}</strong>${today}</div>
      </div>
      <div class="body">
        <div class="section-lbl">Performance Overview</div>
        <div class="stats">
          <div class="stat"><div class="stat-n">${custs.length}</div><div class="stat-l">Total Customers</div></div>
          <div class="stat"><div class="stat-n">${ships.length}</div><div class="stat-l">Total Shipments</div></div>
          <div class="stat"><div class="stat-n" style="color:#059669;">${fmt$(paid)}</div><div class="stat-l">Revenue Collected</div></div>
          <div class="stat"><div class="stat-n" style="color:#dc2626;">${fmt$(unpaid)}</div><div class="stat-l">Outstanding Balance</div></div>
        </div>
        <div class="section-lbl">Status Breakdown</div>
        <table><thead><tr><th>Status</th><th>Count</th><th>% of Total</th></tr></thead><tbody>
          ${Object.entries(statCounts).map(([s,n])=>`<tr><td>${s.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</td><td style="font-weight:700;">${n}</td><td>${ships.length?((n/ships.length*100).toFixed(1)+'%'):'â€”'}</td></tr>`).join('')}
        </tbody></table>
        <div class="section-lbl">Top 5 Customers by Volume</div>
        <table><thead><tr><th>#</th><th>Customer</th><th>Shipments</th><th>Est. Revenue</th></tr></thead><tbody>
          ${topC.map(([n,c],i)=>`<tr><td style="font-weight:700;color:#9c9286;">${i+1}</td><td>${n}</td><td style="font-weight:700;">${c}</td><td style="color:#059669;">${fmt$(c*85)}</td></tr>`).join('')}
        </tbody></table>
        <div class="section-lbl">Recent Shipments</div>
        <table><thead><tr><th>Tracking #</th><th>Customer</th><th>Type</th><th>Weight</th><th>Status</th><th>Date</th></tr></thead><tbody>
          ${ships.slice(0,15).map(s=>`<tr><td style="font-family:monospace;font-weight:700;">${s.tracking_number}</td><td>${s.profiles?.full_name||'â€”'}</td><td>${s.ship_type||'General'}</td><td>${s.weight||'â€”'} kg</td><td>${s.status}</td><td>${fmtDate(s.created_at)}</td></tr>`).join('')}
        </tbody></table>
      </div>
      <div class="ftr"><span>CaribCargo Ltd. â€” Confidential Internal Report</span><span>Generated ${now.toLocaleString()}</span></div>`);
  }

  else if(type==='manifest') {
    const active = ships.filter(s=>!['delivered','cancelled'].includes(s.status));
    const ref    = `CCM-${now.getFullYear()}-${String(Math.floor(Math.random()*9999+1)).padStart(4,'0')}`;
    const totalW = active.reduce((s,sh)=>s+parseFloat(sh.weight||0),0).toFixed(1);
    openPrintWindow(`CaribCargo Manifest ${ref}`, `
      <div class="hdr" style="flex-direction:column;">
        <div style="display:flex;justify-content:space-between;width:100%;">
          <div><div class="hdr-logo">âš“ CARIBCARGO CARGO MANIFEST</div><div class="hdr-sub">Official Shipping Document</div></div>
          <div class="hdr-right"><strong>${ref}</strong>${today}</div>
        </div>
        <div class="manifest-meta" style="margin-top:1rem;">
          <div class="meta-box"><div class="meta-lbl">Origin</div><div class="meta-val">2210 NW 102nd Ave, Miami FL 33172</div></div>
          <div class="meta-box"><div class="meta-lbl">Destination</div><div class="meta-val">Caribbean Region</div></div>
          <div class="meta-box"><div class="meta-lbl">Total Active</div><div class="meta-val">${active.length} shipments Â· ${totalW} kg</div></div>
        </div>
      </div>
      <div class="body">
        <table>
          <thead><tr><th>#</th><th>Tracking #</th><th>Consignee</th><th>CargoLink ID</th><th>Type</th><th>Weight kg</th><th>Declared Value</th><th>Status</th><th>Description</th></tr></thead>
          <tbody>${active.map((s,i)=>`<tr>
            <td style="color:#9c9286;">${i+1}</td>
            <td style="font-family:monospace;font-weight:700;color:#d97706;">${s.tracking_number}</td>
            <td style="font-weight:600;">${s.profiles?.full_name||'â€”'}</td>
            <td style="font-family:monospace;font-size:0.72rem;">${s.profiles?.cargolink_id||'â€”'}</td>
            <td>${s.ship_type||'General'}</td>
            <td style="text-align:right;">${s.weight||'â€”'}</td>
            <td style="text-align:right;">${s.declared_value?fmt$(s.declared_value):'â€”'}</td>
            <td>${s.status}</td>
            <td style="color:#6b7280;font-size:0.72rem;">${s.description||''}</td>
          </tr>`).join('')}</tbody>
        </table>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2.5rem;margin-top:2.5rem;">
          <div><div style="font-weight:700;font-size:0.78rem;margin-bottom:0.25rem;">Prepared By (CaribCargo Staff)</div><div class="sig-line">Signature &amp; Date</div></div>
          <div><div style="font-weight:700;font-size:0.78rem;margin-bottom:0.25rem;">Warehouse Supervisor</div><div class="sig-line">Signature &amp; Date</div></div>
          <div><div style="font-weight:700;font-size:0.78rem;margin-bottom:0.25rem;">Customs Officer</div><div class="sig-line">Signature &amp; Date</div></div>
        </div>
      </div>
      <div class="ftr"><span>CaribCargo Ltd. Â· Manifest Ref: ${ref} Â· OFFICIAL DOCUMENT</span><span>Generated ${now.toLocaleString()}</span></div>`);
  }
}

// â”€â”€ CUSTOMER DOSSIER â”€â”€
function openDossierModal(mode) {
  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.innerHTML = `
    <div class="modal-box" style="max-width:520px;">
      <div class="modal-head">
        <span class="modal-title">SELECT CUSTOMER</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <p style="font-size:0.84rem;color:var(--text-2);margin-bottom:1rem;">Choose a customer to generate their full account dossier (profile + all shipments + all invoices).</p>
      <div class="search-wrap" style="display:flex;width:100%;margin-bottom:0.75rem;">
        <i class="ti ti-search"></i>
        <input class="form-input" style="padding-left:2.25rem;width:100%;" placeholder="Search name, email, or CargoLink IDâ€¦" oninput="filterDossierSearch(this.value,'${mode}')">
      </div>
      <div id="dossierPickList" style="max-height:340px;overflow-y:auto;display:flex;flex-direction:column;gap:0.35rem;"></div>
    </div>`;
  el('modals').appendChild(m);
  window._dossierAll = custs;
  renderDossierList(custs, mode);
}

function renderDossierList(custs, mode) {
  const list = el('dossierPickList'); if(!list) return;
  if(!custs.length) { list.innerHTML=`<div style="text-align:center;padding:1.5rem;color:var(--text-3);">No customers found.</div>`; return; }
  list.innerHTML = custs.map(c=>{
    const init = (c.full_name||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    return `<div onclick="runDossier('${c.id}','${mode}')" style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='var(--border-2)';this.style.background='var(--card-2)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--card)'">
      <div style="width:36px;height:36px;border-radius:50%;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--amber);font-size:0.8rem;flex-shrink:0;">${init}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:0.88rem;">${c.full_name||'â€”'}</div>
        <div style="font-size:0.75rem;color:var(--text-2);">${c.email||''} &nbsp;Â·&nbsp; <span style="color:var(--amber);font-family:monospace;">${c.cargolink_id||''}</span> &nbsp;Â·&nbsp; ${c.country||''}</div>
      </div>
      <i class="ti ${mode==='print'?'ti-printer':'ti-download'}" style="color:var(--text-3);"></i>
    </div>`;
  }).join('');
}

function filterDossierSearch(q, mode) {
  const all = window._dossierAll || [];
  const filtered = q ? all.filter(c=>(c.full_name||'').toLowerCase().includes(q.toLowerCase())||(c.email||'').toLowerCase().includes(q.toLowerCase())||(c.cargolink_id||'').toLowerCase().includes(q.toLowerCase())) : all;
  renderDossierList(filtered, mode);
}

function runDossier(custId, mode) {
  const custs = DEMO_MODE ? getDemoCustomers()  : (allCustomers||[]);
  const ships = DEMO_MODE ? getDemoShipments(20) : (window._adminShipments||[]);
  const invs  = DEMO_MODE ? getDemoInvoices(15)  : (allInvoices||[]);
  const cust  = custs.find(c=>c.id===custId); if(!cust) return;
  document.querySelector('.modal-overlay')?.remove();

  const cShips = ships.filter(s=>s.customer_id===custId||(s.profiles?.cargolink_id&&s.profiles.cargolink_id===cust.cargolink_id));
  const cInvs  = invs.filter(i=>i.customer_id===custId);
  const date   = new Date().toISOString().slice(0,10);

  if(mode==='csv') {
    const rows = [
      ['=== PROFILE ===','','','','',''],
      ['Name',cust.full_name,'Email',cust.email,'Phone',cust.phone||''],
      ['Country',cust.country||'','CargoLink ID',cust.cargolink_id,'Joined',fmtDate(cust.created_at)],
      ['','','','','',''],
      ['=== SHIPMENTS ===','','','','',''],
      ['Tracking #','Type','Weight','Status','Description','Date'],
      ...cShips.map(s=>[s.tracking_number,s.ship_type,s.weight,s.status,s.description,fmtDate(s.created_at)]),
      ['','','','','',''],
      ['=== INVOICES ===','','','','',''],
      ['Invoice ID','Amount','Status','Description','Due Date','Created'],
      ...cInvs.map(i=>[(i.id||'').slice(-8),fmt$(i.amount),i.status,i.description,fmtDate(i.due_date),fmtDate(i.created_at)]),
    ];
    dlCSV(`CaribCargo_Dossier_${cust.cargolink_id}_${date}.csv`,['A','B','C','D','E','F'],rows);
    return toast(`âœ“ Dossier CSV for ${cust.full_name} downloaded!`,'success');
  }

  // Print
  const paid   = cInvs.filter(i=>i.status==='paid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
  const unpaid = cInvs.filter(i=>i.status==='unpaid').reduce((s,i)=>s+parseFloat(i.amount||0),0);
  const init = cust.full_name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  openPrintWindow(`Dossier â€” ${cust.full_name}`, `
    <div class="hdr">
      <div><div class="hdr-logo">âš“ CARIBCARGO CUSTOMER DOSSIER</div><div class="hdr-sub">Full Account Report</div>
        <div style="margin-top:0.75rem;display:flex;align-items:center;gap:0.875rem;">
          <div style="width:44px;height:44px;border-radius:50%;background:#f59e0b;display:flex;align-items:center;justify-content:center;font-weight:900;color:#000;font-size:1.1rem;">${init}</div>
          <div><div style="font-size:1.15rem;font-weight:900;color:#fff;">${cust.full_name}</div><div style="font-family:monospace;color:#f59e0b;">${cust.cargolink_id}</div></div>
        </div>
      </div>
      <div class="hdr-right"><strong>Generated</strong>${new Date().toLocaleDateString()}</div>
    </div>
    <div class="body">
      <div class="section-lbl">Profile</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1rem;">
        ${[['Email',cust.email],['Phone',cust.phone||'â€”'],['Country',cust.country||'â€”'],['City',cust.city||'â€”'],['Delivery Pref',cust.delivery_pref||'â€”'],['Member Since',fmtDate(cust.created_at)]].map(([l,v])=>`<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:0.75rem;"><div style="font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;color:#9c9286;margin-bottom:0.2rem;">${l}</div><div style="font-weight:600;font-size:0.85rem;">${v}</div></div>`).join('')}
      </div>
      <div class="stats">
        <div class="stat"><div class="stat-n">${cShips.length}</div><div class="stat-l">Shipments</div></div>
        <div class="stat"><div class="stat-n">${cShips.filter(s=>s.status==='delivered').length}</div><div class="stat-l">Delivered</div></div>
        <div class="stat"><div class="stat-n" style="color:#059669;">${fmt$(paid)}</div><div class="stat-l">Total Paid</div></div>
        <div class="stat"><div class="stat-n" style="color:#dc2626;">${fmt$(unpaid)}</div><div class="stat-l">Outstanding</div></div>
      </div>
      <div class="section-lbl">Shipment History (${cShips.length})</div>
      <table><thead><tr><th>Tracking #</th><th>Type</th><th>Weight</th><th>Status</th><th>Description</th><th>Date</th></tr></thead>
      <tbody>${cShips.length?cShips.map(s=>`<tr><td style="font-family:monospace;font-weight:700;color:#d97706;">${s.tracking_number}</td><td>${s.ship_type||'General'}</td><td>${s.weight||'â€”'} kg</td><td>${s.status}</td><td style="color:#6b7280;">${s.description||''}</td><td>${fmtDate(s.created_at)}</td></tr>`).join(''):'<tr><td colspan="6" style="text-align:center;color:#9c9286;padding:1.5rem;">No shipments found.</td></tr>'}</tbody></table>
      <div class="section-lbl">Invoice History (${cInvs.length})</div>
      <table><thead><tr><th>Invoice ID</th><th>Amount</th><th>Status</th><th>Description</th><th>Due Date</th></tr></thead>
      <tbody>${cInvs.length?cInvs.map(i=>`<tr><td style="font-family:monospace;">#${(i.id||'').slice(-6)}</td><td style="font-weight:700;">${fmt$(i.amount)}</td><td>${i.status}</td><td style="color:#6b7280;">${i.description||''}</td><td>${fmtDate(i.due_date)}</td></tr>`).join(''):'<tr><td colspan="5" style="text-align:center;color:#9c9286;padding:1.5rem;">No invoices found.</td></tr>'}</tbody></table>
    </div>
    <div class="ftr"><span>CaribCargo Ltd. Â· Customer Dossier Â· ${cust.cargolink_id}</span><span>Generated ${new Date().toLocaleString()}</span></div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOMER PROFILE EDITING (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectEpCustomer(cust) {
  if(!cust) return;
  el('ep-cust-uuid').value = cust.id;
  const form = el('ep-edit-form');
  if(form) {
    form.style.display = 'block';
    const g = (id, val) => { const e=el(id); if(e) e.value=val||''; };
    g('ep-fullname', cust.full_name);
    g('ep-phone',    cust.phone);
    g('ep-country',  cust.country);
    g('ep-trn',      cust.trn);
    g('ep-addr1',    cust.addr1);
    g('ep-city',     cust.city);
    g('ep-region',   cust.region_addr||cust.region);
    const dp = el('ep-delivery'); if(dp) dp.value = cust.delivery_pref||'pickup';
  }
}

async function saveCustomerProfileEdit() {
  const uuid = el('ep-cust-uuid')?.value;
  if(!uuid) return toast('Please select a customer first.','error');
  const updates = {
    full_name:     el('ep-fullname')?.value?.trim() || undefined,
    phone:         el('ep-phone')?.value?.trim() || undefined,
    country:       el('ep-country')?.value?.trim() || undefined,
    trn:           el('ep-trn')?.value?.trim() || undefined,
    addr1:         el('ep-addr1')?.value?.trim() || undefined,
    city:          el('ep-city')?.value?.trim() || undefined,
    region_addr:   el('ep-region')?.value?.trim() || undefined,
    delivery_pref: el('ep-delivery')?.value || undefined,
  };
  // Remove undefined keys
  Object.keys(updates).forEach(k => updates[k]===undefined && delete updates[k]);
  if(!DEMO_MODE && sb) {
    const { error } = await sb.from('profiles').update(updates).eq('id', uuid);
    if(error) return toast('Save failed: ' + error.message, 'error');
  }
  toast('âœ“ Customer profile updated!', 'success');
  el('ep-edit-form').style.display = 'none';
  el('ep-cust-uuid').value = '';
  await refreshAdmin();
}
function openDeleteMyAccountModal() {
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.innerHTML = `
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title" style="color:var(--red);">DELETE MY ACCOUNT</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:1rem;margin-bottom:1.25rem;font-size:0.85rem;line-height:1.65;color:var(--red);">
        <strong>âš  This is permanent and cannot be undone.</strong><br>
        All your shipments, invoices, and profile data will be deleted forever.
      </div>
      <div class="form-group">
        <label class="form-label">Type <strong style="color:var(--red);letter-spacing:0.05em;">DELETE</strong> to confirm</label>
        <input class="form-input" id="delConfirm" placeholder="DELETE" style="border-color:rgba(239,68,68,0.3);" onkeydown="if(event.key==='Enter')doDeleteMyAccount()">
      </div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn btn-ghost" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-danger" style="flex:1;" id="delConfirmBtn" onclick="doDeleteMyAccount()"><i class="ti ti-trash"></i> Delete My Account</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
  setTimeout(()=>el('delConfirm')?.focus(),100);
}

async function doDeleteMyAccount() {
  if((el('delConfirm')?.value||'').trim()!=='DELETE') return toast('Please type DELETE exactly to confirm.','error');
  const btn=el('delConfirmBtn');
  if(btn){btn.innerHTML='<div class="loader"></div> Deletingâ€¦';btn.disabled=true;}
  if(!DEMO_MODE&&sb&&currentUser) {
    try {
      await sb.from('invoices').delete().eq('customer_id',currentUser.id);
      await sb.from('shipments').delete().eq('customer_id',currentUser.id);
      await sb.from('profiles').delete().eq('id',currentUser.id);
      await sb.auth.signOut();
    } catch(e){ console.warn('Delete error:',e); }
  }
  currentUser=null; currentProfile=null;
  document.querySelector('.modal-overlay')?.remove();
  showPage('landing'); updateNavForGuest();
  toast('Your account has been permanently deleted.','info');
}

function openDeleteCustomerModal(custId, custName) {
  const m = document.createElement('div');
  m.className = 'modal-overlay';
  m.onclick = e => { if(e.target===m) m.remove(); };
  // Store custId as data attribute to avoid onclick string escaping issues
  m.dataset.custid = custId;
  m.innerHTML = `
    <div class="modal-box">
      <div class="modal-head">
        <span class="modal-title" style="color:var(--red);">DELETE CUSTOMER</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div style="padding:0.875rem;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:1.25rem;font-size:0.88rem;">
        Deleting account for: <strong style="color:var(--text);">${custName}</strong>
      </div>
      <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:1rem;margin-bottom:1.25rem;font-size:0.84rem;line-height:1.65;color:var(--red);">
        This will permanently delete their profile, all shipments, invoices, and notifications. This cannot be undone.
      </div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn btn-ghost" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-danger" style="flex:1;" onclick="doDeleteCustomer(this.closest('.modal-overlay').dataset.custid)"><i class="ti ti-trash"></i> Delete Account</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
}

async function doDeleteCustomer(custId) {
  const btn = document.querySelector('.modal-overlay .btn-danger');
  if(btn){btn.innerHTML='<div class="loader"></div> Deletingâ€¦';btn.disabled=true;}
  if(!DEMO_MODE&&sb) {
    try {
      // Delete in order: notifications â†’ invoices â†’ shipments â†’ profile
      const {error:e1} = await sb.from('notifications').delete().eq('customer_id',custId);
      if(e1) console.warn('Notifications delete error (non-fatal):', e1.message);
      const {error:e2} = await sb.from('invoices').delete().eq('customer_id',custId);
      if(e2) throw new Error('Could not delete invoices: ' + e2.message);
      const {error:e3} = await sb.from('shipments').delete().eq('customer_id',custId);
      if(e3) throw new Error('Could not delete shipments: ' + e3.message);
      const {error:e4} = await sb.from('profiles').delete().eq('id',custId);
      if(e4) throw new Error('Could not delete profile: ' + e4.message);
    } catch(e) {
      if(btn){btn.innerHTML='<i class="ti ti-trash"></i> Delete Account';btn.disabled=false;}
      return toast('Delete failed: ' + e.message + ' â€” check Supabase RLS policies allow admin to delete.','error');
    }
  }
  document.querySelector('.modal-overlay')?.remove();
  toast('Customer account deleted.','info');
  await refreshAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOMER REPLY â€” send message from notification tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendCustomerReply() {
  const title = el('cust-reply-title')?.value?.trim();
  const body  = el('cust-reply-body')?.value?.trim();
  if(!title||!body) return toast('Please fill in subject and message.','error');
  const btn = document.querySelector('#ctab-notifications .btn-blue');
  if(btn){btn.innerHTML='<div class="loader"></div> Sendingâ€¦';btn.disabled=true;}
  if(!DEMO_MODE&&sb&&currentUser) {
    try {
      // Store as a notification FROM customer (flagged for admin to see)
      await sb.from('notifications').insert({
        customer_id: currentUser.id,
        title: `[Customer Reply] ${title}`,
        message: body,
        read: false,
        created_at: new Date().toISOString()
      });
    } catch(e){ console.warn('Reply error:',e); }
  }
  if(btn){btn.innerHTML='<i class="ti ti-send"></i> Send Message';btn.disabled=false;}
  if(el('cust-reply-title')) el('cust-reply-title').value='';
  if(el('cust-reply-body'))  el('cust-reply-body').value='';
  toast('âœ“ Message sent to CaribCargo support!','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE ADDRESS DISPLAY (read-only for customers)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProfileAddressDisplay() {
  const p = currentProfile;
  const disp = el('profileAddrDisplay');
  if(!disp||!p) return;
  const parts = [p.addr1, p.addr2, p.city, (p.region_addr||p.region), p.postal, p.country].filter(Boolean);
  disp.innerHTML = parts.length
    ? `<div style="color:var(--text);line-height:2;">${parts.join('<br>')}</div>`
    : `<div style="color:var(--text-3);font-style:italic;font-size:0.82rem;">No delivery address on file yet. Contact CaribCargo support to set one.</div>`;
  // Also keep hidden inputs populated for any functions that read them
  if(p.addr1) { const i=el('prof-addr1'); if(i) i.value=p.addr1; }
  if(p.addr2) { const i=el('prof-addr2'); if(i) i.value=p.addr2; }
  if(p.city)  { const i=el('prof-city');  if(i) i.value=p.city; }
  if(p.region_addr||p.region) { const i=el('prof-region'); if(i) i.value=p.region_addr||p.region; }
  if(p.postal){ const i=el('prof-postal'); if(i) i.value=p.postal; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT TABLE â€” search & filter customers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _exportFiltered = [];

function renderExportTable(filtered) {
  const custs = filtered || (DEMO_MODE ? getDemoCustomers() : (allCustomers||[]));
  _exportFiltered = custs;
  const tbody = el('exportCustomerTableBody');
  const countEl = el('exportResultCount');
  if(!tbody) return;
  if(!custs.length) {
    tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;color:var(--text-3);padding:2rem;">No customers found.</td></tr>`;
    if(countEl) countEl.textContent='';
    return;
  }
  tbody.innerHTML = custs.map(c=>`<tr>
    <td class="mono" style="color:var(--amber);font-size:0.78rem;">${c.cargolink_id||'â€”'}</td>
    <td style="font-weight:500;">${c.full_name||'â€”'}</td>
    <td style="font-size:0.8rem;">${c.email||'â€”'}</td>
    <td style="font-size:0.8rem;">${c.phone||'â€”'}</td>
    <td style="font-size:0.8rem;">${c.country||'â€”'}</td>
    <td style="font-size:0.8rem;">${c.city||'â€”'}</td>
    <td style="font-size:0.78rem;color:var(--text-2);">${[c.addr1,c.addr2].filter(Boolean).join(', ')||'â€”'}</td>
    <td style="font-size:0.78rem;font-family:monospace;">${c.trn||'â€”'}</td>
    <td style="font-size:0.76rem;color:var(--text-3);">${fmtDate(c.created_at)}</td>
  </tr>`).join('');
  if(countEl) countEl.textContent=`Showing ${custs.length} customer${custs.length!==1?'s':''}`;
}

function filterExportTable() {
  const q = f => (el(f)?.value||'').trim().toLowerCase();
  const name    = q('exportSearch-name');
  const email   = q('exportSearch-email');
  const id      = q('exportSearch-id');
  const country = q('exportSearch-country');
  const trn     = q('exportSearch-trn');
  const addr    = q('exportSearch-addr');
  const custs   = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  const filtered = custs.filter(c=>{
    const n = (c.full_name||'').toLowerCase();
    const e = (c.email||'').toLowerCase();
    const ci= (c.cargolink_id||'').toLowerCase();
    const co= (c.country||'').toLowerCase();
    const t = (c.trn||'').toLowerCase();
    const a = ((c.addr1||'')+' '+(c.addr2||'')+' '+(c.city||'')).toLowerCase();
    return (!name||n.includes(name)) && (!email||e.includes(email)) &&
           (!id||ci.includes(id)) && (!country||co.includes(country)) &&
           (!trn||t.includes(trn)) && (!addr||a.includes(addr));
  });
  renderExportTable(filtered);
}

function clearExportSearch() {
  ['exportSearch-name','exportSearch-email','exportSearch-id','exportSearch-country','exportSearch-trn','exportSearch-addr']
    .forEach(id=>{ const e=el(id); if(e) e.value=''; });
  renderExportTable();
}

function exportFilteredCustomers() {
  const custs = _exportFiltered.length ? _exportFiltered : (DEMO_MODE?getDemoCustomers():allCustomers||[]);
  if(!custs.length) return toast('No results to export.','info');
  dlCSV(`CaribCargo_Customers_Filtered_${new Date().toISOString().slice(0,10)}.csv`,
    ['CargoLink ID','Full Name','Email','Phone','Country','City','Address Line 1','Address Line 2','Parish/State','Postal Code','TRN','Delivery Pref','Joined'],
    custs.map(c=>[c.cargolink_id,c.full_name,c.email,c.phone||'',c.country||'',c.city||'',c.addr1||'',c.addr2||'',c.region_addr||c.region||'',c.postal||'',c.trn||'',c.delivery_pref||'',fmtDate(c.created_at)]));
  toast(`âœ“ Exported ${custs.length} customer records!`,'success');
}

function exportAllCustomersFull() {
  const custs = DEMO_MODE ? getDemoCustomers() : (allCustomers||[]);
  if(!custs.length) return toast('No customers found.','info');
  dlCSV(`CaribCargo_AllCustomers_Full_${new Date().toISOString().slice(0,10)}.csv`,
    ['CargoLink ID','Full Name','Email','Phone','Country','City','Address 1','Address 2','Parish/State','Postal','TRN','Delivery Pref','Joined'],
    custs.map(c=>[c.cargolink_id,c.full_name,c.email,c.phone||'',c.country||'',c.city||'',c.addr1||'',c.addr2||'',c.region_addr||c.region||'',c.postal||'',c.trn||'',c.delivery_pref||'',fmtDate(c.created_at)]));
  toast(`âœ“ Downloaded all ${custs.length} customers!`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK DELETE â€” admin settings data management
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BULK_DELETE_CONFIG = {
  delivered_shipments: { label:'All Delivered Shipments', confirm:'DELETE DELIVERED', color:'var(--amber)' },
  cancelled_shipments: { label:'All Cancelled Shipments', confirm:'DELETE CANCELLED', color:'var(--red)' },
  all_shipments:       { label:'ALL Shipments',           confirm:'DELETE ALL SHIPMENTS', color:'var(--red)' },
  paid_invoices:       { label:'All Paid Invoices',       confirm:'DELETE PAID',      color:'var(--amber)' },
  all_invoices:        { label:'ALL Invoices',            confirm:'DELETE ALL INVOICES', color:'var(--red)' },
};

function openBulkDeleteModal(type) {
  const cfg = BULK_DELETE_CONFIG[type]; if(!cfg) return;
  const m = document.createElement('div');
  m.className='modal-overlay';
  m.innerHTML=`
    <div class="modal-box" style="max-width:480px;">
      <div class="modal-head">
        <span class="modal-title" style="color:var(--red);"><i class="ti ti-alert-triangle"></i> CONFIRM DELETION</span>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="ti ti-x"></i></button>
      </div>
      <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:1rem;margin-bottom:1.25rem;font-size:0.85rem;line-height:1.7;color:var(--red);">
        <strong>âš  You are about to permanently delete: ${cfg.label}</strong><br>
        This will remove the data from the database immediately and cannot be undone.
      </div>
      <div class="form-group">
        <label class="form-label">Type <strong style="color:var(--red);font-family:monospace;letter-spacing:0.05em;">${cfg.confirm}</strong> to confirm</label>
        <input class="form-input" id="bulkDelConfirm" placeholder="${cfg.confirm}" style="border-color:rgba(239,68,68,0.3);font-family:monospace;">
      </div>
      <div style="display:flex;gap:0.75rem;">
        <button class="btn btn-ghost" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-danger" style="flex:1;" onclick="executeBulkDelete('${type}')"><i class="ti ti-trash"></i> Delete Forever</button>
      </div>
    </div>`;
  el('modals').appendChild(m);
  setTimeout(()=>el('bulkDelConfirm')?.focus(),100);
}

async function executeBulkDelete(type) {
  const cfg = BULK_DELETE_CONFIG[type]; if(!cfg) return;
  const val = (el('bulkDelConfirm')?.value||'').trim();
  if(val !== cfg.confirm) return toast(`Please type "${cfg.confirm}" exactly.`,'error');
  const btn = document.querySelector('.modal-overlay .btn-danger');
  if(btn){btn.innerHTML='<div class="loader"></div> Deletingâ€¦';btn.disabled=true;}

  let count=0;
  if(!DEMO_MODE&&sb) {
    try {
      if(type==='delivered_shipments'){
        const {data,error}=await sb.from('shipments').delete().eq('status','delivered').select();
        if(error) throw error;
        count=data?.length||0;
      } else if(type==='cancelled_shipments'){
        const {data,error}=await sb.from('shipments').delete().eq('status','cancelled').select();
        if(error) throw error;
        count=data?.length||0;
      } else if(type==='all_shipments'){
        const {data,error}=await sb.from('shipments').delete().neq('id','00000000-0000-0000-0000-000000000000').select();
        if(error) throw error;
        count=data?.length||0;
      } else if(type==='paid_invoices'){
        const {data,error}=await sb.from('invoices').delete().eq('status','paid').select();
        if(error) throw error;
        count=data?.length||0;
      } else if(type==='all_invoices'){
        const {data,error}=await sb.from('invoices').delete().neq('id','00000000-0000-0000-0000-000000000000').select();
        if(error) throw error;
        count=data?.length||0;
      }
    } catch(e){
      document.querySelector('.modal-overlay')?.remove();
      return toast('Deletion error: '+e.message,'error');
    }
  } else {
    // DEMO: just show success
    count = type.includes('all') ? 15 : 5;
  }

  document.querySelector('.modal-overlay')?.remove();
  toast(`âœ“ Deleted ${count} record${count!==1?'s':''} (${cfg.label}).`,'success');
  await refreshAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENHANCED TRACKING â€” create shipment with customer tag
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// (Tracking number is auto-generated and tagged to selected customer â€” already handled
//  by the cpicker. The preview below updates the tracking preview when a customer is selected)
function onCsCustomerSelected(custId, custName, cargoLinkId) {
  // Show customer tag on the Create Shipment modal
  const tag = el('cs-cust-tag');
  if(tag) {
    if(custId) {
      const init = (custName||'?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
      tag.innerHTML=`<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.75rem;background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:0.8rem;">
        <div style="width:24px;height:24px;border-radius:50%;background:rgba(245,158,11,0.15);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--amber);font-size:0.65rem;">${init}</div>
        <span style="font-weight:600;">${custName}</span>
        <span class="mono" style="color:var(--amber);font-size:0.75rem;">${cargoLinkId||''}</span>
        <span style="color:var(--text-3);font-size:0.72rem;">â†’ tracking # auto-generated</span>
      </div>`;
      tag.style.display='block';
    } else {
      tag.style.display='none';
    }
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  initHeroCanvas();
  checkSession();
  selectDelivery('door');
  applyRates();
});
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SUPABASE SQL â€” Run in editor
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

create table public.profiles (
  id uuid references auth.users on delete cascade primary key,
  full_name text, email text, phone text, trn text,
  country text, region text, region_addr text,
  addr1 text, addr2 text, city text, postal text,
  delivery_pref text default 'pickup',
  cargolink_id text unique,
  role text default 'customer',
  created_at timestamptz default now()
);

create table public.shipments (
  id uuid primary key default gen_random_uuid(),
  customer_id uuid references public.profiles(id),
  tracking_number text unique not null,
  description text, ship_type text, weight numeric,
  declared_value numeric, status text not null default 'pending',
  notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.invoices (
  id uuid primary key default gen_random_uuid(),
  customer_id uuid references public.profiles(id),
  shipment_id uuid references public.shipments(id),
  amount numeric not null, status text default 'unpaid',
  description text, due_date date,
  created_at timestamptz default now()
);

create table public.notifications (
  id uuid primary key default gen_random_uuid(),
  customer_id uuid references public.profiles(id),
  title text, message text, read boolean default false,
  created_at timestamptz default now()
);

alter table public.profiles enable row level security;
alter table public.shipments enable row level security;
alter table public.invoices  enable row level security;
alter table public.notifications enable row level security;

-- Use security-definer function to avoid RLS infinite recursion on profiles table
create or replace function public.is_admin()
returns boolean language sql stable security definer as
$$ select exists(select 1 from public.profiles where id = auth.uid() and role = 'admin') $$;

create policy "own_profile"          on public.profiles      for all    using (auth.uid()=id);
create policy "admin_profiles"       on public.profiles      for all    using (public.is_admin());
create policy "own_shipments"        on public.shipments     for select using (auth.uid()=customer_id);
create policy "public_track"         on public.shipments     for select using (true);
create policy "admin_shipments"      on public.shipments     for all    using (public.is_admin());
create policy "own_invoices"         on public.invoices      for select using (auth.uid()=customer_id);
create policy "admin_invoices"       on public.invoices      for all    using (public.is_admin());
create policy "own_notifications"    on public.notifications for all    using (auth.uid()=customer_id);
create policy "admin_notifications"  on public.notifications for all    using (public.is_admin());

-->

<!-- DEBUG TOGGLE BUTTON -->
<button id="debug-toggle" onclick="toggleDebug()">
  ðŸ› Debug <span id="debug-err-count">0</span>
</button>

<!-- DEBUG PANEL -->
<div id="debug-panel">
  <div id="debug-header">
    <span id="debug-title">ðŸ› CARIBCARGO DEBUG CONSOLE</span>
    <div style="display:flex;gap:0.4rem;align-items:center;">
      <button class="daction" onclick="clearDebugLog()">Clear</button>
      <button class="daction" onclick="toggleDebug()" style="color:#ef4444;">âœ•</button>
    </div>
  </div>
  <div id="debug-tabs">
    <div class="dtab active" onclick="showDebugTab('log')" id="dtab-log">LOG</div>
    <div class="dtab" onclick="showDebugTab('supabase')" id="dtab-supabase">SUPABASE</div>
    <div class="dtab" onclick="showDebugTab('state')" id="dtab-state">STATE</div>
    <div class="dtab" onclick="showDebugTab('tests')" id="dtab-tests">TESTS</div>
  </div>
  <div id="debug-body">
    <div id="debug-tab-log"></div>
    <div id="debug-tab-supabase" style="display:none;"></div>
    <div id="debug-tab-state" style="display:none;"></div>
    <div id="debug-tab-tests" style="display:none;"></div>
  </div>
  <div id="debug-actions">
    <button class="daction primary" onclick="runAllTests()">â–¶ Run All Tests</button>
    <button class="daction" onclick="testSupabaseConnection()">Test Connection</button>
    <button class="daction" onclick="testTables()">Test Tables</button>
    <button class="daction" onclick="testAuth()">Test Auth</button>
    <button class="daction" onclick="showDebugState()">Show State</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEBUG CONSOLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let debugLogs = [];
let debugErrCount = 0;
let debugOpen = false;
let debugTab = 'log';

function dlog(msg, type='info', label='') {
  const time = new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const entry = { time, msg, type, label };
  debugLogs.push(entry);
  if(type === 'err') {
    debugErrCount++;
    const ec = el('debug-err-count');
    if(ec) { ec.textContent = debugErrCount; ec.style.display = 'inline'; }
  }
  renderDebugLog();
  console.log(`[${type.toUpperCase()}] ${label ? label+': ' : ''}${msg}`);
}

function renderDebugLog() {
  const c = el('debug-tab-log');
  if(!c) return;
  c.innerHTML = [...debugLogs].reverse().map(e => `
    <div class="dlog">
      <span class="dlog-time">${e.time}</span>
      ${e.label ? `<span class="dlog-label">[${e.label}]</span> ` : ''}
      <span class="dlog-${e.type}">${e.msg}</span>
    </div>`).join('') || '<div style="color:#444;padding:0.5rem;">No logs yet.</div>';
}

function toggleDebug() {
  debugOpen = !debugOpen;
  const panel = el('debug-panel');
  const toggle = el('debug-toggle');
  if(panel) panel.classList.toggle('open', debugOpen);
  if(toggle) toggle.style.display = debugOpen ? 'none' : 'flex';
  if(debugOpen) { showDebugTab(debugTab); renderDebugLog(); }
}

function showDebugTab(tab) {
  debugTab = tab;
  ['log','supabase','state','tests'].forEach(t => {
    const el2 = el('debug-tab-'+t);
    const btn  = el('dtab-'+t);
    if(el2) el2.style.display = t===tab ? 'block' : 'none';
    if(btn) btn.classList.toggle('active', t===tab);
  });
  if(tab==='state') showDebugState();
  if(tab==='supabase') showSupabaseInfo();
}

function clearDebugLog() {
  debugLogs = []; debugErrCount = 0;
  const ec = el('debug-err-count');
  if(ec) { ec.textContent='0'; ec.style.display='none'; }
  renderDebugLog();
  dlog('Log cleared', 'info');
}

function showDebugState() {
  const c = el('debug-tab-state');
  if(!c) return;
  c.innerHTML = `
    <div class="dlog"><span class="dlog-label">DEMO_MODE</span> <span class="dlog-${DEMO_MODE?'warn':'ok'}">${DEMO_MODE}</span></div>
    <div class="dlog"><span class="dlog-label">Supabase URL</span> <span class="dlog-info">${SUPABASE_URL.slice(0,40)}â€¦</span></div>
    <div class="dlog"><span class="dlog-label">sb client</span> <span class="dlog-${sb?'ok':'err'}">${sb ? 'initialized âœ“' : 'NULL âœ—'}</span></div>
    <div class="dlog"><span class="dlog-label">currentUser</span> <span class="dlog-${currentUser?'ok':'warn'}">${currentUser ? currentUser.email + ' ('+currentUser.id.slice(0,8)+'â€¦)' : 'null'}</span></div>
    <div class="dlog"><span class="dlog-label">currentProfile</span> <span class="dlog-${currentProfile?'ok':'warn'}">${currentProfile ? currentProfile.full_name + ' / ' + currentProfile.role : 'null'}</span></div>
    <div class="dlog"><span class="dlog-label">cargolink_id</span> <span class="dlog-info">${currentProfile?.cargolink_id||'â€”'}</span></div>
    <div class="dlog"><span class="dlog-label">allShipments</span> <span class="dlog-info">${allShipments.length} loaded</span></div>
    <div class="dlog"><span class="dlog-label">allInvoices</span> <span class="dlog-info">${allInvoices.length} loaded</span></div>
  `;
}

function showSupabaseInfo() {
  const c = el('debug-tab-supabase');
  if(!c) return;
  c.innerHTML = `
    <div class="dlog" style="color:#666;margin-bottom:0.5rem;">Click "Test Tables" to check which tables exist.</div>
    <div class="dlog"><span class="dlog-label">URL</span> <span class="dlog-info" style="word-break:break-all;">${SUPABASE_URL}</span></div>
    <div class="dlog"><span class="dlog-label">Anon Key</span> <span class="dlog-info">${SUPABASE_ANON_KEY.slice(0,30)}â€¦</span></div>
    <div class="dlog"><span class="dlog-label">Mode</span> <span class="dlog-${DEMO_MODE?'warn':'ok'}">${DEMO_MODE ? 'âš  DEMO (Supabase NOT used)' : 'âœ“ LIVE'}</span></div>
    <div id="debug-table-results" style="margin-top:0.5rem;"></div>
  `;
}

async function testSupabaseConnection() {
  dlog('Testing Supabase connectionâ€¦', 'info', 'CONN');
  if(!sb) { dlog('sb client is NULL â€” Supabase not initialized!', 'err', 'CONN'); return; }
  try {
    const start = Date.now();
    const { data, error } = await sb.auth.getSession();
    const ms = Date.now() - start;
    if(error) { dlog('getSession failed: ' + error.message, 'err', 'CONN'); return; }
    dlog('Connection OK âœ“ (' + ms + 'ms)', 'ok', 'CONN');
    dlog('Session: ' + (data.session ? 'Active user: '+data.session.user.email : 'No session'), 'info', 'CONN');
  } catch(e) {
    dlog('Connection FAILED: ' + e.message, 'err', 'CONN');
  }
  showDebugTab('log');
}

async function testTables() {
  dlog('Checking database tablesâ€¦', 'info', 'TABLES');
  const tables = ['profiles','shipments','invoices','notifications'];
  const results = {};
  if(!sb) { dlog('sb is NULL â€” cannot test tables', 'err', 'TABLES'); return; }
  for(const t of tables) {
    try {
      const { data, error } = await sb.from(t).select('id').limit(1);
      if(error) {
        results[t] = { ok: false, msg: error.message, code: error.code };
        dlog(t + ' âœ— â€” ' + error.message + ' (code: '+error.code+')', 'err', 'TABLES');
      } else {
        results[t] = { ok: true };
        dlog(t + ' âœ“ exists', 'ok', 'TABLES');
      }
    } catch(e) {
      results[t] = { ok: false, msg: e.message };
      dlog(t + ' âœ— â€” ' + e.message, 'err', 'TABLES');
    }
  }
  // Show in supabase tab too
  const c = el('debug-table-results');
  if(c) {
    c.innerHTML = tables.map(t => `
      <div class="dlog">
        <span class="${results[t]?.ok ? 'dlog-ok' : 'dlog-err'}">${results[t]?.ok ? 'âœ“' : 'âœ—'}</span>
        <span style="color:#aaa;margin:0 0.4rem;">${t}</span>
        ${results[t]?.ok ? '' : `<span style="color:#ef4444;font-size:0.65rem;">${results[t]?.msg||''}</span>`}
      </div>`).join('');
  }
  showDebugTab('log');
}

async function testAuth() {
  dlog('Testing auth stateâ€¦', 'info', 'AUTH');
  if(!sb) { dlog('sb is NULL', 'err', 'AUTH'); return; }
  try {
    const { data: { session }, error } = await sb.auth.getSession();
    if(error) { dlog('Auth error: ' + error.message, 'err', 'AUTH'); return; }
    if(!session) {
      dlog('No active session â€” user not logged in', 'warn', 'AUTH');
    } else {
      dlog('Logged in as: ' + session.user.email, 'ok', 'AUTH');
      dlog('User ID: ' + session.user.id, 'info', 'AUTH');
      dlog('Email confirmed: ' + !!session.user.email_confirmed_at, session.user.email_confirmed_at ? 'ok' : 'err', 'AUTH');
      // Check profile row exists
      const { data: profile, error: profErr } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
      if(profErr) {
        dlog('Profile row: MISSING âœ— (' + profErr.message + ')', 'err', 'AUTH');
        dlog('FIX: Run INSERT into profiles in Supabase SQL Editor', 'warn', 'AUTH');
      } else {
        dlog('Profile row: found âœ“', 'ok', 'AUTH');
        dlog('Role: ' + profile.role + ' | CargoID: ' + profile.cargolink_id, 'info', 'AUTH');
      }
    }
  } catch(e) {
    dlog('Auth test failed: ' + e.message, 'err', 'AUTH');
  }
  showDebugTab('log');
}

async function runAllTests() {
  el('debug-tab-tests').innerHTML = '<div style="color:#f59e0b;padding:0.5rem;">Running all testsâ€¦</div>';
  showDebugTab('tests');
  dlog('=== RUNNING ALL TESTS ===', 'info');
  await testSupabaseConnection();
  await testTables();
  await testAuth();
  const errors = debugLogs.filter(l => l.type === 'err').length;
  const c = el('debug-tab-tests');
  if(c) {
    c.innerHTML = `
      <div style="padding:0.5rem;margin-bottom:0.5rem;background:${errors===0?'#10b98122':'#ef444422'};border-radius:6px;border:1px solid ${errors===0?'#10b98155':'#ef444455'};">
        <div style="color:${errors===0?'#10b981':'#ef4444'};font-weight:700;margin-bottom:0.35rem;">${errors===0 ? 'âœ“ All tests passed!' : 'âœ— '+errors+' issue(s) found'}</div>
        ${errors > 0 ? '<div style="color:#aaa;font-size:0.68rem;">Check the LOG tab for details and fixes.</div>' : ''}
      </div>
      <div style="color:#666;font-size:0.68rem;line-height:1.8;">
        <div><span style="color:#f59e0b;">DEMO_MODE:</span> ${DEMO_MODE}</div>
        <div><span style="color:#f59e0b;">Supabase client:</span> ${sb ? 'âœ“ ready' : 'âœ— null'}</div>
        <div><span style="color:#f59e0b;">Current user:</span> ${currentUser?.email || 'not logged in'}</div>
        <div><span style="color:#f59e0b;">Profile loaded:</span> ${currentProfile ? 'âœ“ '+currentProfile.role : 'âœ— none'}</div>
      </div>
    `;
  }
  showDebugTab('tests');
}

// Patch console.error to auto-log to debug panel
const _origError = console.error;
console.error = function(...args) {
  _origError.apply(console, args);
  dlog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'err', 'JS');
};
const _origWarn = console.warn;
console.warn = function(...args) {
  _origWarn.apply(console, args);
  dlog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '), 'warn', 'JS');
};

// Auto-run tests on load after 1s
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    dlog('CaribCargo debug console ready', 'ok', 'INIT');
    dlog('DEMO_MODE: ' + DEMO_MODE, DEMO_MODE ? 'warn' : 'ok', 'INIT');
    dlog('Supabase URL: ' + SUPABASE_URL.slice(0
