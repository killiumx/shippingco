<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>IslandShip ‚Äî Customer Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --navy:#0a1628;--navy2:#0d1f3c;--navy3:#132952;
  --blue:#1a56db;--blue2:#1e40af;--sky:#0ea5e9;
  --off:#f8faff;--mist:#f0f6ff;--silver:#cbd5e1;--slate:#64748b;--mid:#334155;
  --gold:#f59e0b;--ok:#10b981;--err:#ef4444;--warn:#f97316;
  --fh:'Syne',sans-serif;--fb:'DM Sans',sans-serif;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-xl:28px;
  --sh-sm:0 2px 8px rgba(26,86,219,.07);--sh-md:0 8px 32px rgba(26,86,219,.11);--sh-lg:0 24px 64px rgba(10,22,40,.16);
  --t:all .26s cubic-bezier(.23,1,.32,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:var(--fb);background:var(--off);color:var(--navy);overflow-x:hidden}
input,select,textarea,button{font-family:var(--fb)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--blue);border-radius:3px}

@keyframes fadeUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(26,86,219,.35)}50%{box-shadow:0 0 0 10px rgba(26,86,219,0)}}
@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
@keyframes bobFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes waveFlow{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
@keyframes shipSail{0%{transform:translateX(-180px);opacity:0}5%{opacity:.6}95%{opacity:.6}100%{transform:translateX(105vw);opacity:0}}
@keyframes planeFly{0%{transform:translateX(-140px) translateY(0) rotate(-3deg);opacity:0}6%{opacity:.75}95%{opacity:.75}100%{transform:translateX(105vw) translateY(-28px) rotate(2deg);opacity:0}}
@keyframes bubbleRise{0%{transform:translateY(0) scale(1);opacity:.4}100%{transform:translateY(-90vh) scale(.2);opacity:0}}
@keyframes toastIn{from{opacity:0;transform:translateX(110%)}to{opacity:1;transform:translateX(0)}}
@keyframes countUp{from{opacity:0;transform:scale(.7)}to{opacity:1;transform:scale(1)}}
@keyframes borderGlow{0%,100%{border-color:rgba(26,86,219,.25)}50%{border-color:rgba(14,165,233,.55)}}

/* SCENE */
#scene{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.sbg{position:absolute;inset:0;background:linear-gradient(170deg,#e8f4ff 0%,#f8faff 50%,#eef4ff 100%)}
.sgrid{position:absolute;inset:0;background-image:linear-gradient(rgba(26,86,219,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(26,86,219,.03) 1px,transparent 1px);background-size:72px 72px}
.sblob{position:absolute;border-radius:50%;filter:blur(90px);opacity:.22;pointer-events:none}
.ocean{position:absolute;bottom:0;left:0;right:0;height:110px;overflow:hidden}
.wt{position:absolute;bottom:0;width:200%;animation:waveFlow 12s linear infinite}
.wt2{animation-duration:18s;animation-direction:reverse;bottom:8px;opacity:.6}

/* LAYOUT */
#shell{display:flex;min-height:100vh;position:relative;z-index:1}

/* SIDEBAR */
#sidebar{width:252px;flex-shrink:0;background:var(--navy);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;box-shadow:4px 0 32px rgba(10,22,40,.18);z-index:50;overflow-y:auto}
#sidebar::-webkit-scrollbar{width:3px}
.sb-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 20px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
.sb-logo-icon{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 4px 14px rgba(26,86,219,.4);flex-shrink:0}
.sb-logo-text{font-family:var(--fh);font-size:20px;font-weight:800;color:#fff}
.sb-logo-text span{background:linear-gradient(135deg,#60a5fa,var(--sky));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.sb-section{padding:16px 14px 5px;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.25)}
.sb-link{display:flex;align-items:center;gap:11px;padding:10px 15px;margin:2px 8px;border-radius:var(--r-md);color:rgba(255,255,255,.52);font-size:13.5px;font-weight:500;cursor:pointer;transition:var(--t);position:relative}
.sb-link:hover{color:rgba(255,255,255,.88);background:rgba(255,255,255,.06)}
.sb-link.active{color:#fff;background:linear-gradient(135deg,rgba(26,86,219,.48),rgba(14,165,233,.28));box-shadow:0 4px 18px rgba(26,86,219,.2)}
.sb-link.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:linear-gradient(var(--blue),var(--sky));border-radius:0 3px 3px 0}
.sb-icon{font-size:17px;width:22px;text-align:center;flex-shrink:0}
.sb-badge{margin-left:auto;background:var(--err);color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px}
.sb-user{margin-top:auto;padding:16px;border-top:1px solid rgba(255,255,255,.06)}
.sb-user-card{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.05);border-radius:var(--r-md);padding:11px 13px}
.sb-avatar{width:34px;height:34px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff}
.sb-user-name{font-size:13px;font-weight:600;color:#fff;line-height:1.2}
.sb-user-id{font-size:11px;color:rgba(255,255,255,.38);margin-top:2px}
.sb-signout{margin-top:9px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);color:rgba(255,255,255,.45);border-radius:var(--r-sm);padding:8px;font-size:13px;cursor:pointer;transition:var(--t)}
.sb-signout:hover{background:rgba(239,68,68,.1);color:#fca5a5;border-color:rgba(239,68,68,.18)}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;min-width:0}
#topbar{background:rgba(248,250,255,.88);backdrop-filter:blur(20px);border-bottom:1px solid rgba(26,86,219,.07);padding:0 30px;height:66px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;box-shadow:0 2px 16px rgba(10,22,40,.05)}
.topbar-title{font-family:var(--fh);font-size:19px;font-weight:700;color:var(--navy)}
.topbar-right{display:flex;align-items:center;gap:11px}
.topbar-pill{display:flex;align-items:center;gap:7px;background:rgba(26,86,219,.06);border:1px solid rgba(26,86,219,.12);border-radius:20px;padding:6px 14px;font-size:13px;color:var(--blue);font-weight:600}
#content{padding:28px;flex:1}
.tab-content.hidden{display:none!important}

/* CARDS */
.card{background:#fff;border-radius:var(--r-lg);border:1px solid rgba(26,86,219,.07);box-shadow:var(--sh-sm);transition:var(--t)}
.card-p{padding:24px}
.card:hover{box-shadow:var(--sh-md)}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(158px,1fr));gap:14px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:var(--r-lg);padding:20px 18px;border:1px solid rgba(26,86,219,.07);box-shadow:var(--sh-sm);transition:var(--t);position:relative;overflow:hidden;animation:fadeUp .5s ease both}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--c1,var(--blue)),var(--c2,var(--sky)))}
.stat-card:hover{transform:translateY(-5px);box-shadow:var(--sh-md)}
.stat-icon{font-size:24px;margin-bottom:10px}
.stat-val{font-family:var(--fh);font-size:30px;font-weight:800;background:linear-gradient(135deg,var(--c1,var(--blue)),var(--c2,var(--sky)));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:countUp .5s ease;line-height:1}
.stat-lbl{font-size:12px;color:var(--slate);margin-top:4px;font-weight:500}

/* ADDRESS CARD */
.address-card{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 60%,var(--navy3) 100%);border-radius:var(--r-xl);padding:28px 32px;margin-bottom:22px;position:relative;overflow:hidden;animation:borderGlow 4s infinite;border:1px solid rgba(26,86,219,.3)}
.address-card::before{content:'';position:absolute;top:-80px;right:-80px;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle,rgba(26,86,219,.18),transparent)}
.address-card::after{content:'';position:absolute;bottom:-50px;left:-40px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(14,165,233,.1),transparent)}
.addr-tag{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--sky);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.addr-tag::before{content:'';width:18px;height:2px;background:var(--sky);border-radius:2px}
.addr-text{font-family:var(--fh);font-size:clamp(13px,2vw,15px);font-weight:600;color:#fff;letter-spacing:.3px;line-height:1.7;position:relative;z-index:1}
.addr-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;position:relative;z-index:1}
.addr-warn{margin-top:10px;font-size:12px;color:rgba(255,255,255,.45);display:flex;align-items:center;gap:6px;position:relative;z-index:1}

/* BUTTONS */
.btn{border:none;border-radius:var(--r-md);font-weight:600;cursor:pointer;transition:var(--t);display:inline-flex;align-items:center;justify-content:center;gap:7px;font-family:var(--fb)}
.btn:hover{transform:translateY(-2px) scale(1.01)}
.btn:active{transform:scale(.98)}
.btn-primary{background:linear-gradient(135deg,var(--blue),var(--sky));color:#fff;padding:10px 22px;font-size:13.5px;box-shadow:0 4px 16px rgba(26,86,219,.3)}
.btn-outline{background:transparent;color:var(--blue);border:1.5px solid rgba(26,86,219,.25);padding:9px 20px;font-size:13.5px}
.btn-outline:hover{border-color:var(--blue);background:rgba(26,86,219,.04)}
.btn-ghost{background:rgba(26,86,219,.07);color:var(--blue);padding:9px 18px;font-size:13px}
.btn-sm{padding:6px 14px;font-size:12px}
.btn-lg{padding:13px 32px;font-size:15px}
.btn-full{width:100%}
.btn-white{background:#fff;color:var(--blue);border:1.5px solid rgba(26,86,219,.15);box-shadow:var(--sh-sm);padding:9px 20px;font-size:13.5px}
.btn-dark-ghost{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.18);padding:9px 20px;font-size:13.5px}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:var(--r-md)}
table{width:100%;border-collapse:collapse;font-size:13.5px}
thead tr{border-bottom:2px solid rgba(26,86,219,.08)}
th{padding:10px 13px;color:var(--slate);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;text-align:left;white-space:nowrap}
td{padding:13px;border-bottom:1px solid rgba(26,86,219,.05);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(26,86,219,.02)}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:5px;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:700;white-space:nowrap}

/* FORM */
.field{margin-bottom:15px}
.field label{display:block;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--slate);margin-bottom:6px}
.field input,.field select,.field textarea{width:100%;padding:11px 15px;border-radius:var(--r-sm);border:1.5px solid #e2e8f0;background:#f8faff;color:var(--navy);font-size:14px;font-family:var(--fb);outline:none;transition:var(--t)}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 4px rgba(26,86,219,.07)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* MODAL */
.overlay{position:fixed;inset:0;z-index:900;background:rgba(10,22,40,.5);backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s ease}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:var(--r-xl);width:100%;box-shadow:var(--sh-lg);transform:translateY(18px) scale(.97);transition:transform .3s cubic-bezier(.23,1,.32,1);overflow:hidden;max-height:90vh;overflow-y:auto}
.overlay.open .modal{transform:none}
.modal-hd{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:26px 30px;position:relative;overflow:hidden}
.modal-hd::before{content:'';position:absolute;top:-50px;right:-50px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(26,86,219,.2),transparent)}
.modal-hd h3{font-family:var(--fh);font-size:21px;font-weight:700;color:#fff;position:relative;z-index:1}
.modal-hd p{font-size:13px;color:rgba(255,255,255,.48);margin-top:4px;position:relative;z-index:1}
.modal-x{position:absolute;top:15px;right:15px;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.1);color:#fff;font-size:19px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;transition:var(--t)}
.modal-x:hover{background:rgba(255,255,255,.2)}
.modal-bd{padding:26px 30px}

/* TOAST */
#toasts{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:9px}
.toast{display:flex;align-items:center;gap:10px;background:#fff;border-radius:var(--r-md);padding:12px 16px;box-shadow:0 8px 28px rgba(10,22,40,.14);border-left:4px solid var(--blue);min-width:260px;max-width:350px;animation:toastIn .3s cubic-bezier(.23,1,.32,1) both;font-size:13.5px;color:var(--navy)}
.toast.ok{border-color:var(--ok)}.toast.err{border-color:var(--err)}

/* ALERT */
.alert{border-radius:var(--r-md);padding:12px 16px;font-size:13.5px;margin-bottom:18px;display:flex;align-items:center;gap:10px}
.alert-warn{background:rgba(249,115,22,.07);border:1px solid rgba(249,115,22,.2);color:var(--warn)}
.alert-ok{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);color:var(--ok)}
.alert-info{background:rgba(26,86,219,.06);border:1px solid rgba(26,86,219,.15);color:var(--blue)}
.hidden{display:none!important}

/* TRACK STEPS */
.track-bar{height:4px;border-radius:2px;background:#e2e8f0;margin-bottom:26px;overflow:hidden}
.track-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--blue),var(--sky));transition:width .6s ease}
.ts-row{display:flex;align-items:flex-start;gap:14px;padding-bottom:22px;position:relative}
.ts-row:not(:last-child)::before{content:'';position:absolute;left:19px;top:38px;width:2px;bottom:0;background:linear-gradient(var(--blue),rgba(26,86,219,.1))}
.ts-dot{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.ts-dot.done{background:linear-gradient(135deg,var(--blue),var(--sky));color:#fff;box-shadow:0 4px 12px rgba(26,86,219,.3)}
.ts-dot.cur{background:#fff;color:var(--blue);border:3px solid var(--blue);animation:pulse 2s infinite}
.ts-dot.pend{background:#f1f5f9;color:var(--silver);border:2px solid #e2e8f0}
.ts-label{font-weight:600;font-size:14px;color:var(--navy)}
.ts-label.pend{color:var(--slate)}
.ts-date{font-size:12px;color:var(--slate);margin-top:2px}

/* PAY */
.pay-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.pay-opt{border:2px solid #e2e8f0;border-radius:var(--r-md);padding:14px;cursor:pointer;transition:var(--t);text-align:center}
.pay-opt:hover{border-color:var(--blue);background:rgba(26,86,219,.03)}
.pay-opt.selected{border-color:var(--blue);background:rgba(26,86,219,.06);box-shadow:0 0 0 3px rgba(26,86,219,.09)}
.pay-opt-icon{font-size:24px;margin-bottom:5px}
.pay-opt-name{font-size:13px;font-weight:600}

/* INV */
.inv-hd{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:24px 28px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px}
.inv-logo-icon{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-size:16px}
.inv-table{width:100%;border-collapse:collapse;margin-bottom:16px}
.inv-table th{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--slate);padding:7px 10px;border-bottom:2px solid #f1f5f9;text-align:left;font-weight:700}
.inv-table td{padding:11px 10px;border-bottom:1px solid #f8faff;font-size:13.5px}
.inv-total{background:linear-gradient(135deg,var(--navy),var(--navy2))}

/* PRE-ALERT LIST */
.pa-card{background:#fff;border:1px solid rgba(26,86,219,.07);border-radius:var(--r-lg);padding:16px 18px;display:flex;align-items:flex-start;gap:12px;transition:var(--t)}
.pa-card:hover{box-shadow:var(--sh-sm);border-color:rgba(26,86,219,.14)}
.pa-icon{width:40px;height:40px;border-radius:11px;background:linear-gradient(135deg,rgba(26,86,219,.08),rgba(14,165,233,.08));border:1px solid rgba(26,86,219,.1);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}

/* SPINNER */
.spinner{width:17px;height:17px;border-radius:50%;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;animation:spin .75s linear infinite;flex-shrink:0}

@media(max-width:768px){
  #sidebar{display:none}
  #content{padding:18px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .field-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- SCENE -->
<div id="scene">
  <div class="sbg"></div><div class="sgrid"></div>
  <div class="sblob" style="width:480px;height:480px;background:radial-gradient(circle,rgba(26,86,219,.1),transparent);top:-100px;right:-80px"></div>
  <div class="sblob" style="width:320px;height:320px;background:radial-gradient(circle,rgba(14,165,233,.08),transparent);bottom:80px;left:-60px"></div>

  <!-- Plane -->
  <div style="position:absolute;top:5%;animation:planeFly 30s 2s linear infinite">
    <svg width="88" height="42" viewBox="0 0 220 104" fill="none" style="opacity:.7;filter:drop-shadow(0 4px 10px rgba(26,86,219,.28))">
      <defs><linearGradient id="pf" x1="0" y1=".5" x2="1" y2=".5"><stop offset="0%" stop-color="#1a56db"/><stop offset="70%" stop-color="#0ea5e9"/></linearGradient></defs>
      <path d="M18 50 Q42 42 105 47 Q158 47 195 52 Q205 52 205 56 Q205 60 195 61 Q158 66 105 61 Q42 66 18 58 Z" fill="url(#pf)"/>
      <path d="M72 48 L92 14 L150 47 Z" fill="#1e40af"/>
      <path d="M72 60 L92 94 L150 61 Z" fill="#1e40af" opacity=".8"/>
      <path d="M195 52 L212 56 L195 61 Z" fill="#e0f2fe"/>
      <circle cx="112" cy="54" r="3" fill="rgba(224,242,254,.9)"/><circle cx="130" cy="54" r="3" fill="rgba(224,242,254,.85)"/>
    </svg>
  </div>

  <!-- Ship -->
  <div style="position:absolute;bottom:7%;animation:shipSail 48s 6s linear infinite">
    <svg width="108" height="68" viewBox="0 0 240 155" fill="none" style="opacity:.5;filter:drop-shadow(0 5px 12px rgba(26,86,219,.2))">
      <defs><linearGradient id="sh" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a56db"/><stop offset="100%" stop-color="#1e3a8a"/></linearGradient></defs>
      <path d="M30 98 L210 98 L192 128 L48 128 Z" fill="url(#sh)"/>
      <path d="M30 98 L42 80 L198 80 L210 98 Z" fill="#1e40af"/>
      <rect x="72" y="50" width="96" height="32" rx="6" fill="#dbeafe"/>
      <rect x="88" y="34" width="64" height="18" rx="4" fill="#bfdbfe"/>
      <rect x="108" y="8" width="8" height="13" rx="2" fill="#1a56db"/>
      <path d="M108 8 L122 12 L108 17 Z" fill="#3b82f6"/>
    </svg>
  </div>

  <!-- Waves -->
  <div class="ocean">
    <div class="wt"><svg width="200%" height="75" viewBox="0 0 2880 75" preserveAspectRatio="none"><path d="M0,38 C180,8 360,68 540,38 C720,8 900,68 1080,38 C1260,8 1440,68 1440,38 C1620,8 1800,68 1980,38 C2160,8 2340,68 2520,38 C2700,8 2880,68 2880,38 L2880,75 L0,75 Z" fill="rgba(26,86,219,.06)"/></svg></div>
    <div class="wt wt2"><svg width="200%" height="55" viewBox="0 0 2880 55" preserveAspectRatio="none"><path d="M0,28 C240,4 480,52 720,28 C960,4 1200,52 1440,28 C1680,4 1920,52 2160,28 C2400,4 2640,52 2880,28 L2880,55 L0,55 Z" fill="rgba(14,165,233,.04)"/></svg></div>
  </div>
  <div id="bubbles"></div>
</div>

<!-- TOAST -->
<div id="toasts"></div>

<!-- SHELL -->
<div id="shell">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sb-logo"><div class="sb-logo-icon">üáØüá≤</div><div class="sb-logo-text">Island<span>Ship</span></div></div>
    <div class="sb-section">Menu</div>
    <div class="sb-link active" data-tab="overview" onclick="showTab('overview')"><span class="sb-icon">üìä</span> Dashboard</div>
    <div class="sb-link" data-tab="packages" onclick="showTab('packages')"><span class="sb-icon">üì¶</span> My Packages <span class="sb-badge hidden" id="sb-badge">0</span></div>
    <div class="sb-link" data-tab="track" onclick="showTab('track')"><span class="sb-icon">üîç</span> Track Package</div>
    <div class="sb-link" data-tab="prealert" onclick="showTab('prealert')"><span class="sb-icon">üì¨</span> Pre-Alert</div>
    <div class="sb-link" data-tab="invoices" onclick="showTab('invoices')"><span class="sb-icon">üßæ</span> Invoices</div>
    <div class="sb-section">Account</div>
    <div class="sb-link" data-tab="address" onclick="showTab('address')"><span class="sb-icon">üè†</span> My US Address</div>
    <div class="sb-link" data-tab="profile" onclick="showTab('profile')"><span class="sb-icon">üë§</span> Profile</div>
    <div class="sb-link" data-tab="rates" onclick="showTab('rates')"><span class="sb-icon">üí∞</span> Rates & Calc</div>
    <div class="sb-user">
      <div class="sb-user-card">
        <div class="sb-avatar" id="sbAv">P</div>
        <div><div class="sb-user-name" id="sbName">Paul Medley</div><div class="sb-user-id" id="sbId">BAL10349</div></div>
      </div>
      <button class="sb-signout" onclick="doSignOut()">‚Üê Sign Out</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <div id="topbar">
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <div class="topbar-right">
        <div class="topbar-pill"><div style="width:7px;height:7px;border-radius:50%;background:var(--ok);animation:pulse 2s infinite"></div>Live</div>
        <button class="btn btn-primary btn-sm" onclick="showTab('prealert')">+ Pre-Alert</button>
      </div>
    </div>

    <div id="content">

      <!-- ‚ïê‚ïê OVERVIEW ‚ïê‚ïê -->
      <div id="tab-overview">
        <div id="unpaid-alert" class="alert alert-warn hidden">‚ö†Ô∏è <strong>Unpaid invoices pending.</strong> Pay to avoid delays. <button class="btn btn-sm" style="margin-left:auto;background:var(--warn);color:#fff;border-radius:8px;padding:5px 14px" onclick="showTab('invoices')">View ‚Üí</button></div>
        <div class="stats-grid">
          <div class="stat-card" style="--c1:#1a56db;--c2:#0ea5e9;animation-delay:.00s"><div class="stat-icon">üì¶</div><div class="stat-val" id="st-total">0</div><div class="stat-lbl">Total Packages</div></div>
          <div class="stat-card" style="--c1:#f59e0b;--c2:#d97706;animation-delay:.06s"><div class="stat-icon">üè≠</div><div class="stat-val" id="st-wh">0</div><div class="stat-lbl">In Warehouse</div></div>
          <div class="stat-card" style="--c1:#0ea5e9;--c2:#38bdf8;animation-delay:.12s"><div class="stat-icon">‚úàÔ∏è</div><div class="stat-val" id="st-tr">0</div><div class="stat-lbl">In Transit</div></div>
          <div class="stat-card" style="--c1:#10b981;--c2:#34d399;animation-delay:.18s"><div class="stat-icon">üè†</div><div class="stat-val" id="st-dl">0</div><div class="stat-lbl">Delivered</div></div>
          <div class="stat-card" style="--c1:#1a56db;--c2:#6366f1;animation-delay:.24s"><div class="stat-icon">üí∞</div><div class="stat-val" id="st-spent">$0</div><div class="stat-lbl">Total Spent</div></div>
        </div>
        <div class="address-card">
          <div class="addr-tag">üè† Your US Shipping Address</div>
          <div class="addr-text" id="addrMain">Loading‚Ä¶</div>
          <div class="addr-actions">
            <button class="btn btn-white btn-sm" onclick="copyAddr()">üìã Copy Address</button>
            <button class="btn btn-dark-ghost btn-sm" onclick="showTab('address')">Full Details ‚Üí</button>
          </div>
          <div class="addr-warn">‚ö† Always use your Member ID as the Suite / Apt # at checkout.</div>
        </div>
        <div class="card card-p">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
            <h3 style="font-family:var(--fh);font-size:16px;font-weight:700">Recent Packages</h3>
            <button class="btn btn-ghost btn-sm" onclick="showTab('packages')">View All ‚Üí</button>
          </div>
          <div class="table-wrap"><table><thead><tr><th>ID</th><th>Description</th><th>Weight</th><th>Mode</th><th>Status</th><th>Cost</th><th>Actions</th></tr></thead><tbody id="recentBody"><tr><td colspan="7" style="text-align:center;color:var(--slate);padding:30px">Loading‚Ä¶</td></tr></tbody></table></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PACKAGES ‚ïê‚ïê -->
      <div id="tab-packages" class="hidden">
        <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap">
          <input id="pkgQ" type="text" placeholder="Search packages‚Ä¶" oninput="renderPkgs()" style="flex:1;min-width:180px;padding:10px 15px;border-radius:var(--r-md);border:1.5px solid #e2e8f0;background:#f8faff;font-size:14px;font-family:var(--fb);outline:none;transition:var(--t)" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'"/>
          <select id="pkgF" onchange="renderPkgs()" style="padding:10px 14px;border-radius:var(--r-md);border:1.5px solid #e2e8f0;background:#f8faff;font-size:13.5px;font-family:var(--fb);outline:none;color:var(--navy)">
            <option value="">All</option><option value="warehouse">üì¶ Warehouse</option><option value="transit">‚úàÔ∏è Transit</option><option value="customs">üõÉ Customs</option><option value="ready">‚úÖ Ready</option><option value="delivered">üè† Delivered</option>
          </select>
        </div>
        <div class="card card-p"><div class="table-wrap"><table><thead><tr><th>Package ID</th><th>Description</th><th>Store</th><th>Weight</th><th>Mode</th><th>Status</th><th>Cost</th><th>Pay</th><th>Actions</th></tr></thead><tbody id="pkgsBody"><tr><td colspan="9" style="text-align:center;padding:38px;color:var(--slate)">Loading‚Ä¶</td></tr></tbody></table></div></div>
      </div>

      <!-- ‚ïê‚ïê TRACK ‚ïê‚ïê -->
      <div id="tab-track" class="hidden">
        <div class="card card-p" style="max-width:700px">
          <h3 style="font-family:var(--fh);font-size:18px;font-weight:700;margin-bottom:6px">Track Your Package</h3>
          <p style="color:var(--slate);font-size:14px;margin-bottom:22px">Enter your Package ID or Invoice number</p>
          <div style="display:flex;gap:10px;margin-bottom:26px">
            <input id="trackInp" type="text" placeholder="e.g. PKG-2026-0001" style="flex:1;padding:12px 16px;border-radius:var(--r-md);border:1.5px solid #e2e8f0;background:#f8faff;font-size:15px;font-family:var(--fb);outline:none;transition:var(--t)" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'" onkeydown="if(event.key==='Enter')trackPkg()"/>
            <button class="btn btn-primary" onclick="trackPkg()">Track ‚Üí</button>
          </div>
          <div id="trackOut"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PRE-ALERT ‚ïê‚ïê -->
      <div id="tab-prealert" class="hidden">
        <div style="display:grid;grid-template-columns:1.1fr 1fr;gap:22px;align-items:start">
          <div class="card card-p">
            <h3 style="font-family:var(--fh);font-size:17px;font-weight:700;margin-bottom:5px">üì¨ New Pre-Alert</h3>
            <p style="color:var(--slate);font-size:13px;margin-bottom:20px">Notify us before your package arrives in Miami</p>
            <div id="pa-ok" class="alert alert-ok hidden">‚úÖ Pre-alert submitted successfully!</div>
            <div class="field"><label>Store / Merchant *</label><input id="pa-store" type="text" placeholder="Amazon, Nike, Shein‚Ä¶"/></div>
            <div class="field"><label>US Tracking Number</label><input id="pa-track" type="text" placeholder="1Z999AA10123456784"/></div>
            <div class="field"><label>Item Description *</label><input id="pa-desc" type="text" placeholder="Nike Shoes Size 10, Black"/></div>
            <div class="field-row">
              <div class="field"><label>Est. Weight (lbs)</label><input id="pa-weight" type="number" placeholder="2.5"/></div>
              <div class="field"><label>Mode</label><select id="pa-mode"><option value="air">‚úàÔ∏è Air</option><option value="sea">üö¢ Sea</option></select></div>
            </div>
            <div class="field"><label>Notes</label><textarea id="pa-notes" rows="2" placeholder="Fragile, gift, high value‚Ä¶" style="width:100%;padding:11px 15px;border-radius:var(--r-sm);border:1.5px solid #e2e8f0;background:#f8faff;color:var(--navy);font-size:14px;font-family:var(--fb);outline:none;transition:var(--t);resize:vertical" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'"></textarea></div>
            <button class="btn btn-primary btn-full btn-lg" onclick="submitPA()">Submit Pre-Alert</button>
          </div>
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="card card-p"><h4 style="font-family:var(--fh);font-size:15px;font-weight:700;margin-bottom:14px">My Pre-Alerts</h4><div id="paList"><p style="color:var(--slate);font-size:14px">No pre-alerts yet.</p></div></div>
            <div class="card card-p" style="background:rgba(26,86,219,.03);border:1px solid rgba(26,86,219,.08)">
              <h4 style="font-family:var(--fh);color:var(--blue);margin-bottom:11px;font-size:15px">üí° Why Pre-Alert?</h4>
              <ul style="list-style:none;font-size:13.5px;color:var(--slate);line-height:2.2">
                <li>‚úì Faster warehouse processing</li><li>‚úì We find your package quickly</li><li>‚úì Flag fragile / high-value items</li><li>‚úì Required for insurance claims</li><li>‚úì SMS alert on warehouse arrival</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê INVOICES ‚ïê‚ïê -->
      <div id="tab-invoices" class="hidden">
        <div class="card card-p"><h3 style="font-family:var(--fh);font-size:16px;font-weight:700;margin-bottom:16px">My Invoices</h3><div class="table-wrap"><table><thead><tr><th>Invoice #</th><th>Package</th><th>Freight</th><th>Duty (35%)</th><th>GCT (15%)</th><th>Total</th><th>Status</th><th>Action</th></tr></thead><tbody id="invBody"><tr><td colspan="8" style="text-align:center;padding:38px;color:var(--slate)">Loading‚Ä¶</td></tr></tbody></table></div></div>
      </div>

      <!-- ‚ïê‚ïê ADDRESS ‚ïê‚ïê -->
      <div id="tab-address" class="hidden">
        <div style="max-width:660px">
          <div class="address-card" style="margin-bottom:18px">
            <div class="addr-tag">üè† Your US Shipping Address</div>
            <div class="addr-text" id="addrFull">Loading‚Ä¶</div>
            <div class="addr-actions">
              <button class="btn btn-white btn-sm" onclick="copyAddr()">üìã Copy Full Address</button>
              <button class="btn btn-dark-ghost btn-sm">üì± Share via WhatsApp</button>
            </div>
          </div>
          <div class="card card-p">
            <h3 style="font-family:var(--fh);font-size:16px;margin-bottom:16px">How to Use Your Address</h3>
            <div style="display:flex;flex-direction:column;gap:13px;font-size:14px;color:var(--mid)">
              <div style="display:flex;gap:13px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;flex-shrink:0">1</div><div><strong>Full Name</strong> ‚Äî Use exactly as on your IslandShip account.</div></div>
              <div style="display:flex;gap:13px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;flex-shrink:0">2</div><div><strong>Address Line 1</strong> ‚Äî 2750 NW 87th Ave</div></div>
              <div style="display:flex;gap:13px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;flex-shrink:0">3</div><div><strong>Suite / Apt #</strong> ‚Äî Always enter your Member ID: <strong id="addrMemberId" style="color:var(--blue)">BAL10349</strong></div></div>
              <div style="display:flex;gap:13px;align-items:flex-start"><div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;flex-shrink:0">4</div><div><strong>City / State / ZIP</strong> ‚Äî Miami, FL 33172</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PROFILE ‚ïê‚ïê -->
      <div id="tab-profile" class="hidden">
        <div style="max-width:560px">
          <div class="card card-p">
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #f1f5f9">
              <div id="profAv" style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#fff;box-shadow:0 6px 18px rgba(26,86,219,.28)">P</div>
              <div>
                <div style="font-family:var(--fh);font-size:19px;font-weight:700" id="profName">Paul Medley</div>
                <div style="color:var(--slate);font-size:13px;margin-top:2px" id="profEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4434253128042129252d286a272b29">[email&#160;protected]</a></div>
                <span class="badge" style="background:rgba(26,86,219,.1);color:var(--blue);border:1px solid rgba(26,86,219,.18);margin-top:6px">‚≠ê Member</span>
              </div>
            </div>
            <div class="field"><label>Full Name</label><input id="pf-name" type="text"/></div>
            <div class="field"><label>Email</label><input id="pf-email" type="email" readonly style="opacity:.55;cursor:not-allowed"/></div>
            <div class="field"><label>Phone</label><input id="pf-phone" type="tel" placeholder="876-xxx-xxxx"/></div>
            <div class="field"><label>Nearest Branch</label>
              <select id="pf-branch"><option>Kingston</option><option>Cross Roads</option><option>Portmore</option><option>Montego Bay</option><option>Spanish Town</option><option>Mandeville</option><option>Ocho Rios</option><option>May Pen</option></select>
            </div>
            <button class="btn btn-primary btn-full" onclick="saveProfile()">üíæ Save Changes</button>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê RATES ‚ïê‚ïê -->
      <div id="tab-rates" class="hidden">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(268px,1fr));gap:18px">
          <div class="card" style="padding:30px;text-align:center;border-top:3px solid var(--blue)">
            <svg width="100" height="48" viewBox="0 0 220 104" fill="none" style="margin:0 auto 14px;animation:bobFloat 3.5s ease-in-out infinite">
              <defs><linearGradient id="pfr" x1="0" y1=".5" x2="1" y2=".5"><stop offset="0%" stop-color="#1a56db"/><stop offset="70%" stop-color="#0ea5e9"/></linearGradient></defs>
              <path d="M18 50 Q42 42 105 47 Q158 47 195 52 Q205 52 205 56 Q205 60 195 61 Q158 66 105 61 Q42 66 18 58 Z" fill="url(#pfr)"/>
              <path d="M72 48 L92 14 L150 47 Z" fill="#1e40af"/>
              <path d="M72 60 L92 94 L150 61 Z" fill="#1e40af" opacity=".8"/>
              <path d="M195 52 L212 56 L195 61 Z" fill="#e0f2fe"/>
            </svg>
            <div style="background:linear-gradient(135deg,var(--blue),var(--sky));color:#fff;border-radius:20px;padding:3px 14px;font-size:10px;font-weight:700;display:inline-block;margin-bottom:10px;letter-spacing:1px">FASTEST</div>
            <div style="font-family:var(--fh);font-size:18px;font-weight:700;margin-bottom:3px">‚úàÔ∏è Air Freight</div>
            <div style="font-family:var(--fh);font-size:46px;font-weight:800;color:var(--blue);line-height:1">US$7<span style="font-size:17px;color:var(--slate)">/lb</span></div>
            <div style="background:rgba(26,86,219,.07);border-radius:20px;padding:5px 14px;display:inline-block;color:var(--blue);font-size:12px;font-weight:600;margin-top:10px">‚è± 5‚Äì7 Business Days</div>
          </div>
          <div class="card" style="padding:30px;text-align:center;border-top:3px solid var(--sky)">
            <svg width="120" height="76" viewBox="0 0 240 155" fill="none" style="margin:0 auto 14px;animation:bobFloat 5s ease-in-out infinite">
              <defs><linearGradient id="shr" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a56db"/><stop offset="100%" stop-color="#1e3a8a"/></linearGradient></defs>
              <path d="M30 98 L210 98 L192 128 L48 128 Z" fill="url(#shr)"/>
              <path d="M30 98 L42 80 L198 80 L210 98 Z" fill="#1e40af"/>
              <rect x="72" y="50" width="96" height="32" rx="6" fill="#dbeafe"/>
              <rect x="88" y="34" width="64" height="18" rx="4" fill="#bfdbfe"/>
              <rect x="108" y="8" width="8" height="13" rx="2" fill="#1a56db"/>
              <path d="M108 8 L122 12 L108 17 Z" fill="#3b82f6"/>
            </svg>
            <div style="background:linear-gradient(135deg,var(--sky),#38bdf8);color:#fff;border-radius:20px;padding:3px 14px;font-size:10px;font-weight:700;display:inline-block;margin-bottom:10px;letter-spacing:1px">CHEAPEST</div>
            <div style="font-family:var(--fh);font-size:18px;font-weight:700;margin-bottom:3px">üö¢ Sea Freight</div>
            <div style="font-family:var(--fh);font-size:46px;font-weight:800;color:var(--sky);line-height:1">US$35<span style="font-size:17px;color:var(--slate)">/cu ft</span></div>
            <div style="background:rgba(14,165,233,.08);border-radius:20px;padding:5px 14px;display:inline-block;color:var(--sky);font-size:12px;font-weight:600;margin-top:10px">‚è± 4‚Äì6 Weeks</div>
          </div>
          <div class="card" style="padding:30px">
            <h3 style="font-family:var(--fh);font-size:17px;font-weight:700;margin-bottom:5px">üí∞ Estimate Calculator</h3>
            <p style="color:var(--slate);font-size:12px;margin-bottom:18px">Includes duty (35%) + GCT (15%)</p>
            <div class="field"><label>Weight in lbs (Air)</label><input id="cr-w" type="number" placeholder="e.g. 5.5" oninput="calcR()"/></div>
            <div class="field"><label>Volume in cu ft (Sea)</label><input id="cr-v" type="number" placeholder="e.g. 2.0" oninput="calcR()"/></div>
            <div id="rateOut" style="margin-top:6px;font-size:14px;color:var(--slate)">Enter a value to estimate.</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- INVOICE MODAL -->
<div class="overlay" id="inv-modal"><div class="modal" style="max-width:620px">
  <div class="modal-hd"><button class="modal-x" onclick="closeM('inv')">√ó</button><h3>Invoice</h3><p id="inv-sub">Details</p></div>
  <div class="modal-bd" id="inv-body"></div>
</div></div>

<!-- PAYMENT MODAL -->
<div class="overlay" id="pay-modal"><div class="modal" style="max-width:480px">
  <div class="modal-hd"><button class="modal-x" onclick="closeM('pay')">√ó</button><h3>Complete Payment</h3><p id="pay-sub">Invoice</p></div>
  <div class="modal-bd" id="pay-body"></div>
</div></div>

<!-- TRACK MODAL -->
<div class="overlay" id="track-modal"><div class="modal" style="max-width:540px">
  <div class="modal-hd"><button class="modal-x" onclick="closeM('track')">√ó</button><h3>Package Tracking</h3><p id="track-sub">Real-time status</p></div>
  <div class="modal-bd" id="track-body"></div>
</div></div>

<script>
/* ‚ïê‚ïê SUPABASE CONFIG ‚ïê‚ïê */
const SB_URL = 'https://ooibkptrshpdinjhgjfs.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vaWJrcHRyc2hwZGluamhnamZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NzAzMDgsImV4cCI6MjA4NzA0NjMwOH0.ZBzMeqREi1tQ40ZZ4_p9nJKDkzPNK_bP1g7IsRvcE6c';
let sb=null, CU=null, _initDone=false;

if(SB_URL!=='https://YOUR_PROJECT.supabase.co'){
  sb=window.supabase.createClient(SB_URL,SB_KEY);
  sb.auth.onAuthStateChange(async(ev,ses)=>{
    CU=ses?.user??null;
    if(ev==='SIGNED_IN'&&CU&&!_initDone){_initDone=true;await init();}
    if(ev==='SIGNED_OUT'){window.location.href='index.html';}
  });
  sb.auth.getUser().then(async({data})=>{
    CU=data?.user??null;
    if(CU&&!_initDone){
      _initDone=true;
      const{data:chk}=await sb.from('profiles').select('kyc_complete').eq('id',CU.id).single();
      if(!chk||!chk.kyc_complete){window.location.href='index.html';return;}
      init();
    }else if(!CU){initDemo();}
  });
}else{initDemo();}

/* ‚ïê‚ïê DEMO DATA shown only when not logged in ‚ïê‚ïê */
const D={
  memberId:'‚Äî',
  profile:{full_name:'Not logged in',email:'',phone:'',branch:''},
  packages:[],
  prealerts:[]
};

/* ‚ïê‚ïê STATUS MAP ‚Äî matches TEXT values stored in DB ‚ïê‚ïê */
const ST={
  warehouse:{l:'In Warehouse',i:'üì¶',c:'var(--gold)',  b:'rgba(245,158,11,.1)', s:1},
  transit:  {l:'In Transit',  i:'‚úàÔ∏è',c:'var(--sky)',   b:'rgba(14,165,233,.1)', s:2},
  customs:  {l:'At Customs',  i:'üõÉ',c:'var(--warn)',  b:'rgba(249,115,22,.1)', s:3},
  ready:    {l:'Ready',       i:'‚úÖ',c:'var(--ok)',    b:'rgba(16,185,129,.1)', s:4},
  delivered:{l:'Delivered',   i:'üè†',c:'var(--slate)', b:'rgba(100,116,139,.1)',s:5},
};
const TS=[{l:'US Warehouse',i:'üì¶'},{l:'In Transit',i:'‚úàÔ∏è'},{l:'At Customs',i:'üõÉ'},{l:'Ready Pickup',i:'‚úÖ'},{l:'Delivered',i:'üè†'}];

function initDemo(){
  CU={id:'demo',email:'demo@islandship.jm',user_metadata:{full_name:'Demo User',first_name:'Demo',branch:'Kingston'}};
  init();
}

async function init(){
  if(sb&&CU&&CU.id!=='demo'){
    /* Profile */
    const{data:prof}=await sb.from('profiles').select('*').eq('id',CU.id).single();
    if(prof){D.memberId=prof.member_id||'BAL?????';D.profile=prof;}

    /* Packages ‚Äî schema cols: pkg_id, description, weight, mode, status(text),
       arrived(date), eta(date), invoice_amt, paid, notes (no store/cost_usd/arrived_at/invoice_id) */
    const{data:pkgs}=await sb.from('packages').select('*').eq('user_id',CU.id).order('created_at',{ascending:false});
    if(pkgs&&pkgs.length){
      D.packages=pkgs.map(p=>({
        id:      p.pkg_id||p.id,
        dbId:    p.id,
        desc:    p.description||'',
        store:   p.notes||'‚Äî',
        weight:  p.weight||0,
        mode:    p.mode||'air',
        status:  p.status||'warehouse',
        arrived: p.arrived||'',
        eta:     p.eta?String(p.eta):'',
        cost:    p.invoice_amt||0,
        paid:    p.paid||false,
        invoice: p.pkg_id?'INV-'+p.pkg_id.replace('PKG-',''):p.id.slice(0,8).toUpperCase()
      }));
    }

    /* Pre-alerts ‚Äî table name is 'prealerts' (no underscore); cols: tracking_no, description, weight_est */
    const{data:pa}=await sb.from('prealerts').select('*').eq('user_id',CU.id).order('created_at',{ascending:false});
    if(pa&&pa.length){
      D.prealerts=pa.map(a=>({
        id:      a.id,
        store:   a.store||'',
        tracking:a.tracking_no||'',
        desc:    a.description||'',
        weight:  a.weight_est||'',
        mode:    a.mode||'air',
        status:  a.status||'pending',
        created: (a.created_at||'').split('T')[0]
      }));
    }
  }
  buildBubbles();updateSidebar();renderAll();
}
function updateSidebar(){
  const n=D.profile?.full_name||CU?.user_metadata?.full_name||'User';
  document.getElementById('sbAv').textContent=n[0].toUpperCase();
  document.getElementById('sbName').textContent=n;
  document.getElementById('sbId').textContent=D.memberId;
  document.getElementById('profAv').textContent=n[0].toUpperCase();
  document.getElementById('profName').textContent=n;
  document.getElementById('profEmail').textContent=D.profile?.email||CU?.email||'';
  document.getElementById('pf-name').value=n;
  document.getElementById('pf-email').value=D.profile?.email||CU?.email||'';
  document.getElementById('pf-phone').value=D.profile?.phone||'';
  const brSel=document.getElementById('pf-branch');if(brSel)brSel.value=D.profile?.branch||'';
  document.getElementById('addrMemberId').textContent=D.memberId;
  const up=D.packages.filter(p=>!p.paid).length;
  const b=document.getElementById('sb-badge');b.textContent=up;b.classList.toggle('hidden',!up);
  document.getElementById('unpaid-alert').classList.toggle('hidden',!up);
}

function renderAll(){renderStats();renderAddr();renderRecent();renderPkgs();renderInvoices();renderPAs();}

/* STATS */
function renderStats(){
  const pk=D.packages;
  document.getElementById('st-total').textContent=pk.length;
  document.getElementById('st-wh').textContent=pk.filter(p=>p.status==='warehouse').length;
  document.getElementById('st-tr').textContent=pk.filter(p=>p.status==='transit').length;
  document.getElementById('st-dl').textContent=pk.filter(p=>p.status==='delivered').length;
  document.getElementById('st-spent').textContent='$'+pk.filter(p=>p.paid).reduce((s,p)=>s+(p.cost||0),0).toFixed(0);
}

/* ADDRESS */
function renderAddr(){
  const n=D.profile?.full_name||CU?.user_metadata?.full_name||'Your Name';
  const html=`<span style="color:rgba(255,255,255,.48);font-size:12px">Name: </span>${n}<br><span style="color:rgba(255,255,255,.48);font-size:12px">Address: </span>2750 NW 87th Ave, Suite <strong style="color:var(--sky)">${D.memberId}</strong>, Miami, FL 33172, USA`;
  document.getElementById('addrMain').innerHTML=html;
  document.getElementById('addrFull').innerHTML=html;
  window._addr=`${n}\n2750 NW 87th Ave, Suite ${D.memberId}\nMiami, FL 33172, USA`;
}
function copyAddr(){navigator.clipboard?.writeText(window._addr||'').then(()=>toast('ok','üìã Address copied!'));}

/* TABS */
const TITLES={overview:'Dashboard',packages:'My Packages',track:'Track Package',prealert:'Pre-Alert',invoices:'Invoices',address:'My US Address',profile:'Profile',rates:'Rates & Calculator'};
function showTab(t){
  document.querySelectorAll('[id^="tab-"]').forEach(el=>el.classList.add('hidden'));
  document.querySelectorAll('.sb-link').forEach(el=>{el.classList.toggle('active',el.dataset.tab===t)});
  document.getElementById('tab-'+t)?.classList.remove('hidden');
  document.getElementById('topbarTitle').textContent=TITLES[t]||t;
}

/* PACKAGE TABLES */
function renderRecent(){
  const el=document.getElementById('recentBody');
  if(!D.packages.length){el.innerHTML='<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--slate)">No packages yet.</td></tr>';return;}
  el.innerHTML=D.packages.slice(0,4).map(p=>pkgRow(p,false)).join('');
}
function renderPkgs(){
  const q=(document.getElementById('pkgQ')?.value||'').toLowerCase();
  const f=document.getElementById('pkgF')?.value||'';
  const list=D.packages.filter(p=>(!q||(p.id+p.desc+p.store).toLowerCase().includes(q))&&(!f||p.status===f));
  const el=document.getElementById('pkgsBody');
  el.innerHTML=list.length?list.map(p=>pkgRow(p,true)).join(''):'<tr><td colspan="9" style="text-align:center;padding:38px;color:var(--slate)">No packages found.</td></tr>';
}
function pkgRow(p,full){
  const s=ST[p.status]||ST.warehouse;
  const badge=`<span class="badge" style="color:${s.c};background:${s.b};border:1px solid ${s.c}33">${s.i} ${s.l}</span>`;
  const pay=p.paid?`<span style="color:var(--ok);font-size:12px;font-weight:700">‚úì Paid</span>`:`<button class="btn btn-sm btn-primary" onclick="openPay('${p.id}')">Pay</button>`;
  const extra=full?`<td style="font-size:12px;color:var(--slate)">${p.store||'‚Äî'}</td>`:'';
  return`<tr>
    <td><span style="color:var(--blue);font-weight:700;font-size:12px">${p.id}</span></td>
    <td style="max-width:150px;color:var(--mid)">${p.desc}</td>
    ${extra}
    <td style="color:var(--slate);white-space:nowrap">${p.weight}lbs</td>
    <td>${p.mode==='air'?'‚úàÔ∏è Air':'üö¢ Sea'}</td>
    <td>${badge}</td>
    <td style="font-weight:700;color:${p.paid?'var(--ok)':'var(--err)'}">US$${(p.cost||0).toFixed(2)}</td>
    ${full?`<td>${pay}</td>`:''}
    <td><div style="display:flex;gap:6px"><button class="btn btn-sm btn-ghost" onclick="openTrack('${p.id}')">üîç Track</button><button class="btn btn-sm btn-outline" onclick="openInv('${p.id}')">üìÑ Inv</button></div></td>
  </tr>`;
}

/* INVOICES */
function renderInvoices(){
  const el=document.getElementById('invBody');
  if(!D.packages.length){el.innerHTML='<tr><td colspan="8" style="text-align:center;padding:38px;color:var(--slate)">No invoices yet.</td></tr>';return;}
  el.innerHTML=D.packages.map(p=>{
    const fr=p.cost||0,du=fr*.35,gc=(fr+du)*.15,tot=fr+du+gc;
    const sb2=p.paid?`<span class="badge" style="color:var(--ok);background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2)">‚úì PAID</span>`:`<span class="badge" style="color:var(--err);background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.18)">‚ö† DUE</span>`;
    const act=p.paid?`<button class="btn btn-sm btn-ghost" onclick="openInv('${p.id}')">View</button>`:`<button class="btn btn-sm btn-primary" onclick="openPay('${p.id}')">Pay</button>`;
    return`<tr><td style="color:var(--blue);font-weight:700;font-size:12px">${p.invoice}</td><td style="color:var(--mid);max-width:130px">${p.desc}</td><td>$${fr.toFixed(2)}</td><td>$${du.toFixed(2)}</td><td>$${gc.toFixed(2)}</td><td style="font-weight:700;color:var(--navy)">US$${tot.toFixed(2)}</td><td>${sb2}</td><td>${act}</td></tr>`;
  }).join('');
}

/* INVOICE MODAL */
function openInv(id){
  const p=D.packages.find(x=>x.id===id);if(!p)return;
  const fr=p.cost||0,du=fr*.35,gc=(fr+du)*.15,tot=fr+du+gc;
  const n=D.profile?.full_name||CU?.user_metadata?.full_name||'Customer';
  document.getElementById('inv-sub').textContent=p.invoice;
  document.getElementById('inv-body').innerHTML=`
    <div style="border:1px solid #e2e8f0;border-radius:var(--r-lg);overflow:hidden">
      <div class="inv-hd">
        <div style="display:flex;align-items:center;gap:9px"><div class="inv-logo-icon">üáØüá≤</div><div style="font-family:var(--fh);font-size:18px;font-weight:800;color:#fff">IslandShip</div></div>
        <div style="text-align:right">
          <div style="font-family:var(--fh);font-size:22px;font-weight:800;color:#fff">${p.invoice}</div>
          <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:2px">${p.arrived||''}</div>
          <div style="margin-top:7px">${p.paid?`<span class="badge" style="background:rgba(16,185,129,.2);color:#6ee7b7;border:1px solid rgba(16,185,129,.3)">‚úì PAID</span>`:`<span class="badge" style="background:rgba(239,68,68,.2);color:#fca5a5;border:1px solid rgba(239,68,68,.3)">‚ö† DUE</span>`}</div>
        </div>
      </div>
      <div style="padding:24px 28px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;font-size:13.5px">
          <div><div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--slate);margin-bottom:5px">Bill To</div><div style="font-weight:700">${n}</div><div style="color:var(--slate);margin-top:2px">${CU?.email||''}<br>ID: ${D.memberId}</div></div>
          <div><div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--slate);margin-bottom:5px">Shipment</div><div style="color:var(--mid)">${p.mode==='air'?'‚úàÔ∏è Air':'üö¢ Sea'}<br>${p.weight}lbs ¬∑ ${p.store||'‚Äî'}</div></div>
        </div>
        <table class="inv-table">
          <thead><tr><th>Description</th><th>Weight</th><th>Rate</th><th style="text-align:right">Amount</th></tr></thead>
          <tbody>
            <tr><td>${p.desc}</td><td>${p.weight}lbs</td><td>$${p.mode==='air'?'7/lb':'35/cuft'}</td><td style="text-align:right;font-weight:600">US$${fr.toFixed(2)}</td></tr>
            <tr><td colspan="3" style="color:var(--slate)">Import Duty (35%)</td><td style="text-align:right">US$${du.toFixed(2)}</td></tr>
            <tr><td colspan="3" style="color:var(--slate)">GCT (15%)</td><td style="text-align:right">US$${gc.toFixed(2)}</td></tr>
          </tbody>
          <tfoot><tr class="inv-total"><td colspan="3" style="padding:13px 10px;font-weight:700;font-size:15px;color:#fff">TOTAL DUE</td><td style="text-align:right;font-weight:800;font-size:19px;color:#fff;padding:13px 10px">US$${tot.toFixed(2)}</td></tr></tfoot>
        </table>
        <div style="display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap;margin-top:6px">
          <button class="btn btn-outline btn-sm" onclick="window.print()">üñ®Ô∏è Print</button>
          ${!p.paid?`<button class="btn btn-primary btn-sm" onclick="closeM('inv');openPay('${p.id}')">üí≥ Pay US$${tot.toFixed(2)}</button>`:''}
          <button class="btn btn-ghost btn-sm" onclick="closeM('inv')">Close</button>
        </div>
      </div>
    </div>`;
  openM('inv');
}

/* PAYMENT MODAL */
let _pp=null;
function openPay(id){
  _pp=D.packages.find(x=>x.id===id);if(!_pp)return;
  const fr=_pp.cost||0,du=fr*.35,gc=(fr+du)*.15,tot=(fr+du+gc).toFixed(2);
  document.getElementById('pay-sub').textContent=`${_pp.invoice} ¬∑ US$${tot}`;
  document.getElementById('pay-body').innerHTML=`
    <div style="background:rgba(26,86,219,.05);border:1px solid rgba(26,86,219,.12);border-radius:var(--r-md);padding:18px;margin-bottom:22px;text-align:center">
      <div style="color:var(--slate);font-size:13px;margin-bottom:3px">Total Due</div>
      <div style="font-family:var(--fh);font-size:40px;font-weight:800;background:linear-gradient(135deg,var(--blue),var(--sky));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">US$${tot}</div>
      <div style="font-size:12px;color:var(--slate);margin-top:3px">${_pp.invoice} ¬∑ ${_pp.desc}</div>
    </div>
    <div style="font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--slate);margin-bottom:11px">Select Payment Method</div>
    <div class="pay-grid">
      <div class="pay-opt" onclick="selPay(this,'paypal')"><div class="pay-opt-icon">üÖøÔ∏è</div><div class="pay-opt-name">PayPal</div></div>
      <div class="pay-opt" onclick="selPay(this,'card')"><div class="pay-opt-icon">üí≥</div><div class="pay-opt-name">Card</div></div>
      <div class="pay-opt" onclick="selPay(this,'bank')"><div class="pay-opt-icon">üè¶</div><div class="pay-opt-name">Bank Transfer</div></div>
      <div class="pay-opt" onclick="selPay(this,'lynk')"><div class="pay-opt-icon">üì±</div><div class="pay-opt-name">Lynk</div></div>
    </div>
    <div id="payForm"></div>
    <button id="payBtn" class="btn btn-primary btn-full btn-lg" style="margin-top:14px;opacity:.38;pointer-events:none" onclick="doPay('${tot}')">üîí Pay Securely</button>`;
  openM('pay');
}
function selPay(el,m){
  document.querySelectorAll('.pay-opt').forEach(o=>o.classList.remove('selected'));el.classList.add('selected');
  window._pm=m;
  const btn=document.getElementById('payBtn');btn.style.opacity='1';btn.style.pointerEvents='auto';
  const area=document.getElementById('payForm');
  if(m==='card'){area.innerHTML=`<div style="margin-top:14px;animation:fadeUp .3s ease"><div class="field"><label>Card Number</label><input type="text" placeholder="1234 5678 9012 3456"/></div><div class="field-row"><div class="field"><label>Expiry</label><input type="text" placeholder="MM/YY"/></div><div class="field"><label>CVV</label><input type="text" placeholder="123"/></div></div><div class="field"><label>Cardholder Name</label><input type="text" placeholder="${D.profile?.full_name||'Your Name'}"/></div></div>`;}
  else area.innerHTML='';
}
async function doPay(tot){
  const btn=document.getElementById('payBtn');
  btn.innerHTML='<div class="spinner"></div> Processing‚Ä¶';btn.style.pointerEvents='none';
  if(sb&&CU&&_pp){
    await sb.from('transactions').insert({user_id:CU.id,pkg_id:_pp.dbId||_pp.id,amount:parseFloat(tot),method:window._pm||'unknown',status:'paid'});
    await sb.from('packages').update({paid:true}).eq('id',_pp.dbId||_pp.id);
  }
  const pk=D.packages.find(x=>x.id===_pp?.id);if(pk)pk.paid=true;
  await new Promise(r=>setTimeout(r,2200));
  document.getElementById('pay-body').innerHTML=`<div style="text-align:center;padding:38px 20px"><div style="font-size:60px;margin-bottom:14px">‚úÖ</div><h3 style="font-family:var(--fh);font-size:21px;color:var(--ok);margin-bottom:7px">Payment Successful!</h3><p style="color:var(--slate)">${_pp?.invoice} is now paid.</p><p style="color:var(--slate);font-size:13px;margin-top:5px">Receipt sent to your email.</p><button class="btn btn-primary" style="margin-top:22px" onclick="closeM('pay');renderAll();updateSidebar()">Done ‚Üí</button></div>`;
}

/* TRACK MODAL */
function openTrack(id){
  const p=D.packages.find(x=>x.id===id);if(!p)return;
  const s=ST[p.status]||ST.warehouse;const step=s.s;const pct=Math.round(step/5*100);
  document.getElementById('track-sub').textContent=`${p.id} ¬∑ ${p.desc}`;
  let sh='';
  TS.forEach((ts,i)=>{
    const done=i<step,cur=i===step-1;
    const dc=done?'done':cur?'cur':'pend';
    const ln=i<4?`<div style="position:absolute;left:19px;top:38px;width:2px;bottom:0;background:linear-gradient(${done?'var(--blue)':'rgba(26,86,219,.1)'},rgba(26,86,219,.05))"></div>`:'';
    sh+=`<div class="ts-row"><div class="ts-dot ${dc}">${done?'‚úì':ts.i}</div><div><div class="ts-label ${dc==='pend'?'pend':''}">${ts.l}</div><div class="ts-date">${done?'Completed':cur?'‚è≥ In Progress':'Pending'}</div></div>${ln}</div>`;
  });
  document.getElementById('track-body').innerHTML=`
    <div style="background:var(--mist);border-radius:var(--r-md);padding:14px 16px;margin-bottom:20px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div><div style="font-weight:700">${p.id}</div><div style="color:var(--slate);font-size:13px;margin-top:2px">${p.weight}lbs ¬∑ ${p.mode==='air'?'‚úàÔ∏è Air':'üö¢ Sea'} ¬∑ ${p.store||''}</div></div>
      <span class="badge" style="color:${s.c};background:${s.b};border:1px solid ${s.c}33;align-self:center">${s.i} ${s.l}</span>
    </div>
    <div class="track-bar"><div class="track-bar-fill" style="width:${pct}%"></div></div>
    <div>${sh}</div>
    ${p.eta?`<div style="text-align:center;margin-top:18px;padding:11px;background:rgba(26,86,219,.05);border-radius:var(--r-md);font-size:14px;color:var(--blue);font-weight:600">üìÖ ETA: ${p.eta}</div>`:''}`;
  openM('track');
}

/* INLINE TRACK */
function trackPkg(){
  const q=document.getElementById('trackInp').value.trim().toUpperCase();
  const p=D.packages.find(x=>x.id===q||x.invoice===q);
  if(!p){document.getElementById('trackOut').innerHTML=`<div style="text-align:center;padding:30px;color:var(--slate)"><div style="font-size:44px;margin-bottom:12px">üîç</div><h4 style="font-family:var(--fh);margin-bottom:6px;color:var(--navy)">Not Found</h4><p style="font-size:14px">Example IDs: ${D.packages.slice(0,2).map(x=>x.id).join(' ¬∑ ')}</p></div>`;return;}
  openTrack(p.id);
}

/* PRE-ALERTS */
async function submitPA(){
  const store=document.getElementById('pa-store').value.trim();
  const desc=document.getElementById('pa-desc').value.trim();
  if(!store||!desc){toast('err','Store and description are required.');return;}
  const pa={store,tracking_no:document.getElementById('pa-track').value,description:desc,weight_est:parseFloat(document.getElementById('pa-weight').value)||null,mode:document.getElementById('pa-mode').value,status:'pending'};
  if(sb&&CU)await sb.from('prealerts').insert({user_id:CU.id,...pa});
  D.prealerts.unshift({id:'PA-'+Date.now(),store,tracking:pa.tracking_no,desc,weight:pa.weight_est||'',mode:pa.mode,status:'pending',created:new Date().toISOString().split('T')[0]});
  ['pa-store','pa-track','pa-desc','pa-weight','pa-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('pa-ok').classList.remove('hidden');
  setTimeout(()=>document.getElementById('pa-ok').classList.add('hidden'),4000);
  renderPAs();toast('ok','üì¨ Pre-alert submitted!');
}
function renderPAs(){
  const el=document.getElementById('paList');
  if(!D.prealerts.length){el.innerHTML='<p style="color:var(--slate);font-size:14px">No pre-alerts yet.</p>';return;}
  el.innerHTML=D.prealerts.map(a=>`
    <div class="pa-card" style="margin-bottom:9px">
      <div class="pa-icon">${a.mode==='air'?'‚úàÔ∏è':'üö¢'}</div>
      <div style="flex:1"><div style="font-weight:600;font-size:13.5px">${a.desc}</div><div style="color:var(--slate);font-size:12px;margin-top:2px">${a.store} ¬∑ ${a.created}</div></div>
      <span class="badge" style="color:${a.status==='pending'?'var(--gold)':'var(--ok)'};background:${a.status==='pending'?'rgba(245,158,11,.1)':'rgba(16,185,129,.1)'};border:1px solid ${a.status==='pending'?'rgba(245,158,11,.2)':'rgba(16,185,129,.2)'}">${a.status==='pending'?'‚è≥ Pending':'‚úÖ Received'}</span>
    </div>`).join('');
}

/* RATES */
function calcR(){
  const w=parseFloat(document.getElementById('cr-w')?.value)||0;
  const v=parseFloat(document.getElementById('cr-v')?.value)||0;
  let h='';
  if(w>0){const b=w*7,d=b*.35,g=(b+d)*.15;h+=`<div style="margin-bottom:10px;padding:12px;background:rgba(26,86,219,.05);border-radius:var(--r-sm)"><div style="font-size:10px;color:var(--slate);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">‚úàÔ∏è Air (${w}lbs)</div><div style="font-family:var(--fh);font-size:26px;font-weight:800;color:var(--blue)">US$${(b+d+g).toFixed(2)}</div><div style="font-size:11px;color:var(--slate)">Freight $${b.toFixed(2)} + Duty $${d.toFixed(2)} + GCT $${g.toFixed(2)}</div></div>`;}
  if(v>0){const b=v*35,d=b*.35,g=(b+d)*.15;h+=`<div style="padding:12px;background:rgba(14,165,233,.05);border-radius:var(--r-sm)"><div style="font-size:10px;color:var(--slate);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">üö¢ Sea (${v}cuft)</div><div style="font-family:var(--fh);font-size:26px;font-weight:800;color:var(--sky)">US$${(b+d+g).toFixed(2)}</div><div style="font-size:11px;color:var(--slate)">Freight $${b.toFixed(2)} + Duty $${d.toFixed(2)} + GCT $${g.toFixed(2)}</div></div>`;}
  document.getElementById('rateOut').innerHTML=h||'<span style="color:var(--slate)">Enter a value to estimate.</span>';
}

/* PROFILE SAVE */
async function saveProfile(){
  const n=document.getElementById('pf-name').value.trim();
  const ph=document.getElementById('pf-phone').value.trim();
  const br=document.getElementById('pf-branch').value;
  if(!n){toast('err','Name cannot be empty.');return;}
  const parts=n.trim().split(' ');
  const fn=parts[0], ln=parts.slice(1).join(' ')||'';
  if(sb&&CU){
    await sb.auth.updateUser({data:{full_name:n,first_name:fn,last_name:ln}});
    const{error}=await sb.from('profiles').upsert({id:CU.id,full_name:n,first_name:fn,last_name:ln,phone:ph,branch:br});
    if(error){toast('err',error.message);return;}
  }
  D.profile={...D.profile,full_name:n,first_name:fn,last_name:ln,phone:ph,branch:br};
  updateSidebar();
  toast('ok','‚úÖ Profile saved!');
}

/* SIGN OUT */
async function doSignOut(){if(sb)await sb.auth.signOut();toast('info','üëã Signed out.');setTimeout(()=>{window.location.href='index.html';},900);}

/* MODALS */
function openM(n){document.getElementById(n+'-modal').classList.add('open');document.body.style.overflow='hidden';}
function closeM(n){document.getElementById(n+'-modal').classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o){o.classList.remove('open');document.body.style.overflow='';}}));

/* TOAST */
function toast(t,m){const c=document.getElementById('toasts');const el=document.createElement('div');el.className=`toast ${t}`;el.innerHTML=`<span>${{ok:'‚úÖ',err:'‚ùå',info:'‚ÑπÔ∏è'}[t]||'‚ÑπÔ∏è'}</span><span>${m}</span>`;c.appendChild(el);setTimeout(()=>{el.style.animation='toastIn .3s reverse both';setTimeout(()=>el.remove(),350);},4200);}

/* BUBBLES */
function buildBubbles(){const w=document.getElementById('bubbles');for(let i=0;i<16;i++){const b=document.createElement('div');b.style.cssText=`position:absolute;bottom:0;left:${Math.random()*100}%;width:${3+Math.random()*6}px;height:${3+Math.ran
